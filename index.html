<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaliQ - SMK N 1 Brondong</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2563eb; /* Modern Blue */
            --primary-dark: #1e40af;
            --secondary-color: #64748b;
            --accent-color: #06b6d4;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --admin-color: #ef4444; 
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --sidebar-width: 280px;
        }
		
		/* --- UPDATE: Warna Visualisasi Mood Guru --- */
        .status-danger { 
            background-color: #fee2e2 !important; /* Merah Muda Lembut */
            border: 1px solid #fecaca !important;
        } 
        .status-success { 
            background-color: #d1fae5 !important; /* Hijau Muda Lembut */
            border: 1px solid #a7f3d0 !important;
        }
        .status-warning {
            background-color: #fef3c7 !important; /* Kuning Muda Lembut */
            border: 1px solid #fde68a !important;
        }

        /* Badge Notifikasi Sidebar */
        .badge-notif {
            background: #ef4444;
            color: white;
            border-radius: 50px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: auto;
        }
		
		/* ANIMASI PET */
@keyframes bounceSlow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
.animate-bounce-slow {
    animation: bounceSlow 3s infinite ease-in-out;
}
.pet-eating {
    transform: scale(1.1) rotate(5deg) !important;
}

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* --- Sidebar (Desktop & Mobile Drawer) --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: white;
            z-index: 1050; /* Higher than navbar */
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            border-right: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand-logo {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary-color);
            letter-spacing: -0.5px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .nav-item-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--secondary-color);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-item-link i {
            width: 24px;
            font-size: 1.2rem;
            margin-right: 12px;
            text-align: center;
        }

        .nav-item-link:hover {
            background-color: #f8fafc;
            color: var(--primary-color);
            transform: translateX(4px);
        }

        .nav-item-link.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-profile-sidebar {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-profile-sidebar:hover {
            background-color: #f8fafc;
            border-radius: 8px;
        }

        /* --- Mobile Overlay (Sidebar Only) --- */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(2px);
        }
        
        .mobile-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* --- Custom Modal Overlay --- */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
            display: flex; /* Selalu flex agar content di tengah */
            align-items: center;
            justify-content: center;
        }
        
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* --- Main Content Layout --- */
        .main-content {
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            padding-bottom: 90px;
        }
        
        /* New Class to remove margin when sidebar is hidden (Login page) */
        .main-content.no-sidebar {
            margin-left: 0 !important;
            padding: 20px !important;
        }

        /* --- Mobile Navbar (Top) --- */
        .mobile-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 900;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        /* --- Responsive Queries --- */
        @media (min-width: 992px) {
            .main-content {
                margin-left: var(--sidebar-width);
                padding: 40px;
                padding-bottom: 40px;
            }
            .mobile-navbar, .bottom-nav, .mobile-overlay {
                display: none !important;
            }
            .sidebar {
                transform: translateX(0);
            }
            .sidebar-close-btn { display: none; }
        }

        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
                padding-top: 10px;
            }
        }

        /* --- Components --- */
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            background: var(--card-bg);
            margin-bottom: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        .avatar-frame {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2);
            background: white;
        }

        .hero-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border-radius: 24px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .hero-pattern {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 10rem;
            opacity: 0.1;
            transform: rotate(15deg);
        }

        /* --- Bottom Nav (Mobile) --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            height: 70px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding-bottom: 5px;
        }
        
        .nav-icon {
            text-align: center;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 500;
            width: 20%;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .nav-icon i {
            font-size: 1.4rem;
            display: block;
            margin-bottom: 4px;
        }
        
        .nav-icon.active { color: var(--primary-color); }
        .nav-icon.active i { transform: translateY(-2px); }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .cursor-pointer { cursor: pointer; }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        @media(min-width: 768px) {
            .menu-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .app-icon-btn {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            color: var(--secondary-color);
            text-decoration: none;
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            transition: all 0.2s;
        }
        .app-icon-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #eff6ff;
        }
        
        .app-icon-box {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        /* --- Chat --- */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 85%;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .chat-bubble.sent {
            background-color: #dcf8c6; /* WhatsApp Sent Greenish */
            color: #111;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-bubble.received {
            background-color: white;
            color: #111;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-meta {
            font-size: 0.65rem;
            margin-top: 4px;
            opacity: 0.7;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
        }
        
        .chat-category-badge {
            font-size: 0.65rem;
            background: rgba(0,0,0,0.08);
            padding: 2px 6px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
            font-weight: 600;
        }

        /* Mood Styles */
        .mood-btn {
            border: 2px solid transparent;
            transition: all 0.3s;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
        }
        .mood-btn:hover:not(:disabled) { transform: scale(1.1); }
        
        /* Disabled State for Mood Buttons */
        .mood-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
            transform: none !important;
        }
        
        /* Selected State for Mood Buttons */
        .mood-btn.selected-mood {
            opacity: 1;
            filter: none;
            border: 3px solid var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
            transform: scale(1.05) !important;
        }

        .mood-item-history {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            flex-shrink: 0;
        }

        /* Avatar Selection */
        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            object-fit: cover;
        }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected {
            border-color: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
        }
        .avatar-upload-label {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px dashed #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            flex-direction: column;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        .avatar-upload-label:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #eff6ff;
        }

        /* Goal List Styles */
        .goal-item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            animation: popUp 0.2s ease-out;
        }
        .goal-item-input {
            flex: 1;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        .goal-delete-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #fee2e2;
            color: #ef4444;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .goal-delete-btn:hover { background: #fecaca; transform: scale(1.1); }

        /* Report / Raport Styles */
        .report-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .report-item:hover { transform: translateX(3px); border-color: var(--primary-color); }
        .report-item.done { border-left: 4px solid var(--success-color); background: #f0fdf4; }
        
        /* NEW: Personality Eval Styles */
        .eval-section {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }
        .eval-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e2e8f0;
        }
        .eval-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .eval-select {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            min-width: 110px;
            cursor: pointer;
        }
        .eval-select.better { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; font-weight: 600; }
        .eval-select.solved { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; font-weight: 600; }

        .donut-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0% 0%, #e2e8f0 0% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 auto;
        }
        .donut-inner {
            width: 110px;
            height: 110px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Achievement Styles (Shared for Organizations & Skills) */
        .ach-card {
            border-left: 4px solid var(--primary-color);
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            position: relative;
            transition: all 0.2s;
        }
        .ach-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .ach-badge {
            font-size: 0.65rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .ach-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ef4444;
            background: rgba(254, 226, 226, 0.5);
            border: none;
            width: 30px; 
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .ach-delete-btn:hover { opacity: 1; background: #fee2e2; }

        /* Print Area */
        #printArea {
            display: none;
            background: white;
            padding: 40px;
            font-family: 'Times New Roman', serif;
        }
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; display: block; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; z-index: 9999; }
            .no-print { display: none !important; }
        }

        /* Pop Up Animation */
        @keyframes popUp {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
		
		.hidden {
  display: none !important;
}


.menu-badge {
  position: absolute;
  top: 6px;
  right: 12px;
  background: #dc3545;
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 12px;
}

    </style>
</head>
<body>

    <!-- MOBILE OVERLAY (Untuk Sidebar) -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <!-- PRINT AREA (Hidden by default, used for print) -->
    <div id="printArea"></div>

    <!-- MOOD MODAL OVERLAY (Custom Popup - Updated Class) -->
    <div id="moodModalOverlay" class="custom-modal-overlay hidden" style="z-index: 2000;">
        <div class="card p-4 m-3 shadow-lg text-center border-0" style="max-width: 320px; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div class="mb-3" id="moodModalIcon"></div>
            <h5 class="fw-bold mb-2" id="moodModalTitle">Title</h5>
            <p class="text-muted small mb-4" id="moodModalBody">Message</p>
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-light rounded-pill px-4" onclick="closeMoodModal()">Nanti</button>
                <button class="btn btn-primary rounded-pill px-4" onclick="actionMoodModal()">Ya, Tulis</button>
            </div>
        </div>
    </div>

    <!-- TEACHER REPORT MODAL -->
    <div id="teacherReportModalOverlay" class="custom-modal-overlay hidden" style="z-index: 2100;">
        <div class="card p-0 m-3 shadow-lg border-0" style="width: 100%; max-width: 550px; max-height: 90vh; display: flex; flex-direction: column; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Data & Evaluasi Siswa</h6>
                <button class="btn btn-sm btn-link text-white" onclick="closeTeacherReportModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- TEACHER MODAL TABS -->
          <!-- TEACHER MODAL TABS (FIXED LAYOUT) -->
            <div class="bg-light border-bottom flex-shrink-0">
			
    
    <!-- ... (Biarkan <li> Profil, Raport, Prestasi, Organisasi, Keahlian tetap disitu) ... -->

   
                <!--ul class="nav nav-pills flex-nowrap overflow-auto p-2 gap-2" id="teacherModalTabs" style="scrollbar-width: none; -ms-overflow-style: none; white-space: nowrap;"-->
                    <!-- HAPUS style="scrollbar..." yang lama, dan GANTI class-nya -->
					<ul class="nav nav-pills flex-wrap justify-content-center p-2 gap-2" id="teacherModalTabs">
					<li class="nav-item"><a class="nav-link active small py-1 px-3 border shadow-sm" onclick="switchTeacherModalView('profile')" href="#">Profil</a></li>
                    <li class="nav-item"><a class="nav-link small py-1 px-3 border shadow-sm" onclick="switchTeacherModalView('goals')" href="#">Raport</a></li>
                    <li class="nav-item"><a class="nav-link small py-1 px-3 border shadow-sm" onclick="switchTeacherModalView('achievements')" href="#">Prestasi</a></li>
                    <li class="nav-item"><a class="nav-link small py-1 px-3 border shadow-sm" onclick="switchTeacherModalView('org')" href="#">Organisasi</a></li>
                    <li class="nav-item"><a class="nav-link small py-1 px-3 border shadow-sm" onclick="switchTeacherModalView('skills')" href="#">Keahlian</a></li>
					<!-- Cari id="teacherModalTabs" dan tambahkan baris ini di paling bawah daftar <li> -->
					 <!-- TAMBAHKAN BARIS INI DI PALING BAWAH (Sebelum penutup </ul>) -->
					<li class="nav-item">
					<a class="nav-link small py-1 px-3 border shadow-sm" onclick="switchTeacherModalView('activity')" href="#">Aktivitas</a>
					</li>

				</ul>
            </div>

            <div class="card-body overflow-auto" id="teacherReportContent">
                <!-- Content injected via JS -->
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar hidden" id="mainSidebar">
        <div class="sidebar-header">
            <a href="#" class="brand-logo">
                <div class="bg-primary text-white rounded-3 p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>WaliQ</span>
            </a>
            <button class="btn btn-light rounded-circle text-muted sidebar-close-btn d-lg-none" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <nav class="nav-links" id="sidebarLinks">
            <!-- Populated via JS based on role -->
        </nav>

        <div class="user-profile-sidebar cursor-pointer" onclick="logout()">
            <img src="" id="sidebarAvatar" class="rounded-circle border" width="40" height="40">
            <div class="overflow-hidden">
                <div class="fw-bold text-truncate small" id="sidebarName">User</div>
                <div class="text-muted small" style="font-size: 0.75rem;">Logout</div>
            </div>
            <i class="fas fa-sign-out-alt text-danger ms-auto"></i>
        </div>

        <!-- 1. CREDIT DI SIDEBAR (Letakkan sebelum penutup tag aside) -->
        <div class="mt-3 pt-3 border-top text-center opacity-75">
            <small class="text-muted" style="font-size: 0.6rem;">
                Created by <b>Nailul Authar</b><br>
                SMK N 1 Brondong 2025
            </small>
        </div>
    </aside>

    <!-- MOBILE TOP NAVBAR -->
    <div class="mobile-navbar hidden" id="mobileTopNav">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-light rounded-circle text-primary" onclick="toggleSidebar()">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <a class="brand-logo fs-4 text-dark" href="#" style="font-weight: 800; text-decoration: none;">
                WaliQ
            </a>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span id="mobileWelcome" class="small fw-bold text-primary"></span>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="main-content no-sidebar" id="mainContentArea">
        
        <!-- AUTH SECTION -->
        <div id="authSection" class="d-flex align-items-center justify-content-center" style="min-height: 80vh;">
            <div class="col-md-5 col-lg-4">
                <div class="card p-4 border-0 shadow-lg">
                    <div class="text-center mb-4 pt-2">
                        <div class="bg-primary bg-opacity-10 d-inline-block p-3 rounded-circle mb-3 text-primary">
                            <i class="fas fa-user-graduate fa-2x"></i>
                        </div>
                        <h3 class="fw-bold">Selamat Datang</h3>
                        <p class="text-muted small">Portal Perwalian SMK N 1 Brondong</p>
                    </div>

                    <!-- Login -->
                    <div id="loginForm">
                        <form onsubmit="handleLogin(event)">
                            <div class="form-floating mb-3">
                                <input type="email" name="email" class="form-control rounded-4 bg-light border-0" id="loginEmail" placeholder="Email" autocomplete="username" required>
                                <label>Email Address</label>
                            </div>
                            <div class="form-floating mb-3 position-relative">
                                <input type="password" name="password" class="form-control rounded-4 bg-light border-0" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
                                <label>Password</label>
                                <span class="position-absolute top-50 end-0 translate-middle-y me-3 text-secondary cursor-pointer" onclick="togglePassword('loginPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <div class="text-end mb-3">
                                <a href="#" onclick="toggleAuth('forgot')" class="text-decoration-none small fw-bold text-primary">Lupa Password?</a>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-sm mb-3">MASUK</button>
                        </form>
                        <div class="text-center">
                            <span class="text-muted small">Belum punya akun?</span>
                            <a href="#" onclick="toggleAuth('register')" class="fw-bold text-decoration-none ms-1">Daftar</a>
                        </div>
                    </div>

                    <!-- Register -->
                    <div id="registerForm" class="hidden">
                        <form onsubmit="handleRegister(event)">
                            <div class="bg-info bg-opacity-10 p-3 rounded-3 mb-3 d-flex align-items-center">
                                <i class="fas fa-key text-info me-3 fa-lg"></i>
                                <div class="flex-grow-1">
                                    <small class="d-block text-muted fw-bold" style="font-size: 0.7rem;">KODE REGISTRASI</small>
                                    <input type="text" class="form-control form-control-sm border-0 bg-transparent p-0 fw-bold text-dark" id="regKey" placeholder="Ketik kode..." required>
                                </div>
                            </div>

                            <div id="studentFields" class="hidden animate-fade-in">
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control rounded-4 bg-light border-0" id="regNameStudent" placeholder="Nama">
                                    <label>Nama Siswa</label>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-7">
                                        <select class="form-select rounded-4 bg-light border-0 dynamic-class-select" id="regClass">
                                            <option selected disabled>Pilih Kelas</option>
                                            <!-- Dynamically filled -->
                                        </select>
                                    </div>
                                    <div class="col-5">
                                        <input type="text" class="form-control rounded-4 bg-light border-0" id="regBatch" placeholder="2024/2025">
                                    </div>
										
							<!-- TAMBAHKAN DROPDOWN GURU DI SINI -->
							<div id="teacherSelectGroup" class="col-12">
								<label>Pilih Guru Wali</label>
								<select id="signupTeacher" class="form-select">
								<option value="">Memuat data guru...</option>
								</select>
								<small class="text-muted" style="font-size: 0.7rem;">*Wajib dipilih agar guru bisa memantau Anda</small>
							</div>
                                </div>
							
                            </div>

                            <div id="staffFields" class="hidden animate-fade-in">
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control rounded-4 bg-light border-0" id="regNameStaff" placeholder="Nama">
                                    <label>Nama Lengkap</label>
                                </div>
                            </div>

                            <div class="form-floating mb-2">
                                <input type="email" name="email" class="form-control rounded-4 bg-light border-0" id="regEmail" placeholder="Email" autocomplete="username" required>
                                <label>Email</label>
                            </div>
                            <div class="form-floating mb-3 position-relative">
                                <input type="password" name="password" class="form-control rounded-4 bg-light border-0" id="regPassword" placeholder="Pass" autocomplete="new-password" required>
                                <label>Password</label>
                                <span class="position-absolute top-50 end-0 translate-middle-y me-3 text-secondary cursor-pointer" onclick="togglePassword('regPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>

                            <button type="submit" class="btn btn-success w-100 py-3 rounded-4 fw-bold shadow-sm mb-3">DAFTAR AKUN</button>
                        </form>
                        <div class="text-center">
                            <a href="#" onclick="toggleAuth('login')" class="text-muted small text-decoration-none"><i class="fas fa-arrow-left me-1"></i> Kembali Login</a>
                        </div>
                    </div>

                    <!-- Forgot Password -->
                    <div id="forgotForm" class="hidden">
                        <div class="text-center mb-4">
                            <h5 class="fw-bold">Reset Password</h5>
                            <p class="text-muted small">Link reset akan dikirim ke email Anda.</p>
                        </div>
                        <form onsubmit="handleForgotPassword(event)">
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control rounded-4 bg-light border-0" id="forgotEmail" required placeholder="email">
                                <label>Email Address</label>
                            </div>
                            <button type="submit" class="btn btn-warning w-100 py-3 rounded-4 fw-bold text-white mb-3">KIRIM RESET LINK</button>
                        </form>
                        <div class="text-center">
                            <a href="#" onclick="toggleAuth('login')" class="text-muted small text-decoration-none">Batal</a>
                        </div>
                    </div>

                </div>
                
                <!-- 2. CREDIT DI HALAMAN LOGIN (Letakkan di bawah kartu login utama) -->
                <div class="text-center mt-4 text-muted small animate-fade-in">
                    <small>Developed by <span class="fw-bold text-primary">Nailul Authar</span></small><br>
                    <small style="font-size: 0.75rem;">SMK N 1 Brondong &copy; 2025</small>
                </div>

            </div>
        </div>

        <!-- APP DASHBOARD CONTAINER -->
        <div id="appContainer" class="hidden">
            
            <!-- Hero Banner -->
            <div class="hero-card shadow-sm">
                <i class="fas fa-shapes hero-pattern"></i>
                <div class="d-flex align-items-center position-relative">
                    <div class="me-3">
                        <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=Felix" id="heroAvatar" class="avatar-frame" alt="Avatar">
                    </div>
                    <div>
                        <p class="text-white-50 mb-0 small text-uppercase fw-bold ls-1">Selamat Datang</p>
                        <h2 class="fw-bold mb-0" id="heroName">Nama User</h2>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <span id="heroRole" class="badge bg-white bg-opacity-25 backdrop-blur">Siswa</span>
                            <span id="heroDate" class="text-white-50 small ps-2 border-start border-white border-opacity-25"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- STUDENT VIEWS --- -->
            <div id="studentView" class="hidden">
                <!-- Home -->
                <div id="tabStudentHome" class="view-tab">
                    
                    <!-- NEW: GURU WALI GREETING WIDGET (REVISED UI - Fixed Positioning) -->
                    <!-- Tampilan: Foto Kanan, Nama Bawah Foto, Pesan Kiri -->
                    <div id="teacherGreetingWidget" class="card border-0 shadow-sm mb-4 hidden animate-fade-in" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 20px;">
                        <div class="card-body p-4 position-relative overflow-hidden">
                            <!-- Dekorasi Background -->
                            <i class="fas fa-quote-right position-absolute" style="right: 10px; bottom: -10px; font-size: 6rem; opacity: 0.15; transform: rotate(-15deg);"></i>
                            
                            <div class="d-flex align-items-center justify-content-between position-relative z-1">
                                <!-- Bagian Kiri: Isi Pesan -->
                                <div class="flex-grow-1 pe-4">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="badge bg-white bg-opacity-20 rounded-pill px-3 py-1 backdrop-blur border border-white border-opacity-25 shadow-sm">
                                            <i class="fas fa-bullhorn me-1"></i>Pesan Guru Wali
                                        </span>
                                        <small class="text-white-50 fw-bold" style="font-size: 0.7rem;" id="greetTime">Baru saja</small>
                                    </div>
                                    <div class="fs-5 fw-bold fst-italic lh-sm" id="greetMessage" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        "Pesan motivasi akan muncul di sini..."
                                    </div>
                                </div>

                                <!-- Bagian Kanan: Foto & Nama Guru (Posisi Fix) -->
                                <div class="text-center flex-shrink-0 d-flex flex-column align-items-center">
                                    <div class="avatar-frame rounded-circle mb-2 d-flex align-items-center justify-content-center p-0 bg-white" style="width: 70px; height: 70px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
                                         <img src="" id="greetTeacherAvatar" class="rounded-circle" width="62" height="62" style="object-fit: cover;">
                                    </div>
                                    <div class="fw-bold text-white small text-nowrap px-3 py-1 rounded-pill bg-black bg-opacity-10 backdrop-blur border border-white border-opacity-10" id="greetTeacherName">
                                        Nama Guru
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW MOOD CHECK WIDGET -->
                    <div class="card mb-4 border-0">
                        <div class="card-body text-center">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0 text-start"><i class="fas fa-heartbeat text-danger me-2"></i>Mood Check Harian</h6>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-light text-dark small" id="moodStatusBadge">Belum Check-in</span>
                                    <button id="btnResetTodayMood" class="btn btn-sm btn-light text-danger rounded-circle hidden" onclick="resetMoodToday()" title="Hapus log hari ini (Reset)" style="width: 24px; height: 24px; padding: 0;">
                                        <i class="fas fa-trash-alt" style="font-size: 0.7rem;"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Mood Buttons Container -->
                            <div id="moodButtonsContainer" class="d-flex justify-content-around mb-2">
                                <button id="btnMoodAngry" 
                                    type="button" 
                                    class="btn btn-outline-dark rounded-circle p-3 mood-btn shadow-sm"
                                    onclick="handleMoodClick('angry')">
                                    <i class="fas fa-angry fa-2x"></i>
                                    <div class="small mt-1 fw-bold">Marah</div>
                                </button>

                                <button id="btnMoodSad" 
                                    type="button" 
                                    class="btn btn-outline-danger rounded-circle p-3 mood-btn shadow-sm"
                                    onclick="handleMoodClick('sad')">
                                    <i class="fas fa-frown fa-2x"></i>
                                    <div class="small mt-1 fw-bold">Sedih</div>
                                </button>
                                
                                <button id="btnMoodNeutral" 
                                    type="button" 
                                    class="btn btn-outline-warning rounded-circle p-3 mood-btn shadow-sm"
                                    onclick="handleMoodClick('neutral')">
                                    <i class="fas fa-meh fa-2x"></i>
                                    <div class="small mt-1 fw-bold">Biasa Saja</div>
                                </button>
                                
                                <button id="btnMoodHappy" 
                                    type="button" 
                                    class="btn btn-outline-success rounded-circle p-3 mood-btn shadow-sm"
                                    onclick="handleMoodClick('happy')">
                                    <i class="fas fa-smile fa-2x"></i>
                                    <div class="small mt-1 fw-bold">Bahagia</div>
                                </button>
                            </div>
                            
                            <!-- Mood History List -->
                            <div class="mt-4 pt-3 border-top text-start">
                                 <h6 class="small fw-bold text-muted mb-3">Riwayat Mood Minggu Ini</h6>
                                 <div id="moodHistoryList" class="d-flex gap-2 overflow-auto pb-2" style="scrollbar-width: thin;">
                                     <div class="text-muted small">Memuat data...</div>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3 text-secondary">Menu Utama</h6>
                    <div id="studentDynamicMenus" class="menu-grid mb-4">
                        <!-- JS Populated -->
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">Biodata Ringkas</h6>
                            <div class="row g-3">
                                <div class="col-6"><small class="text-muted d-block">Kelas</small><span class="fw-bold" id="dispClass">-</span></div>
                                <div class="col-6"><small class="text-muted d-block">Tahun Ajaran</small><span class="fw-bold" id="dispHobby">-</span></div>
                                <div class="col-12"><small class="text-muted d-block">Cita-Cita</small><span class="fw-bold text-primary" id="dispDream">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
				
				
				<!-- TAB POLLING SISWA -->
    <div id="tabStudentPolling" class="view-tab hidden">
        <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white;">
            <div class="card-body p-4 text-center">
                <i class="fas fa-poll fa-3x mb-3 text-white-50"></i>
                <h4 class="fw-bold">Suara Siswa</h4>
                <p class="mb-0 opacity-75">Pendapatmu sangat berharga untuk kemajuan sekolah dan aplikasi ini.</p>
            </div>
        </div>

        <div id="studentPollContainer">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border text-primary"></div>
                <div class="mt-2 small">Mencari polling aktif...</div>
            </div>
        </div>
    </div>

                <!-- NEW: PERSONALITY (MENU NO. 1) -->
                <div id="tabStudentPersonality" class="view-tab hidden">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Kepribadian & Diri</h5>
                            
                            <ul class="nav nav-pills mb-3" id="personalityTabs" role="tablist">
                                <li class="nav-item flex-fill text-center">
                                    <button class="nav-link w-100 active" data-bs-toggle="pill" data-bs-target="#pers-char-content" type="button">Sifat/Karakter</button>
                                </li>
                                <li class="nav-item flex-fill text-center">
                                    <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#pers-interest-content" type="button">Minat & Bakat</button>
                                </li>
                                <li class="nav-item flex-fill text-center">
                                    <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#pers-diff-content" type="button">Kesulitan</button>
                                </li>
                            </ul>

                            <form onsubmit="savePersonality(event)">
                                <div class="tab-content mb-4">
                                    <!-- Karakter -->
                                    <div class="tab-pane fade show active" id="pers-char-content">
                                        <div class="alert alert-light border-start border-3 border-primary mb-3">
                                            <div class="fw-bold small text-primary mb-2">Menurutmu, apa sifat/karaktermu?</div>
                                            <div id="persCharList"></div>
                                            <button type="button" class="btn btn-sm btn-outline-primary rounded-pill mt-2" onclick="addPersonalityRow('char')">
                                                <i class="fas fa-plus me-1"></i> Tambah Sifat
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Minat Bakat -->
                                    <div class="tab-pane fade" id="pers-interest-content">
                                        <div class="alert alert-light border-start border-3 border-success mb-3">
                                            <div class="fw-bold small text-success mb-2">Apa minat & bakat terbesarmu?</div>
                                            <div id="persInterestList"></div>
                                            <button type="button" class="btn btn-sm btn-outline-success rounded-pill mt-2" onclick="addPersonalityRow('interest')">
                                                <i class="fas fa-plus me-1"></i> Tambah Minat/Bakat
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Kesulitan -->
                                    <div class="tab-pane fade" id="pers-diff-content">
                                        <div class="alert alert-light border-start border-3 border-danger mb-3">
                                            <div class="fw-bold small text-danger mb-2">Kesulitan Belajar</div>
                                            <div id="persDiffStudyList"></div>
                                            <button type="button" class="btn btn-sm btn-outline-danger rounded-pill mt-2" onclick="addPersonalityRow('diffStudy')">
                                                <i class="fas fa-plus me-1"></i> Tambah Kesulitan Belajar
                                            </button>
                                        </div>
                                        <div class="alert alert-light border-start border-3 border-warning mb-3">
                                            <div class="fw-bold small text-warning mb-2">Kesulitan Kehidupan (Sosial/Keluarga/dll)</div>
                                            <div id="persDiffLifeList"></div>
                                            <button type="button" class="btn btn-sm btn-outline-warning rounded-pill mt-2" onclick="addPersonalityRow('diffLife')">
                                                <i class="fas fa-plus me-1"></i> Tambah Kesulitan Hidup
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold">Simpan Kepribadian</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Goals (Updated with Tabs and Dynamic Lists) -->
                <div id="tabStudentGoals" class="view-tab hidden">
                     <!-- ... existing goals code ... -->
                     <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Peta Masa Depan</h5>
                            <!-- Tabs Navigation -->
                            <ul class="nav nav-pills mb-3" id="goalTabs" role="tablist">
                                <li class="nav-item flex-fill text-center" role="presentation">
                                    <button class="nav-link w-100 active" id="tab-x-btn" data-bs-toggle="pill" data-bs-target="#tab-x-content" type="button" role="tab">Kelas X</button>
                                </li>
                                <li class="nav-item flex-fill text-center" role="presentation">
                                    <button class="nav-link w-100" id="tab-xi-btn" data-bs-toggle="pill" data-bs-target="#tab-xi-content" type="button" role="tab">Kelas XI</button>
                                </li>
                                <li class="nav-item flex-fill text-center" role="presentation">
                                    <button class="nav-link w-100" id="tab-xii-btn" data-bs-toggle="pill" data-bs-target="#tab-xii-content" type="button" role="tab">Kelas XII</button>
                                </li>
                            </ul>

                            <form onsubmit="saveGoals(event)">
                                <div class="tab-content mb-4" id="goalTabsContent">
                                    <!-- Kelas X Content -->
                                    <div class="tab-pane fade show active" id="tab-x-content" role="tabpanel">
                                        <div class="alert alert-light border-start border-3 border-primary mb-3">
                                            <div class="fw-bold small text-primary mb-2">Target & Harapan Kelas X</div>
                                            <div id="goalsListX"></div>
                                            <button type="button" class="btn btn-sm btn-outline-primary rounded-pill mt-2" onclick="addGoalRow('x')">
                                                <i class="fas fa-plus me-1"></i> Tambah Target
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Kelas XI Content -->
                                    <div class="tab-pane fade" id="tab-xi-content" role="tabpanel">
                                        <div class="alert alert-light border-start border-3 border-warning mb-3">
                                            <div class="fw-bold small text-warning mb-2">Target & Harapan Kelas XI</div>
                                            <div id="goalsListXI"></div>
                                            <button type="button" class="btn btn-sm btn-outline-warning rounded-pill mt-2" onclick="addGoalRow('xi')">
                                                <i class="fas fa-plus me-1"></i> Tambah Target
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Kelas XII Content -->
                                    <div class="tab-pane fade" id="tab-xii-content" role="tabpanel">
                                        <div class="alert alert-light border-start border-3 border-success mb-3">
                                            <div class="fw-bold small text-success mb-2">Target & Harapan Kelas XII</div>
                                            <div id="goalsListXII"></div>
                                            <button type="button" class="btn btn-sm btn-outline-success rounded-pill mt-2" onclick="addGoalRow('xii')">
                                                <i class="fas fa-plus me-1"></i> Tambah Target
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- NEW: FINAL GOAL SECTION -->
                                <div class="card mt-4 border-warning">
                                    <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                                        <h6 class="fw-bold mb-0 text-warning-emphasis"><i class="fas fa-flag-checkered me-2"></i>Tujuan Akhir (Setelah Lulus)</h6>
                                        <span id="finalGoalLockStatus" class="badge bg-secondary">Draft</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="small fw-bold text-muted">Rencana Pilihan</label>
                                            <select class="form-select" id="finalGoalType">
                                                <option value="" disabled selected>Pilih Rencana...</option>
                                                <option value="Bekerja">Bekerja</option>
                                                <option value="Wirausaha">Wirausaha</option>
                                                <option value="Kuliah PTN">Kuliah di PTN</option>
                                                <option value="Kuliah PTS">Kuliah di PTS</option>
                                                <option value="Menikah">Menikah</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="small fw-bold text-muted">Alasan Memilih</label>
                                            <textarea class="form-control" id="finalGoalReason" rows="2" placeholder="Jelaskan alasanmu..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="small fw-bold text-muted">Tingkat Keyakinan</label>
                                            <select class="form-select" id="finalGoalConfidence">
                                                <option value="" disabled selected>Seberapa yakin kamu?</option>
                                                <option value="Yakin">Sangat Yakin</option>
                                                <option value="Tidak Yakin">Belum Yakin</option>
                                                <option value="Bisa Berubah">Masih Bisa Berubah</option>
                                            </select>
                                        </div>
                                        <div id="finalGoalActionContainer">
                                            <!-- Lock button specific here -->
                                            <button type="button" class="btn btn-outline-dark w-100 rounded-pill btn-sm" onclick="lockFinalGoal()" id="btnLockFinalGoal">
                                                <i class="fas fa-lock me-1"></i> Kunci Pilihan
                                            </button>
                                            <small class="text-danger d-block mt-2 text-center fst-italic hidden" id="finalGoalLockMsg">
                                                <i class="fas fa-lock me-1"></i> Terkunci. Hubungi Guru Wali untuk mengubah.
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 mt-4 rounded-pill fw-bold">Simpan Semua Peta</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ... existing achievements, org, skills tabs ... -->
                <div id="tabStudentAchievements" class="view-tab hidden">
                    <!-- Achievement Code preserved -->
                     <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Data Prestasi Siswa</h5>
                            
                            <!-- Form Input -->
                            <div class="card bg-light border-0 mb-4">
                                <div class="card-body">
                                    <form onsubmit="addAchievement(event)">
                                        <h6 class="small fw-bold text-primary mb-3"><i class="fas fa-plus-circle me-1"></i> Tambah Prestasi Baru</h6>
                                        <div class="row g-2 mb-2">
                                            <div class="col-6">
                                                <select class="form-select form-select-sm" id="achLevel" required>
                                                    <option value="" disabled selected>Tingkat</option>
                                                    <option value="Sekolah">Sekolah</option>
                                                    <option value="Kecamatan">Kecamatan</option>
                                                    <option value="Kabupaten">Kabupaten</option>
                                                    <option value="Provinsi">Provinsi</option>
                                                    <option value="Nasional">Nasional</option>
                                                    <option value="Internasional">Internasional</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select form-select-sm" id="achType" required>
                                                    <option value="" disabled selected>Jenis</option>
                                                    <option value="Akademik">Akademik</option>
                                                    <option value="Non Akademik">Non Akademik</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-floating mb-2">
                                            <input type="text" class="form-control form-control-sm" id="achName" placeholder="Nama Lomba/Prestasi" required>
                                            <label class="small">Nama Prestasi / Kegiatan</label>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-6">
                                                <select class="form-select form-select-sm" id="achRank" required>
                                                    <option value="" disabled selected>Pencapaian</option>
                                                    <option value="Juara 1">Juara 1</option>
                                                    <option value="Juara 2">Juara 2</option>
                                                    <option value="Juara 3">Juara 3</option>
                                                    <option value="Harapan 1">Harapan 1</option>
                                                    <option value="Harapan 2">Harapan 2</option>
                                                    <option value="Harapan 3">Harapan 3</option>
                                                    <option value="Peserta">Peserta</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control form-control-sm" id="achYear" placeholder="Tahun" required>
                                            </div>
                                        </div>
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control form-control-sm" id="achOrganizer" placeholder="Penyelenggara" required>
                                            <label class="small">Penyelenggara</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100 rounded-pill btn-sm fw-bold">Simpan Prestasi</button>
                                    </form>
                                </div>
                            </div>

                            <!-- List -->
                            <h6 class="fw-bold small text-muted mb-3 border-bottom pb-2">Riwayat Prestasi</h6>
                            <div id="achievementListContainer">
                                <div class="text-center small text-muted py-3">Memuat data...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabStudentOrg" class="view-tab hidden">
                    <!-- Org Code preserved -->
                     <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Riwayat Organisasi</h5>
                            
                            <!-- Form Input -->
                            <div class="card bg-light border-0 mb-4">
                                <div class="card-body">
                                    <form onsubmit="addOrganization(event)">
                                        <h6 class="small fw-bold text-primary mb-3"><i class="fas fa-plus-circle me-1"></i> Tambah Organisasi / Kegiatan</h6>
                                        <div class="mb-2">
                                            <select class="form-select form-select-sm" id="orgType" required>
                                                <option value="" disabled selected>Pilih Jenis Kegiatan</option>
                                                <option value="Intra Sekolah">Intra Sekolah (OSIS/MPK)</option>
                                                <option value="Ekstra Sekolah">Ekstra Sekolah (Pramuka/PMR/dll)</option>
                                                <option value="Luar Sekolah">Luar Sekolah (Karang Taruna/Komunitas)</option>
                                            </select>
                                        </div>
                                        <div class="form-floating mb-2">
                                            <input type="text" class="form-control form-control-sm" id="orgName" placeholder="Nama Organisasi" required>
                                            <label class="small">Nama Organisasi / Kegiatan</label>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-7">
                                                <select class="form-select form-select-sm" id="orgPosition" required onchange="toggleOrgField()">
                                                    <option value="" disabled selected>Posisi / Jabatan</option>
                                                    <option value="Anggota">Anggota</option>
                                                    <option value="Koordinator Seksi">Koordinator Seksi</option>
                                                    <option value="Pengurus">Pengurus</option>
                                                    <option value="Sekretaris">Sekretaris</option>
                                                    <option value="Bendahara">Bendahara</option>
                                                    <option value="Wakil Ketua">Wakil Ketua</option>
                                                    <option value="Ketua">Ketua</option>
                                                </select>
                                            </div>
                                            <div class="col-5">
                                                <input type="number" class="form-control form-control-sm" id="orgYear" placeholder="Tahun" required>
                                            </div>
                                        </div>
                                        <!-- Conditional Field -->
                                        <div id="orgFieldDiv" class="form-floating mb-3 hidden animate-fade-in">
                                            <input type="text" class="form-control form-control-sm" id="orgField" placeholder="Nama Bidang">
                                            <label class="small">Nama Bidang / Seksi</label>
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100 rounded-pill btn-sm fw-bold">Simpan Kegiatan</button>
                                    </form>
                                </div>
                            </div>

                            <!-- List -->
                            <h6 class="fw-bold small text-muted mb-3 border-bottom pb-2">Riwayat Keaktifan</h6>
                            <div id="orgListContainer">
                                <div class="text-center small text-muted py-3">Memuat data...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabStudentSkills" class="view-tab hidden">
                    <!-- Skills Code preserved -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Pengembangan Keahlian</h5>
                            
                            <div class="alert alert-light border-start border-3 border-info mb-4">
                                <div class="d-flex">
                                    <i class="fas fa-lightbulb text-info mt-1 me-3 fa-lg"></i>
                                    <div>
                                        <h6 class="fw-bold mb-1">Kenali Potensimu!</h6>
                                        <p class="small text-muted mb-0">Catat keahlian yang sudah kamu miliki dan rencanakan keahlian baru yang ingin kamu pelajari.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Input -->
                            <div class="card bg-light border-0 mb-4">
                                <div class="card-body">
                                    <form onsubmit="addSkill(event)">
                                        <h6 class="small fw-bold text-primary mb-3"><i class="fas fa-plus-circle me-1"></i> Tambah Keahlian</h6>
                                        <div class="mb-2">
                                            <select class="form-select form-select-sm" id="skillType" onchange="toggleSkillPlanField()" required>
                                                <option value="" disabled selected>Status Keahlian</option>
                                                <option value="owned">Sudah Dimiliki (Current Skill)</option>
                                                <option value="wanted">Ingin Dikembangkan (Target Skill)</option>
                                            </select>
                                        </div>
                                        <div class="form-floating mb-2">
                                            <input type="text" class="form-control form-control-sm" id="skillName" placeholder="Nama Keahlian" required>
                                            <label class="small">Nama Keahlian (Contoh: Desain Grafis, Public Speaking)</label>
                                        </div>
                                        
                                        <!-- Field for Owned: Level/Desc -->
                                        <div id="skillOwnedDiv" class="form-floating mb-3 animate-fade-in">
                                            <input type="text" class="form-control form-control-sm" id="skillLevel" placeholder="Tingkat">
                                            <label class="small">Tingkat Penguasaan (Misal: Dasar, Mahir, Sertifikat BNSP)</label>
                                        </div>

                                        <!-- Field for Wanted: Plan -->
                                        <div id="skillPlanDiv" class="form-floating mb-3 hidden animate-fade-in">
                                            <textarea class="form-control form-control-sm" id="skillPlan" placeholder="Rencana" style="height: 80px;"></textarea>
                                            <label class="small">Cara Mengembangkan (Rencana Aksi)</label>
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100 rounded-pill btn-sm fw-bold">Simpan Keahlian</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Lists -->
                            <div class="mb-4">
                                <h6 class="small fw-bold text-success border-bottom pb-2 mb-3"><i class="fas fa-check-circle me-2"></i>Keahlian yang Dimiliki</h6>
                                <div id="ownedSkillsList">
                                    <div class="text-center small text-muted">Belum ada data.</div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="small fw-bold text-warning border-bottom pb-2 mb-3"><i class="fas fa-bullseye me-2"></i>Target Pengembangan</h6>
                                <div id="wantedSkillsList">
                                    <div class="text-center small text-muted">Belum ada data.</div>
                                </div>
                            </div>

                            <!-- Teacher Advice -->
                            <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                                <h6 class="fw-bold text-warning-emphasis mb-2"><i class="fas fa-comment-dots me-2"></i>Saran Guru Wali</h6>
                                <p class="small text-dark mb-0 fst-italic" id="skillTeacherNoteDisplay">Belum ada saran.</p>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- NEW: RAPORT EVALUASI (Student Tabbed & Lockable) -->
                <div id="tabStudentReport" class="view-tab hidden">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Raport Evaluasi Diri</h5>
                            
                            <!-- Tabs Navigation -->
                            <ul class="nav nav-pills mb-4" id="reportTabs" role="tablist">
                                <li class="nav-item flex-fill text-center">
                                    <button class="nav-link w-100 active" onclick="switchReportTab('x')" id="rep-x-btn">Kelas X</button>
                                </li>
                                <li class="nav-item flex-fill text-center">
                                    <button class="nav-link w-100" onclick="switchReportTab('xi')" id="rep-xi-btn">Kelas XI</button>
                                </li>
                                <li class="nav-item flex-fill text-center">
                                    <button class="nav-link w-100" onclick="switchReportTab('xii')" id="rep-xii-btn">Kelas XII</button>
                                </li>
                            </ul>

                            <!-- Content Container (Dynamic based on selected tab) -->
                            <div id="reportContentArea">
                                <!-- Injected via JS -->
                            </div>

                            <!-- Teacher Note Read-Only -->
                            <div class="alert alert-info border-0 bg-info bg-opacity-10 mt-4">
                                <h6 class="fw-bold text-info mb-2"><i class="fas fa-comment-alt me-2"></i>Catatan Guru Wali</h6>
                                <p class="small text-dark mb-0 fst-italic" id="reportTeacherNote">Belum ada catatan.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Curhat / Inbox -->
                <div id="tabStudentCurhat" class="view-tab hidden">
                    <div class="card h-100 d-flex flex-column shadow-sm" style="min-height: 75vh;">
                        <div class="card-header bg-white border-bottom py-3">
                            <h6 class="fw-bold mb-0 text-primary"><i class="fas fa-comments me-2"></i>Konseling & Inbox</h6>
                            <small class="text-muted" style="font-size:0.75rem">Privasi Terjaga</small>
                        </div>
                        <div class="card-body p-0 flex-grow-1 bg-light position-relative" style="background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px;">
                            <div id="myCurhatList" class="p-3 chat-container" style="max-height: 60vh; overflow-y: auto;">
                                <!-- Chat bubbles here -->
                            </div>
                        </div>
                        <div class="p-3 bg-white border-top">
                            <div class="d-flex flex-column gap-2">
                                <select class="form-select form-select-sm rounded-pill px-3 border-primary border-opacity-25" id="chatCategory" style="max-width: 150px;">
                                    <option value="Curhat"> Curhat</option>
                                    <option value="Bullying"> Bullying</option>
                                    <option value="Masa Depan"> Masa Depan</option>
                                    <option value="Prestasi"> Prestasi</option>
                                    <option value="Lainnya"> Lainnya</option>
                                </select>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control bg-light border-0 rounded-pill px-4" id="curhatMsg" placeholder="Tulis pesan..." onkeypress="handleEnterChat(event)">
                                    <button onclick="sendCurhat('student')" class="btn btn-primary rounded-circle" style="width: 45px; height: 45px;"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile (UPDATED: Teacher Info) -->
                <div id="tabStudentProfile" class="view-tab hidden">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Edit Profil</h5>
                            <form onsubmit="updateProfile(event)">
                                <div class="text-center mb-4">
                                    <img src="" id="previewAvatar" class="avatar-frame mb-3" width="100" height="100">
                                    <div class="small text-muted mb-2">Pilih Avatar</div>
                                    
                                    <div class="d-flex justify-content-center gap-3 mb-3">
                                        <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=Felix" class="avatar-option" onclick="selectAvatar('male')" id="avOptMale" title="Siswa Laki-laki">
                                        <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=HijabGirl&top=hijab&accessories=glasses" class="avatar-option" onclick="selectAvatar('female')" id="avOptFemale" title="Siswi Berhijab">
                                        <label class="avatar-upload-label" title="Upload Foto">
                                            <i class="fas fa-camera fa-lg mb-1"></i>
                                            <span>Foto</span>
                                            <input type="file" accept="image/*" class="d-none" onchange="handleFileUpload(this)">
                                        </label>
                                    </div>
                                    <input type="hidden" id="editAvatarValue">
                                </div>

                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control rounded-4 bg-light border-0" id="editName" placeholder="Nama Lengkap">
                                    <label>Nama Lengkap</label>
                                </div>

                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="small text-muted">No HP / WhatsApp</label>
                                        <input type="text" id="editPhone" class="form-control">
                                    </div>
                                    <div class="col-12">
                                        <label class="small text-muted">Hobi</label>
                                        <input type="text" id="editHobby" class="form-control">
                                    </div>
                                    <div class="col-12">
                                        <label class="small text-muted">Cita-Cita</label>
                                        <input type="text" id="editDream" class="form-control">
                                    </div>
                                    <div class="col-12">
                                        <label class="small text-muted">Alamat Lengkap</label>
                                        <textarea id="editAddress" class="form-control" rows="2"></textarea>
                                    </div>
                                    
                                    <!-- NEW: TEACHER SELECTOR IN PROFILE -->
                                    <div class="col-12 border-top pt-2 mt-2">
                                        <label class="small fw-bold text-primary mb-1">Guru Wali Kelas</label>
                                        <select id="editTeacherSelect" class="form-select bg-light border-0">
                                            <option value="">-- Pilih Guru Wali --</option>
                                        </select>
                                        <small class="text-muted" style="font-size:0.7rem">*Pilih guru wali agar bisa menerima pesan harian.</small>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 mt-4 rounded-pill">Simpan Perubahan</button>
                            </form>
                            
                            <!-- NEW: Teacher Profile Info -->
                            <div class="mt-4 pt-4 border-top">
                                <h6 class="fw-bold mb-3">Info Guru Wali</h6>
                                <div id="myTeacherInfo" class="d-flex align-items-center gap-3 p-3 bg-light rounded-3">
                                    <div class="text-center w-100 text-muted small py-2">Memuat data guru...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
				<!-- SISIPKAN INI DI BAGIAN STUDENT VIEWS (HTML) -->

<div id="tabStudentPet" class="view-tab hidden">
    <div class="card border-0 shadow-sm" style="background: linear-gradient(180deg, #e0f2fe 0%, #ffffff 100%);">
        <div class="card-body text-center p-4">
            
            <!-- Header Status -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="bg-white px-3 py-1 rounded-pill shadow-sm small fw-bold text-primary">
                    Level <span id="petLevel">1</span>
                </div>
                <div class="bg-white px-3 py-1 rounded-pill shadow-sm small fw-bold text-warning">
                    <i class="fas fa-coins me-1"></i> <span id="petCoins">0</span> Koin
                </div>
            </div>

            <!-- Pet Display Area -->
            <!-- Pet Display Area (GANTI KODE LAMA DENGAN INI) -->
            <div id="petContainer" class="position-relative mb-5 mt-4 rounded-4 shadow-sm border" 
                 style="padding-bottom: 70px;height: 300px; display: flex; align-items: flex-end; justify-content: center; 
                        background-image: url('pet/bg.png'); background-size: cover; background-position: center; transition: background 0.5s; overflow: hidden;">
                
                <!-- Tombol Pilih Background -->
                <div class="position-absolute top-0 end-0 p-3 z-2 d-flex gap-2">
                    <button class="btn btn-sm btn-light rounded-circle shadow border" onclick="changePetBg('pet/bg.png')" title="Background Alam" style="width:36px;height:36px; font-size:1.2rem;"></button>
                    <button class="btn btn-sm btn-light rounded-circle shadow border" onclick="changePetBg('pet/bg2.png')" title="Background Rumah" style="width:36px;height:36px; font-size:1.2rem;"></button>
                </div>

                <!-- GAMBAR PET BARU -->
                <!-- Class 'animate-bounce-slow' membuat hewan bergerak naik-turun halus -->
                <img src="pet/gemoy.png" id="petImage" class="animate-bounce-slow" width="80" 
                     style="transition: all 0.3s; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); cursor: pointer;">
                
                <!-- Bubble Chat Pet -->
                <div id="petBubble" class="position-absolute bg-white p-3 rounded-4 shadow-sm small fw-bold text-dark hidden" 
                     style="top: 30px; left: 20px; max-width: 140px; z-index: 10; border-bottom-left-radius: 0; animation: popUp 0.3s;">
                    Aku lapar... 
                </div>
            </div>

            <!-- Progress Bars (Health, Hunger, Happy) -->
            <div class="row g-3 mb-4 px-2">
                <div class="col-12">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="fw-bold text-muted"><i class="fas fa-heart text-danger me-1"></i>Kesehatan</span>
                        <span id="valHealth">100%</span>
                    </div>
                    <div class="progress rounded-pill" style="height: 8px;">
                        <div id="barHealth" class="progress-bar bg-danger" style="width: 100%"></div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="fw-bold text-muted"><i class="fas fa-utensils text-warning me-1"></i>Lapar</span>
                        <span id="valHunger">100%</span>
                    </div>
                    <div class="progress rounded-pill" style="height: 8px;">
                        <div id="barHunger" class="progress-bar bg-warning" style="width: 100%"></div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="fw-bold text-muted"><i class="fas fa-smile text-primary me-1"></i>Bahagia</span>
                        <span id="valHappy">100%</span>
                    </div>
                    <div class="progress rounded-pill" style="height: 8px;">
                        <div id="barHappy" class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid grid-cols-3 gap-2 d-flex justify-content-center">
                <button onclick="petAction('feed')" class="btn btn-light shadow-sm rounded-4 p-3 d-flex flex-column align-items-center" style="width: 90px;">
                    <span class="fs-2"></span>
                    <span class="small fw-bold mt-1">Makan</span>
                    <span class="text-muted" style="font-size: 0.6rem;">-10 Koin</span>
                </button>
                <button onclick="petAction('play')" class="btn btn-light shadow-sm rounded-4 p-3 d-flex flex-column align-items-center" style="width: 90px;">
                    <span class="fs-2"></span>
                    <span class="small fw-bold mt-1">Main</span>
                    <span class="text-muted" style="font-size: 0.6rem;">-5 Koin</span>
                </button>
                <button onclick="petAction('sleep')" class="btn btn-light shadow-sm rounded-4 p-3 d-flex flex-column align-items-center" style="width: 90px;">
                    <span class="fs-2"></span>
                    <span class="small fw-bold mt-1">Tidur</span>
                    <span class="text-muted" style="font-size: 0.6rem;">Free</span>
                </button>
            </div>
            
            <div class="mt-4 alert alert-info small border-0 bg-info bg-opacity-10">
                <i class="fas fa-info-circle me-1"></i> <b>Tips:</b> Isi "Mood Harian" atau "Target Belajar" untuk mendapatkan Koin tambahan!
            </div>

        </div>
    </div>
</div>
			</div>

            <!-- --- TEACHER VIEWS --- -->
           <div id="teacherView" class="hidden">
    <!-- 1. BERANDA GURU (Sapaan & Info) -->
    <div id="t_home" class="view-tab">
        <div class="card bg-primary text-white mb-4 border-0 shadow">
            <div class="card-body p-4">
                <h3 class="fw-bold"><i class="fas fa-chalkboard-teacher me-2"></i>Selamat Datang, Guru Wali!</h3>
                <p class="mb-0 opacity-75">Selamat bekerja. Pantau perkembangan siswa dan pesan masuk dari menu di samping.</p>
            </div>
        </div>
        
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm" onclick="document.querySelector('[data-target=\'t_students\']').click()" style="cursor:pointer">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Data Siswa</h6>
                            <small class="text-muted">Kelola data siswa perwalian</small>
                        </div>
                    </div>
                </div>
            </div>
             <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm" onclick="document.querySelector('[data-target=\'t_daily_msg\']').click()" style="cursor:pointer">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                            <i class="fas fa-bullhorn fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Pesan Harian</h6>
                            <small class="text-muted">Kirim sapaan/motivasi</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm" onclick="document.querySelector('[data-target=\'t_inbox\']').click()" style="cursor:pointer">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger">
                            <i class="fas fa-envelope fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Inbox <span id="homeInboxBadge" class="badge bg-danger rounded-pill hidden">0</span></h6>
                            <small class="text-muted">Pesan masuk dari siswa</small>
                        </div>
                    </div>
                </div>
            </div>
			
			
	
			<!-- LOG AKTIVITAS SISWA (Masukkan di dalam div t_home, di bawah kartu statistik) -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-primary"><i class="fas fa-history me-2"></i>Aktivitas Siswa Terbaru</h6>
        <button class="btn btn-sm btn-light" onclick="loadStudentActivityLogs()"><i class="fas fa-sync-alt"></i></button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light small text-muted">
                    <tr>
                        <th>Waktu</th>
                        <th>Siswa</th>
                        <th>Aktivitas</th>
                    </tr>
                </thead>
                <tbody id="activityLogTableBody" class="small">
                    <tr><td colspan="3" class="text-center py-3 text-muted">Klik refresh untuk memuat...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
        </div>
    </div>

    <!-- 2. DATA SISWA (Hanya tampil saat menu Data Siswa diklik) -->
    <div id="t_students" class="view-tab hidden">
        <h5 class="fw-bold mb-3 border-bottom pb-2">Data Siswa Perwalian</h5>
        <!-- Tab Angkatan (X, XI, XII) -->
        <ul class="nav nav-tabs mb-3 border-0 justify-content-start" id="studentGradeTabs">
            <li class="nav-item"><a class="nav-link active rounded-pill px-4 me-2 border" href="#" onclick="fetchStudents('X', this)">Kelas X</a></li>
            <li class="nav-item"><a class="nav-link rounded-pill px-4 me-2 border" href="#" onclick="fetchStudents('XI', this)">Kelas XI</a></li>
            <li class="nav-item"><a class="nav-link rounded-pill px-4 border" href="#" onclick="fetchStudents('XII', this)">Kelas XII</a></li>
        </ul>
        
        <input type="text" class="form-control mb-3 rounded-pill border-0 shadow-sm p-3" id="searchStudent" placeholder=" Cari nama siswa..." onkeyup="filterStudents()">
        <div id="studentsContainer" class="row g-3">
            <!-- List siswa akan muncul di sini -->
        </div>
        <div id="teacherPagination" class="d-flex justify-content-center gap-2 mt-4 pb-4"></div>
    </div>
    
    <!-- NEW: PESAN HARIAN GURU (Tab Baru) -->
    <div id="t_daily_msg" class="view-tab hidden">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h5 class="fw-bold mb-4"><i class="fas fa-paper-plane me-2 text-warning"></i>Kirim Pesan Harian</h5>
                <form onsubmit="sendDailyMessage(event)">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Target Penerima</label>
                        <select id="msgTarget" class="form-select">
                            <option value="ALL">Semua Siswa Perwalian</option>
                            <!-- Individual students will be populated here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Pesan / Motivasi / Pengumuman</label>
                        <textarea id="msgBody" class="form-control" rows="3" placeholder="Contoh: Selamat pagi anak-anak, jangan lupa sarapan dan semangat belajar!" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning w-100 rounded-pill fw-bold">Kirim Pesan</button>
                </form>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h6 class="fw-bold mb-0">Riwayat Pesan Terkirim</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light small text-muted">
                            <tr>
                                <th>Tanggal</th>
                                <th>Penerima</th>
                                <th>Isi Pesan</th>
                            </tr>
                        </thead>
                        <tbody id="msgHistoryBody" class="small">
                            <tr><td colspan="3" class="text-center py-3 text-muted">Memuat riwayat...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="msgPagination" class="d-flex justify-content-center gap-2 py-3 border-top"></div>
            </div>
        </div>
    </div>

    <!-- 3. INBOX (Hanya tampil saat menu Inbox diklik) -->
    <div id="t_inbox" class="view-tab hidden">
        <div class="card border-0 shadow-sm" style="height: calc(100vh - 100px);">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
               <div class="d-flex align-items-center gap-2">
        <!--tutup pesan chat-->
		<button class="btn btn-sm btn-outline-secondary"
        onclick="switchTab('t_home', document.querySelector('[data-target=\'t_home\']'))">
    <i class="fas fa-arrow-left"></i>
</button>
        <h6 class="fw-bold mb-0">Kotak Masuk</h6>
    </div>
                <ul class="nav nav-pills card-header-pills small" id="inboxGradeTabs">
                    <li class="nav-item"><a class="nav-link active py-1 px-2" href="#" onclick="filterInbox('X', this)">X</a></li>
                    <li class="nav-item"><a class="nav-link py-1 px-2" href="#" onclick="filterInbox('XI', this)">XI</a></li>
                    <li class="nav-item"><a class="nav-link py-1 px-2" href="#" onclick="filterInbox('XII', this)">XII</a></li>
                </ul>
            </div>
            <div class="card-body p-0 position-relative h-100 overflow-hidden">
                <div id="inboxList" class="list-group list-group-flush h-100 overflow-auto">
                    <div class="p-4 text-center text-muted">Memuat pesan...</div>
                </div>
                
                <!-- Area Chat (Overlay) -->
                <div class="bg-light d-flex flex-column h-100 w-100 position-absolute top-0 start-0" id="teacherChatArea" style="display:none !important; z-index: 10;">
                    <div class="p-3 bg-white border-bottom shadow-sm d-flex justify-content-between align-items-center">
                        <span id="chatWithStudentName" class="fw-bold text-primary"><i class="fas fa-arrow-left me-2 cursor-pointer" onclick="closeTeacherChat()"></i> Nama Siswa</span>
                        <button class="btn btn-sm btn-light rounded-circle" onclick="closeTeacherChat()"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="teacherChatMessages" class="p-3 chat-container flex-grow-1 overflow-auto"></div>
                    <div class="p-3 bg-white border-top">
                        <div class="input-group">
                            <input type="text" id="teacherReplyMsg" class="form-control rounded-start-pill" placeholder="Tulis balasan...">
                            <button class="btn btn-primary rounded-end-pill px-4" onclick="replyAsTeacher()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
	
			<!-- 5. POLLING MANAGEMEN (GURU) -->
    <div id="t_polling" class="view-tab hidden">
        <div class="row g-4">
            <!-- Kolom Kiri: Form Buat Polling -->
            <div class="col-md-5">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold text-primary">
                        <i class="fas fa-plus-circle me-2"></i>Buat Polling Baru
                    </div>
                    <div class="card-body">
                        <form onsubmit="createPoll(event)">
                            <div class="mb-3">
                                <label class="small text-muted fw-bold">Judul Polling</label>
                                <input type="text" id="pollTitle" class="form-control" value="Evaluasi Aplikasi WaliQ" required>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted fw-bold">Durasi (Hari)</label>
                                <input type="number" id="pollDuration" class="form-control" value="2" min="1" required>
                                <small class="text-muted" style="font-size:0.7rem">*Default: 2 Hari</small>
                            </div>
                            
                            <label class="small text-muted fw-bold mb-2">Daftar Pertanyaan (Otomatis)</label>
                            <div class="bg-light p-3 rounded mb-3 border" style="max-height: 300px; overflow-y:auto;">
                                <!-- Q1 -->
                                <div class="mb-3">
                                    <small class="fw-bold d-block text-dark">1. Komunikasi Guru Wali</small>
                                    <input type="text" class="form-control form-control-sm mb-1" id="q1_text" value="Apakah aplikasi ini memudahkanmu berkomunikasi dengan Guru Wali?">
                                    <input type="text" class="form-control form-control-sm bg-white" value="Sangat Setuju, Setuju, Tidak Setuju" disabled>
                                </div>
                                <!-- Q2 -->
                                <div class="mb-3">
                                    <small class="fw-bold d-block text-dark">2. Kepuasan Aplikasi</small>
                                    <input type="text" class="form-control form-control-sm mb-1" id="q2_text" value="Apakah kamu senang menggunakan aplikasi ini?">
                                    <input type="text" class="form-control form-control-sm bg-white" value="Sangat Senang, Senang, Kurang Senang" disabled>
                                </div>
                                <!-- Q3 -->
                                <div class="mb-3">
                                    <small class="fw-bold d-block text-dark">3. Fitur Peliharaan</small>
                                    <input type="text" class="form-control form-control-sm mb-1" id="q3_text" value="Apakah fitur 'Peliharaan' membuatmu lebih semangat login?">
                                    <input type="text" class="form-control form-control-sm bg-white" value="Ya Sangat, Lumayan, Biasa Saja" disabled>
                                </div>
                                <!-- Q4 -->
                                <div class="mb-3">
                                    <small class="fw-bold d-block text-dark">4. Fitur Evaluasi Diri</small>
                                    <input type="text" class="form-control form-control-sm mb-1" id="q4_text" value="Apakah fitur 'Evaluasi Diri' membantumu mengenali potensi?">
                                    <input type="text" class="form-control form-control-sm bg-white" value="Sangat Membantu, Membantu, Kurang" disabled>
                                </div>
                                <!-- Q5 -->
                                <div class="mb-3">
                                    <small class="fw-bold d-block text-dark">5. Keseluruhan</small>
                                    <input type="text" class="form-control form-control-sm mb-1" id="q5_text" value="Secara keseluruhan, apa penilaianmu untuk aplikasi ini?">
                                    <input type="text" class="form-control form-control-sm bg-white" value="Bagus Sekali (A), Cukup (B), Perlu Perbaikan (C)" disabled>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold">
                                <i class="fas fa-paper-plane me-1"></i> Terbitkan Polling
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Kolom Kanan: List & Hasil -->
            <div class="col-md-7">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-history me-2"></i>Riwayat & Hasil</span>
                        <button class="btn btn-sm btn-link" onclick="loadTeacherPolls()"><i class="fas fa-sync"></i></button>
                    </div>
                    <div class="card-body p-0">
                        <div id="teacherPollList" class="list-group list-group-flush">
                            <div class="text-center text-muted py-5">Memuat data polling...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Hasil Detail -->
        <div id="pollResultModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold">Hasil Polling</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="pollResultContent">
                        <!-- Chart injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
			

    <!-- 4. PROFIL SAYA (Hanya tampil saat menu Profil diklik) -->
    <div id="t_profile" class="view-tab hidden">
        <div class="card shadow-sm" style="max-width: 600px; margin: 0 auto;">
            <div class="card-body">
                <h5 class="fw-bold mb-4 text-center">Profil Guru</h5>
                <form onsubmit="saveTeacherProfile(event)">
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <img src="" id="teacherPreviewAvatar" class="rounded-circle border p-1" width="100" height="100" style="object-fit: cover;">
                            <label class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-2 shadow-sm cursor-pointer" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-camera" style="font-size: 0.8rem;"></i>
                                <input type="file" accept="image/*" class="d-none" onchange="handleFileUpload(this, 'teacher')">
                            </label>
                        </div>
                        <input type="hidden" id="editTeacherAvatar">
                    </div>

                    <div class="form-floating mb-3">
                        <input type="text" id="editTeacherName" class="form-control bg-light border-0" required placeholder="Nama">
                        <label>Nama Lengkap</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" id="editTeacherNIP" class="form-control bg-light border-0" placeholder="NIP">
                        <label>NIP (Opsional)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" id="editTeacherPhone" class="form-control bg-light border-0" placeholder="HP">
                        <label>No. HP / WhatsApp</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="text" id="editTeacherEmailDisplay" class="form-control bg-light border-0" disabled>
                        <label>Email Login</label>
                    </div>

                    <div class="accordion mb-4" id="accordionSec">
                        <div class="accordion-item border-0 bg-transparent">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-danger bg-opacity-10 text-danger rounded shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#secCollapse">
                                    <i class="fas fa-shield-alt me-2"></i> Ganti Password / Email
                                </button>
                            </h2>
                            <div id="secCollapse" class="accordion-collapse collapse" data-bs-parent="#accordionSec">
                                <div class="accordion-body px-0">
                                    <div class="mb-2">
                                        <label class="small text-muted">Email Baru</label>
                                        <input type="email" id="newAuthEmail" class="form-control" placeholder="Biarkan kosong jika tidak ubah">
                                    </div>
                                    <div class="mb-2">
                                        <label class="small text-muted">Password Baru</label>
                                        <input type="password" id="newAuthPassword" class="form-control" placeholder="Min 6 karakter">
                                    </div>
                                    <small class="text-danger fst-italic d-block mt-2" style="font-size: 0.75rem;">* Anda harus Login ulang setelah mengubah ini.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">Simpan Profil</button>
                </form>
            </div>
        </div>
    </div>
</div>

			
                <!--div id="teacherDynamicMenus" class="menu-grid mb-4">
					<li class="nav-item position-relative">
					<a class="nav-link" data-menu="inbox">
					<i class="fas fa-envelope"></i> Inbox
					<span id="inboxBadge" class="menu-badge d-none">0</span>
					</a>
					</li>
				
				
				</div-->
                
                <!--ul class="nav nav-pills mb-3 bg-white p-2 rounded-pill shadow-sm nav-justified">
                    <li class="nav-item"><a class="nav-link active rounded-pill" data-bs-toggle="pill" href="#t_students">Data Siswa</a></li>
                    <li class="nav-item"><a class="nav-link rounded-pill" data-bs-toggle="pill" href="#t_inbox">Pesan Masuk</a></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="t_students">
                        <input type="text" class="form-control mb-3 rounded-pill border-0 shadow-sm p-3" id="searchStudent" placeholder=" Cari nama siswa..." onkeyup="filterStudents()">
                        <div id="studentsContainer" class="row g-3"></div>
                    </div-->
                    
                    <!-- Teacher Inbox with Reply Feature -->
                    <div class="tab-pane fade" id="t_inbox">
                        <div class="card border-0 shadow-sm" style="min-height: 500px;">
                            <div class="card-header bg-white">
                                <h6 class="fw-bold mb-0">Kotak Masuk Curhat</h6>
                            </div>
                            <div class="card-body p-0 d-flex flex-column">
                                <div id="inboxList" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                                    <!-- List of students who chatted -->
                                    <div class="p-3 text-center text-muted small">Memuat daftar pesan...</div>
                                </div>
                                
                                <div class="border-top flex-grow-1 bg-light d-flex flex-column" id="teacherChatArea" style="display:none !important;">
                                    <div class="p-2 bg-white small fw-bold text-primary d-flex justify-content-between">
                                        <span id="chatWithStudentName">Nama Siswa</span>
                                        <button class="btn btn-sm btn-link text-muted p-0" onclick="closeTeacherChat()">Tutup</button>
                                    </div>
                                    <div id="teacherChatMessages" class="p-3 chat-container flex-grow-1" style="overflow-y: auto; max-height: 300px;"></div>
                                    <div class="p-2 bg-white border-top">
                                        <div class="input-group">
                                            <input type="text" id="teacherReplyMsg" class="form-control" placeholder="Balas siswa...">
                                            <button class="btn btn-primary" onclick="replyAsTeacher()"><i class="fas fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- ADMIN VIEWS --- -->
            <div id="adminView" class="hidden">
                <!-- 1. ADMIN HOME (NEW) -->
                <div id="tabAdminHome" class="view-tab">
                    <div class="card bg-dark text-white mb-4 border-0 shadow" style="background: linear-gradient(45deg, #1e293b, #334155);">
                        <div class="card-body p-4">
                            <h3 class="fw-bold"><i class="fas fa-user-shield me-2"></i>Admin Dashboard</h3>
                            <p class="mb-0 opacity-75">Selamat Datang Administrator. Pantau statistik dan kelola pengguna.</p>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body d-flex align-items-center gap-3">
                                    <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                                        <i class="fas fa-user-graduate fa-2x"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" id="statStudentCount">0</h3>
                                        <small class="text-muted">Total Siswa</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body d-flex align-items-center gap-3">
                                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                                        <i class="fas fa-chalkboard-teacher fa-2x"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" id="statTeacherCount">0</h3>
                                        <small class="text-muted">Total Guru</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body d-flex align-items-center gap-3">
                                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger">
                                        <i class="fas fa-comments fa-2x"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" id="statMsgCount">-</h3>
                                        <small class="text-muted">Pesan Masuk</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm cursor-pointer hover-card" onclick="document.querySelector('[data-target=\'tabAdminUsers\']').click()">
                                <div class="card-body text-center p-4">
                                    <i class="fas fa-users-cog fa-3x text-secondary mb-3"></i>
                                    <h5 class="fw-bold">Manajemen User</h5>
                                    <p class="text-muted small">Tambah, Edit, atau Hapus Akun Siswa & Guru</p>
                                    <button class="btn btn-outline-primary btn-sm rounded-pill px-4">Kelola</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm cursor-pointer hover-card" onclick="document.querySelector('[data-target=\'tabAdminKeys\']').click()">
                                <div class="card-body text-center p-4">
                                    <i class="fas fa-key fa-3x text-warning mb-3"></i>
                                    <h5 class="fw-bold">Kode Akses</h5>
                                    <p class="text-muted small">Atur Kode Registrasi Aplikasi</p>
                                    <button class="btn btn-outline-warning btn-sm rounded-pill px-4">Atur</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. USER MANAGEMENT -->
                <div id="tabAdminUsers" class="view-tab hidden">
                    <ul class="nav nav-tabs mb-3 border-bottom-0" id="adminUserSubTabs">
                        <li class="nav-item"><a class="nav-link active small rounded-pill me-2 px-3 cursor-pointer" onclick="openUserList('student', this)">Siswa</a></li>
                        <li class="nav-item"><a class="nav-link small rounded-pill me-2 px-3 cursor-pointer" onclick="openUserList('teacher', this)">Guru</a></li>
                        <li class="nav-item"><a class="nav-link small rounded-pill me-2 px-3 cursor-pointer" onclick="openUserList('admin', this)">Admin</a></li>
                        <li class="nav-item"><a class="nav-link small rounded-pill px-3 cursor-pointer" onclick="openClassManager(this)">Data Kelas</a></li>
                    </ul>
                    <div id="adminUserSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0" id="userListTitle">Daftar User</h6>
                            <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="document.getElementById('addUserForm').classList.toggle('hidden')">
                                <i class="fas fa-plus me-1"></i> Tambah User
                            </button>
                        </div>
                        
                        <div id="addUserForm" class="card mb-3 hidden bg-light border-primary border-dashed animate-fade-in"><div class="card-body"><h6 class="fw-bold mb-3" id="formUserTitle">User Baru / Edit</h6><form onsubmit="addUserManual(event)"><input type="hidden" id="editUserId"><div class="row g-2 mb-2"><div class="col-4"><input type="text" id="addName" class="form-control form-control-sm" placeholder="Nama" required></div><div class="col-4"><input type="email" id="addEmail" class="form-control form-control-sm" placeholder="Email" required></div><div class="col-4"><input type="text" id="addPhone" class="form-control form-control-sm" placeholder="No HP"></div></div><div class="row g-2 mb-2"><div class="col-4"><select id="addRole" class="form-select form-select-sm" onchange="toggleUserFields()"><option value="student">Siswa</option><option value="teacher">Guru</option><option value="admin">Admin</option></select></div><div class="col-4 student-only"><select id="addClass" class="form-select form-select-sm dynamic-class-select"><option value="" disabled selected>Kelas</option></select></div><div class="col-4 student-only"><input type="text" id="addBatch" class="form-control form-control-sm" placeholder="Thn Ajaran (24/25)"></div></div><button type="submit" class="btn btn-sm btn-primary w-100">Simpan</button></form></div></div>
                        <div class="card border-0 shadow-sm"><div class="table-responsive"><table class="table table-hover mb-0 align-middle"><thead class="table-light small"><tr><th>User</th><th>Info</th><th>Aksi</th></tr></thead><tbody id="adminUserListBody" class="small"></tbody></table></div></div>
                        <div id="adminPagination" class="d-flex justify-content-center gap-2 mt-3"></div>
                    </div>
                    <div id="adminClassSection" class="hidden"><div class="card border-0 shadow-sm"><div class="card-body"><h6 class="fw-bold mb-3">Daftar Kelas</h6><div class="input-group mb-3"><input type="text" id="newClassName" class="form-control" placeholder="Nama Kelas Baru"><button class="btn btn-primary" onclick="addClass()"><i class="fas fa-plus"></i></button></div><ul class="list-group list-group-flush" id="classListGroup"></ul></div></div></div>
                </div>
                
                <div id="tabAdminMenus" class="view-tab hidden">
                    <div id="menuListAdmin" class="mb-3"></div><button class="btn btn-primary w-100 rounded-pill mb-3" onclick="document.getElementById('addMenuForm').classList.toggle('hidden')"><i class="fas fa-plus me-1"></i> Tambah Menu</button>
                    <div id="addMenuForm" class="card hidden bg-light animate-fade-in"><div class="card-body"><form onsubmit="saveMenu(event)"><input type="hidden" id="menuId"><div class="row g-2 mb-2"><div class="col-8"><input type="text" id="menuTitle" class="form-control" placeholder="Judul" required></div><div class="col-4"><select id="menuIcon" class="form-select"><option value="fa-calendar"></option><option value="fa-book"></option><option value="fa-video"></option><option value="fa-info"></option></select></div></div><div class="row g-2 mb-2"><div class="col-4"><select id="menuRole" class="form-select"><option value="all">All</option><option value="student">Siswa</option><option value="teacher">Guru</option></select></div><div class="col-8"><input type="text" id="menuLink" class="form-control" placeholder="URL Link"></div></div><button type="submit" class="btn btn-sm btn-success w-100">Simpan</button></form></div></div>
                </div>
                
                <div id="tabAdminKeys" class="view-tab hidden"><div class="card mb-4"><div class="card-body"><h6 class="fw-bold mb-3">Manajemen Kode Registrasi</h6><form onsubmit="saveAppKeys(event)"><div class="mb-2"><label class="small text-muted">Siswa</label><input type="text" id="keyStudent" class="form-control fw-bold text-success font-monospace"></div><div class="mb-2"><label class="small text-muted">Guru</label><input type="text" id="keyTeacher" class="form-control fw-bold text-primary font-monospace"></div><div class="mb-3"><label class="small text-muted">Admin</label><input type="text" id="keyAdmin" class="form-control fw-bold text-danger font-monospace"></div><button type="submit" class="btn btn-dark w-100 rounded-pill">Update Kode</button></form></div></div><div class="card border-warning"><div class="card-header bg-warning bg-opacity-10 border-0"><h6 class="fw-bold mb-0 text-warning-emphasis"><i class="fas fa-tools me-2"></i>Admin Troubleshooting</h6></div><div class="card-body"><p class="small text-muted mb-2">Gunakan fitur ini jika ada siswa yang datanya error/stuck.</p><div class="input-group mb-2"><input type="email" id="resetUserEmail" class="form-control" placeholder="Email Siswa"><button class="btn btn-outline-danger" onclick="adminResetUserMood()">Reset Data Mood</button></div><small class="text-secondary d-block" style="font-size: 0.7rem;">*Fitur ini akan mereset status mood siswa menjadi netral.</small></div></div></div>
            </div>

        </div> <!-- End App Container -->
    </main>

    <!-- MOBILE BOTTOM NAVIGATION (For Students Only) -->
    <div id="bottomNav" class="bottom-nav hidden">
        <!-- Icons populated by JS based on role -->
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, sendPasswordResetEmail, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
		
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, query, where, onSnapshot, updateDoc, limit, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config Setup - Preserving User's provided config
        let firebaseConfig;
        try { 
             firebaseConfig = { 
                apiKey: "AIzaSyAdqApOvuUXrZUO19NfiqZCLSyUYR74w5M",
                authDomain: "waliq-ded98.firebaseapp.com",
                projectId: "waliq-ded98",
                storageBucket: "waliq-ded98.firebasestorage.app",
                messagingSenderId: "915222555864",
                appId: "1:915222555864:web:25320841c97661172e3bad",
                measurementId: "G-K51RW0YQ0M"
             };
        } 
        catch (e) { 
             firebaseConfig = { apiKey: "AIzaSy...", projectId: "waliq-ded98" }; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'waliq-app';


function updateHeroRole(role) {
    const heroRole = document.getElementById('heroRole');
    if (!heroRole) return;

    if (role === 'student') {
        heroRole.textContent = 'Siswa';
    } else if (role === 'teacher') {
        heroRole.textContent = 'Guru Wali';
    } else if (role === 'admin') {
        heroRole.textContent = 'Admin';
    } else {
        heroRole.textContent = 'Pengguna';
    }
}
        let currentUser = null;
		//tambahan
		let allStudentsCache = []; 
		let allInboxCache = [];
        let allMsgHistoryCache = []; // Cache for teacher message history
		
        let userData = null;
        let allUsersCache = []; // Cache for admin filtering
        let currentAdminFilter = 'student'; // Default filter
        let hasCheckedInToday = false;
        let todayLogId = null; // Store ID of today's log to allow deletion
        let selectedStudentChatId = null; // For Teacher to reply
        let currentStudentReportId = null; // For Teacher Report Modal
        
        // --- PAGINATION VARS ---
        let itemsPerPage = 10;
        let currentAdminPage = 1;
        let currentTeacherPage = 1;
        let currentTeacherGrade = 'X'; // Default
        let currentMsgHistoryPage = 1;

        // --- GOAL STATE MANAGEMENT ---
        let currentGoals = { x: [], xi: [], xii: [] }; // Stores plain text for Edit Tab
        let goalObjects = { x: [], xi: [], xii: [] }; // Stores objects {t, d} for Report Tab
        let reportLocked = { x: false, xi: false, xii: false }; // Stores Lock Status
        
        // NEW: Personality Evaluation State
        let personalityEvalData = {
            x: { char: {}, interest: {}, diff: {} },
            xi: { char: {}, interest: {}, diff: {} },
            xii: { char: {}, interest: {}, diff: {} }
        };

        // NEW: Final Goal State
        let finalGoalData = {
            type: "",
            reason: "",
            confidence: "",
            locked: false
        };

        // NEW: Personality State
        let personalityData = {
            char: [],
            interest: [],
            diffStudy: [],
            diffLife: []
        };

        let teacherNoteVal = "";
        let teacherSkillNoteVal = ""; // For Skill Note
        let studentClassLevel = 10; // Default X
        let achievementsList = []; // State for Achievements
        let organizationList = []; // State for Organization
        let activeReportTab = 'x'; // Default tab for student report
        let skillsList = { owned: [], wanted: [] }; // State for Skills
        
        // Dynamic Keys Default
        let APP_KEYS = { student: 'WALI2025', teacher: 'GURU2025', admin: 'ADMIN2025' };
        
        // Classes Default
        let classList = [
            "X TKJ 1", "X TKJ 2", 
            "XI TKJ 1", "XI TKJ 2", 
            "XII TKJ 1", "XII TKJ 2"
        ];

        // Helper to get Avatar URL safely
        function getAvatarUrl(avatarVal, role='student') {
            if(!avatarVal) avatarVal = 'male';
            if(avatarVal.startsWith('data:image')) return avatarVal;

            if(role === 'student') {
                if(avatarVal === 'female') return `https://api.dicebear.com/9.x/avataaars/svg?seed=HijabGirl&top=hijab&accessories=glasses`;
                return `https://api.dicebear.com/9.x/avataaars/svg?seed=Felix`;
            }
            if(role === 'teacher' || role === 'admin') {
                if(avatarVal === 'female') return `https://api.dicebear.com/9.x/avataaars/svg?seed=Teresa&top=hijab`;
                return `https://api.dicebear.com/9.x/avataaars/svg?seed=Caleb&facialHair=beardLight`;
            }
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${avatarVal}`;
        }

        // Init
        async function initApp() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e){}
            }
            fetchAppKeys();
            loadClasses();
			loadStudentActivityLogs();
        }
        initApp();
		
		
		// --- FUNGSI BARU: CATAT AKTIVITAS SISWA ---
async function logUserActivity(actionDetails) {
    if (!currentUser || userData.role !== 'student') return;
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activity_logs'), {
            studentUid: currentUser.uid,
            studentName: userData.name,
            studentClass: userData.class,
            action: actionDetails,
            timestamp: new Date().toISOString()
        });
        console.log("Aktivitas tercatat:", actionDetails);
    } catch (e) {
        console.error("Gagal mencatat aktivitas", e);
    }
}


        // --- HELPERS ---
        const show = (id) => document.getElementById(id)?.classList.remove('hidden');
        const hide = (id) => document.getElementById(id)?.classList.add('hidden');
        const getVal = (id) => document.getElementById(id)?.value;
        const setVal = (id, v) => { if(document.getElementById(id)) document.getElementById(id).value = v; };

        // Toggle Sidebar
        window.toggleSidebar = () => {
            document.getElementById('mainSidebar').classList.toggle('active');
            document.getElementById('mobileOverlay').classList.toggle('active');
        };

        window.togglePassword = (id, el) => {
            const inp = document.getElementById(id);
            const icon = el.querySelector('i');
            if(inp.type==='password'){ inp.type='text'; icon.classList.replace('fa-eye','fa-eye-slash'); }
            else { inp.type='password'; icon.classList.replace('fa-eye-slash','fa-eye'); }
        }

        // --- MOOD & MODAL LOGIC (FIXED) ---
        window.closeMoodModal = () => {
          const modal = document.getElementById('moodModalOverlay');
          modal.classList.remove('active');
          modal.classList.add('hidden'); // Fix: Add hidden back to remove from layout
          modal.style.opacity = '0';
          modal.style.visibility = 'hidden';
          console.log('Modal closed');
        };

        window.actionMoodModal = () => {
            closeMoodModal();
            window.switchTab('tabStudentCurhat', document.querySelector('.nav-icon[data-target="tabStudentCurhat"]'));
            if(document.getElementById('chatCategory')) document.getElementById('chatCategory').value = 'Curhat';
        };

        window.handleMoodClick = async (mood) => {
            if(hasCheckedInToday) return;

            const modal = document.getElementById('moodModalOverlay');
            const title = document.getElementById('moodModalTitle');
            const body = document.getElementById('moodModalBody');
            const icon = document.getElementById('moodModalIcon');

            if(mood === 'sad') {
                icon.innerHTML = '<i class="fas fa-frown fa-3x text-danger"></i>';
                title.innerText = "Ceritakan masalahmu";
                body.innerText = "Jangan dipendam sendiri. Ceritakan masalahmu di sini ya, kami siap mendengar.";
            } 
			else if (mood === 'angry') {
			    icon.innerHTML = '<i class="fas fa-angry fa-3x text-dark"></i>'; 
                title.innerText = "Tarik nafas, Istighfar!";
                body.innerText = "Emosi itu wajar, tapi jangan biarkan menguasaimu. Ceritakan apa yang membuatmu kesal?";
            }
			else if(mood === 'happy') {
                icon.innerHTML = '<i class="fas fa-smile fa-3x text-success"></i>';
                title.innerText = "Wah, Senangnya!";
                body.innerText = "Kamu bisa berbagi kebahagianmu di chat.";
            } else {
                icon.innerHTML = '<i class="fas fa-meh fa-3x text-warning"></i>';
                title.innerText = "Hari yang Tenang";
                body.innerText = "Apakah ada hal yang ingin kamu ceritakan?";
            }
            
            modal.classList.remove('hidden');
			modal.classList.add('active');			
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
          
            console.log('Modal shown');

            let score = 50;
            if(mood === 'sad') score = 20;
            else if(mood === 'happy') score = 90;
            else if(mood === 'angry') score = 30; // Added logic for angry
            
            try {
                // Background update: Update main doc AND push to history array
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { 
                    mood: score,
                    //  MODIFICATION: Save history for teacher recap
                    mood_history: arrayUnion(mood)
					
                });
                // Di dalam handleMoodClick, setelah await updateDoc(...)

// BERIKAN REWARD KOIN
rewardPetCoins(50); // Dapat 50 koin setiap check-in mood
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'mood_logs'), {
                    mood: mood,
                    timestamp: new Date().toISOString()
                });
				// Di dalam handleMoodClick(), setelah simpan mood:
					logUserActivity(`Melakukan Check-in Mood: ${mood}`);
					
            } catch(e) { console.error("Mood Save Error", e); }
        };

        let moodUnsub = null;

        function loadMoodHistory() {
            if(moodUnsub) moodUnsub();
            const container = document.getElementById('moodHistoryList');
            container.innerHTML = '<div class="text-muted small">Memuat data...</div>';

            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'mood_logs'));
            
            moodUnsub = onSnapshot(q, (snapshot) => {
                let rawLogs = [];
                snapshot.forEach(d => rawLogs.push({ id: d.id, ...d.data() })); 
                
                rawLogs.sort((a,b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA;
                });

                const uniqueLogs = [];
                const seenDates = new Set();
                
                rawLogs.forEach(log => {
                    const d = new Date(log.timestamp).toDateString();
                    if(!seenDates.has(d)) {
                        seenDates.add(d);
                        uniqueLogs.push(log);
                    }
                });
                
                hasCheckedInToday = false; 
                todayLogId = null; 
                
                if (rawLogs.length > 0) {
                    const latestLog = rawLogs[0];
                    if (latestLog.timestamp) {
                        const lastLogDate = new Date(latestLog.timestamp).toDateString();
                        const todayDate = new Date().toDateString();
                        
                        if (lastLogDate === todayDate) {
                            hasCheckedInToday = true;
                            document.getElementById('moodStatusBadge').innerText = "Sudah Check-in";
                            document.getElementById('moodStatusBadge').classList.replace('bg-light', 'bg-success');
                            document.getElementById('moodStatusBadge').classList.replace('text-dark', 'text-white');
                            show('btnResetTodayMood'); 
                            
                            ['btnMoodAngry', 'btnMoodSad', 'btnMoodNeutral', 'btnMoodHappy'].forEach(id => {
                                const btn = document.getElementById(id);
                                if(btn) {
                                    btn.disabled = true;
                                    btn.classList.remove('selected-mood');
                                }
                            });

                            const todaysMood = latestLog.mood;
                            if(todaysMood === 'sad') document.getElementById('btnMoodSad')?.classList.add('selected-mood');
                            if(todaysMood === 'angry') document.getElementById('btnMoodAngry')?.classList.add('selected-mood');
                            if(todaysMood === 'neutral') document.getElementById('btnMoodNeutral')?.classList.add('selected-mood');
                            if(todaysMood === 'happy') document.getElementById('btnMoodHappy')?.classList.add('selected-mood');
                        } else {
                            resetMoodButtons();
                        }
                    } else {
                         resetMoodButtons();
                    }
                } else {
                    resetMoodButtons();
                }

                const historyLogs = uniqueLogs.slice(0, 7); 
                let h = '';
                if(historyLogs.length === 0) h = '<div class="text-muted small">Belum ada data.</div>';
                else {
                    historyLogs.forEach(l => {
                        let icon = 'fa-meh text-warning';
                        if(l.mood === 'sad') icon = 'fa-frown text-danger';
                        if(l.mood === 'happy') icon = 'fa-smile text-success';
                        if(l.mood === 'angry') icon = 'fa-angry text-dark';
                        
                        const date = l.timestamp ? new Date(l.timestamp) : new Date();
                        const day = date.toLocaleDateString('id-ID', { weekday: 'short' });
                        h += `<div class="d-flex flex-column align-items-center me-3"><div class="mood-item-history shadow-sm mb-1"><i class="fas ${icon}"></i></div><small class="text-muted" style="font-size: 0.65rem;">${day}</small></div>`;
                    });
                }
                if(container) container.innerHTML = h;

            }, (error) => {
                console.error("Error fetching mood logs:", error);
                if(container) container.innerHTML = '<div class="text-danger small"><i class="fas fa-exclamation-circle"></i> Gagal memuat data.</div>';
            });
        }

        function resetMoodButtons() {
            hasCheckedInToday = false;
            todayLogId = null;
            document.getElementById('moodStatusBadge').innerText = "Belum Check-in";
            document.getElementById('moodStatusBadge').classList.replace('bg-success', 'bg-light');
            document.getElementById('moodStatusBadge').classList.replace('text-white', 'text-dark');
            hide('btnResetTodayMood');
            
            ['btnMoodAngry', 'btnMoodSad', 'btnMoodNeutral', 'btnMoodHappy'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.disabled = false;
                    btn.classList.remove('selected-mood');
                }
            });
        }
        
        window.resetMoodToday = async () => {
            if(!confirm("Hapus log mood hari ini?")) return;
            try {
                const todayStr = new Date().toDateString();
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'mood_logs'));
                const snapshot = await getDocs(q);
                
                const deletePromises = [];
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.timestamp && new Date(data.timestamp).toDateString() === todayStr) {
                         deletePromises.push(deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'mood_logs', docSnap.id)));
                    }
                });
                
                await Promise.all(deletePromises);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { mood: 50 });
            } catch(e) {
                alert("Gagal reset: " + e.message);
            }
        };

        window.adminResetUserMood = async () => {
            const email = getVal('resetUserEmail');
            if(!email) return alert("Masukkan email siswa");
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('email', '==', email));
                const snap = await getDocs(q);
                if(snap.empty) { alert("User tidak ditemukan."); return; }
                const userDoc = snap.docs[0];
                if(!confirm(`Reset data mood untuk user: ${userDoc.data().name}?`)) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userDoc.id), { mood: 50 });
                alert("Data mood berhasil di-reset menjadi Netral (50).");
                setVal('resetUserEmail', '');
            } catch(e) { alert("Error: " + e.message); }
        };


        // --- NAVIGATION LOGIC ---
        window.switchTab = (tabId, navEl) => {
            document.querySelectorAll('.view-tab').forEach(el => el.classList.add('hidden'));
            show(tabId);
			if (tabId === 'tabStudentCurhat' && currentUser) {
                initChatListener(currentUser.uid);
            }
            const activeLink = navEl?.getAttribute('data-target') || tabId;
            document.querySelectorAll('.nav-item-link, .nav-icon').forEach(el => {
                if(el.getAttribute('data-target') === activeLink) el.classList.add('active');
                else el.classList.remove('active');
            });
            if(window.innerWidth < 992) {
                document.getElementById('mainSidebar').classList.remove('active');
                document.getElementById('mobileOverlay').classList.remove('active');
            }
			if(tabId === 'tabStudentPet') {
        updatePetUI(); // Refresh tampilan pet saat tab dibuka
    }
        };

        function renderNavigation(role) {
            const sidebar = document.getElementById('sidebarLinks');
            const bottom = document.getElementById('bottomNav');
            let links = [];

            if(role === 'student') {
                links = [
				
                    { id: 'tabStudentHome', icon: 'fa-home', label: 'Home' },
                    // NEW: Personality Menu
					{ id: 'tabStudentPet', icon: 'fa-paw', label: 'Peliharaan' }, // <--- TAMBAHKAN INI
					{ id: 'tabStudentPolling', icon: 'fa-poll', label: 'Suara Siswa' },
                    { id: 'tabStudentPersonality', icon: 'fa-fingerprint', label: 'Personality' },
                    { id: 'tabStudentGoals', icon: 'fa-bullseye', label: 'Goals' },
                    { id: 'tabStudentAchievements', icon: 'fa-trophy', label: 'Prestasi' },
                    { id: 'tabStudentOrg', icon: 'fa-sitemap', label: 'Organisasi' },
                    { id: 'tabStudentSkills', icon: 'fa-lightbulb', label: 'Keahlian' },
                    { id: 'tabStudentReport', icon: 'fa-chart-pie', label: 'Raport' },
					// Di dalam renderNavigation, ganti baris links untuk student bagian Curhat:
					{ id: 'tabStudentCurhat', icon: 'fa-comment-dots', label: 'Inbox & Chat <span id="studentInboxBadge" class="badge bg-danger rounded-pill ms-2 hidden" style="font-size:0.6rem">0</span>' },
                    //{ id: 'tabStudentCurhat', icon: 'fa-comment-dots', label: 'Inbox & Chat' },
                    { id: 'tabStudentProfile', icon: 'fa-user', label: 'Profil' }
                ];
            } else if(role === 'teacher') {
    links = [
         //{ id: 't_home', icon: 'fa-home', label: 'Beranda' },
		 // Cari baris ini di dalam renderNavigation bagian teacher:
{ id: 't_home', icon: 'fa-home', label: 'Beranda', func: 'loadStudentActivityLogs' }, 
// (Tambahkan func: 'loadStudentActivityLogs' agar otomatis refresh saat tab diklik)
         { id: 't_students', icon: 'fa-users', label: 'Data Siswa', func: 'fetchStudents' },
         { id: 't_daily_msg', icon: 'fa-bullhorn', label: 'Pesan Harian', func: 'loadMessageHistory' }, // NEW
         { id: 't_inbox', icon: 'fa-envelope', label: 'Inbox', func: 'loadTeacherInbox' },
		 { id: 't_polling', icon: 'fa-chart-bar', label: 'Polling', func: 'loadTeacherPolls' },
         { id: 't_profile', icon: 'fa-user-circle', label: 'Profil Saya', func: 'loadTeacherProfile' }
    ];
            } else if (role === 'admin') {
                links = [
                    { id: 'tabAdminHome', icon: 'fa-home', label: 'Beranda', func: 'loadAdminHome' }, // NEW
                    { id: 'tabAdminUsers', icon: 'fa-users-cog', label: 'Manajemen User', func: 'loadAdminDashboard' },
                    { id: 'tabAdminMenus', icon: 'fa-list', label: 'Manajemen Menu', func: 'loadAdminMenus' },
                    { id: 'tabAdminKeys', icon: 'fa-key', label: 'Manajemen Key', func: 'loadAppKeys' }
                ];
            }

            let sbHtml = '', bnHtml = '';
            links.forEach(l => {
                const funcCall = l.func ? `${l.func}();` : '';
                sbHtml += `<a href="#" class="nav-item-link" data-target="${l.id}" onclick="switchTab('${l.id}', this); ${funcCall}"><i class="fas ${l.icon}"></i> ${l.label}</a>`;
                bnHtml += `<div class="nav-icon" data-target="${l.id}" onclick="switchTab('${l.id}', this); ${funcCall}"><i class="fas ${l.icon}"></i><span>${l.label}</span></div>`;
            });
            sidebar.innerHTML = sbHtml;
			
			// --- UPDATE: SELALU SEMBUNYIKAN BOTTOM NAV (REQUEST USER) ---
            bottom.innerHTML = ''; 
            hide('bottomNav'); 
			
			
            if(role === 'student') {
               // bottom.innerHTML = bnHtml;
                //show('bottomNav');
                setTimeout(() => window.switchTab(links[0].id, null), 100);
            } else {
                //bottom.innerHTML = '';
                //hide('bottomNav');
                setTimeout(() => {
                    window.switchTab(links[0].id, null);
                    // UPDATE: Panggil loadAdminHome jika admin
                    if(role === 'admin') loadAdminHome();
                    if(role === 'teacher') { loadDynamicMenus('teacher'); fetchStudents(); }
                }, 100);
            }
        }

        // --- AUTH ---
        window.toggleAuth = (t) => {
            hide('loginForm'); hide('registerForm'); hide('forgotForm');
            show(t + 'Form');
            if(t==='register') {
                document.getElementById('regKey').addEventListener('keyup', (e) => {
                    const v = e.target.value;
                    hide('studentFields'); hide('staffFields');
                   if (v === APP_KEYS.student) {
    show('studentFields');

    //  LOAD GURU WALI DI SINI
    loadGuruFromDatabase('signupTeacher');

} else if (v === APP_KEYS.teacher || v === APP_KEYS.admin) {
    show('staffFields');
}
                });
            }
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const sidebar = document.getElementById('mainSidebar');
            const mainContent = document.getElementById('mainContentArea');

            if (user) {
                hide('authSection');
                show('appContainer');
                show('mobileTopNav'); 
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('no-sidebar');
                
                try {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid));
                    if (snap.exists()) {
                        userData = snap.data();
						//  TAMBAHAN INI
						updateHeroRole(userData.role);
                        updateUI(userData);
						
						
						if (userData.role === 'teacher') {
							//updateInboxBadge(0); // default
							//listenInboxTeacher(); // realtime listener
							initTeacherInbox();
}

						
                    }
                } catch (e) { console.error(e); }
            } else {
                show('authSection');
                hide('appContainer');
                hide('mobileTopNav');
                hide('bottomNav');
                sidebar.classList.add('hidden');
                mainContent.classList.add('no-sidebar');
            }
        });

        function updateUI(u) {
            document.getElementById('heroName').innerText = u.name;
            document.getElementById('sidebarName').innerText = u.name;
            document.getElementById('mobileWelcome').innerText = `Hi, ${u.name.split(' ')[0]}`;
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });
            document.getElementById('heroDate').innerText = dateStr;
            
            const ava = getAvatarUrl(u.avatar, u.role);
            document.getElementById('heroAvatar').src = ava;
            document.getElementById('sidebarAvatar').src = ava;

            hide('studentView'); hide('teacherView'); hide('adminView');
            renderNavigation(u.role); 

            if(u.role === 'admin') show('adminView');
            else if(u.role === 'teacher') show('teacherView');
            else show('studentView');
            loadStudentDashboard();
        }

        window.handleLogin = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, getVal('loginEmail'), getVal('loginPassword')); }
            catch(e) { alert(e.message); }
        };

        window.handleRegister = async (e) => {
            e.preventDefault();
            const key = getVal('regKey');
            let role = '', name = '';
            if(key === APP_KEYS.student) { role='student'; name=getVal('regNameStudent'); }
            else if(key === APP_KEYS.teacher) { role='teacher'; name=getVal('regNameStaff'); }
            else if(key === APP_KEYS.admin) { role='admin'; name=getVal('regNameStaff'); }
            else return alert('Kode Salah');

            const email = getVal('regEmail');
            const password = getVal('regPassword');

            const userDataPayload = { email: email, role, name: name||'User', createdAt: new Date().toISOString() };
            if(role === 'student') {
                userDataPayload.class = getVal('regClass'); 
                userDataPayload.batch = getVal('regBatch');
                userDataPayload.teacherUid = getVal('signupTeacher'); // SAVE SELECTED TEACHER
                userDataPayload.avatar = 'male'; 
                userDataPayload.mood = 50;
            }

            try {
                const c = await createUserWithEmailAndPassword(auth, email, password);
                userDataPayload.uid = c.user.uid;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', c.user.uid), userDataPayload);
                window.location.reload();
            } catch(e) { 
                if (e.code === 'auth/email-already-in-use') {
                    try {
                        const loginCred = await signInWithEmailAndPassword(auth, email, password);
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', loginCred.user.uid));
                        if (!snap.exists()) {
                            userDataPayload.uid = loginCred.user.uid;
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', loginCred.user.uid), userDataPayload);
                            alert("Akun lama ditemukan. Data berhasil diperbarui!");
                            window.location.reload();
                        } else {
                            alert("Email sudah terdaftar dan akun masih aktif. Silakan Login.");
                            toggleAuth('login');
                        }
                    } catch (loginErr) {
                         alert("Email sudah terdaftar. Silakan login. Jika data dihapus admin, gunakan password lama Anda untuk mengaktifkan kembali.");
                    }
                } else {
                    alert(e.message);
                }
            }
        };

        window.logout = () => { signOut(auth); window.location.reload(); };

        // --- KEY MANAGMENT ---
        async function fetchAppKeys() {
            try {
                const s = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'keys'));
                if(s.exists()) APP_KEYS = { ...APP_KEYS, ...s.data() };
            } catch(e){}
        }
        window.loadAppKeys = () => {
            setVal('keyStudent', APP_KEYS.student);
            setVal('keyTeacher', APP_KEYS.teacher);
            setVal('keyAdmin', APP_KEYS.admin);
        };
        window.saveAppKeys = async(e) => {
            e.preventDefault();
            const k = { student: getVal('keyStudent'), teacher: getVal('keyTeacher'), admin: getVal('keyAdmin') };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'keys'), k);
            APP_KEYS = k; alert('Kode Disimpan');
        };

        // --- CLASS MANAGEMENT ---
        async function loadClasses() {
            try {
                const s = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'classes'));
                if(s.exists()) {
                    classList = s.data().list || classList;
                }
            } catch(e) {}
            populateClassSelects();
        }

        function populateClassSelects() {
            const selects = document.querySelectorAll('.dynamic-class-select');
            selects.forEach(sel => {
                sel.innerHTML = '<option value="" disabled selected>Pilih Kelas</option>' + 
                    classList.map(c => `<option value="${c}">${c}</option>`).join('');
            });
        }

        window.renderClassAdminList = () => {
            const listEl = document.getElementById('classListGroup');
            listEl.innerHTML = classList.map(c => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${c}
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteClass('${c}')"><i class="fas fa-trash"></i></button>
                </li>
            `).join('');
        };

        window.addClass = async () => {
            const newClass = getVal('newClassName');
            if(!newClass) return alert('Nama kelas harus diisi');
            if(classList.includes(newClass)) return alert('Kelas sudah ada');
            
            classList.push(newClass);
            classList.sort();
            await saveClassesToDB();
            setVal('newClassName', '');
            window.renderClassAdminList();
            populateClassSelects();
        };

        window.deleteClass = async (cls) => {
            if(!confirm(`Hapus kelas ${cls}?`)) return;
            classList = classList.filter(c => c !== cls);
            await saveClassesToDB();
            window.renderClassAdminList();
            populateClassSelects();
        };

        async function saveClassesToDB() {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'classes'), { list: classList });
            } catch(e) { alert('Gagal update kelas: ' + e.message); }
        }

        // --- ADMIN: USERS & MENUS ---
        // NEW Function for Admin Home
        window.loadAdminHome = async () => {
           // Reuse cache if available or fetch
           const qUsers = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
           // For simplicity and to ensure fresh count on load:
           const snapUsers = await getDocs(qUsers);
           let sCount = 0, tCount = 0;
           snapUsers.forEach(d => {
               if(d.data().role === 'student') sCount++;
               if(d.data().role === 'teacher') tCount++;
           });
           
           document.getElementById('statStudentCount').innerText = sCount;
           document.getElementById('statTeacherCount').innerText = tCount;
           
           // Messages count (optional, can be expensive if many docs)
           // For now just put placeholder or fetch all
           const qMsg = query(collection(db, 'artifacts', appId, 'public', 'data', 'curhat_messages'));
           const snapMsg = await getDocs(qMsg);
           document.getElementById('statMsgCount').innerText = snapMsg.size;
        };

        window.loadAdminDashboard = async () => {
            // Pastikan tampilan kembali ke list user (jika sebelumnya buka data kelas)
            show('adminUserSection');
            hide('adminClassSection');
            
            // Reset tab active ke 'Siswa'
            const tabs = document.querySelectorAll('#adminUserSubTabs .nav-link');
            tabs.forEach(t => t.classList.remove('active'));
            if(tabs[0]) tabs[0].classList.add('active');
            currentAdminFilter = 'student';
            currentAdminPage = 1; // RESET PAGE

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            const s = await getDocs(q);
            allUsersCache = []; // Reset cache
            let total = 0;
            s.forEach(d => {
                allUsersCache.push({id: d.id, ...d.data()});
                total++;
            });
            renderAdminUserTable();
        };

        // New Logic to handle User Sub-Tabs and Class Management View
        window.openUserList = (role, el) => {
            show('adminUserSection');
            hide('adminClassSection');
            updateSubTabActive(el);
            filterAdminUserList(role);
        };

        window.openClassManager = (el) => {
            hide('adminUserSection');
            show('adminClassSection');
            updateSubTabActive(el);
            renderClassAdminList();
        };

        function updateSubTabActive(el) {
            document.querySelectorAll('#adminUserSubTabs .nav-link').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        window.filterAdminUserList = (role) => {
            currentAdminFilter = role;
            currentAdminPage = 1; // RESET PAGE
            renderAdminUserTable();
        }
        
        // --- ADMIN PAGINATION HELPER ---
        window.changeAdminPage = (newPage) => {
            currentAdminPage = newPage;
            renderAdminUserTable();
        }

        function renderAdminUserTable() {
            let h = '';
            const filtered = allUsersCache.filter(u => u.role === currentAdminFilter);
            
            // PAGINATION LOGIC
            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            if (currentAdminPage > totalPages) currentAdminPage = totalPages || 1;

            const start = (currentAdminPage - 1) * itemsPerPage;
            const paginated = filtered.slice(start, start + itemsPerPage);

            if(paginated.length === 0) h = `<tr><td colspan="3" class="text-center text-muted py-3">Tidak ada data ${currentAdminFilter}</td></tr>`;
            
            paginated.forEach(u => {
                h += `<tr>
                    <td>
                        <div class="fw-bold">${u.name}</div>
                        <small class="text-muted">${u.email}</small>
                        <div class="small text-primary">${u.phone||'-'}</div>
                    </td>
                    <td>
                        <span class="badge bg-${u.role==='student'?'success':(u.role==='admin'?'danger':'primary')}">${u.role}</span> 
                        <div class="small text-muted">${u.class||''} ${u.batch ? '('+u.batch+')' : ''}</div>
                    </td>
                    <td>
                        <button onclick="editUser('${u.id}','${u.name}','${u.email}','${u.role}','${u.class||''}','${u.batch||''}','${u.phone||''}')" class="btn btn-sm btn-light text-warning"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteUser('${u.id}')" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            document.getElementById('adminUserListBody').innerHTML = h;

            // RENDER PAGINATION BUTTONS
            renderPaginationControls('adminPagination', currentAdminPage, totalPages, 'changeAdminPage');
        }

        // --- GENERIC PAGINATION UI RENDERER ---
        function renderPaginationControls(containerId, currentPage, totalPages, funcName) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
                <button class="btn btn-sm btn-outline-primary" ${currentPage === 1 ? 'disabled' : ''} onclick="${funcName}(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="d-flex align-items-center px-2 text-muted small">Hal ${currentPage} dari ${totalPages}</span>
                <button class="btn btn-sm btn-outline-primary" ${currentPage === totalPages ? 'disabled' : ''} onclick="${funcName}(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            container.innerHTML = html;
        }

        window.toggleUserFields = () => {
            const role = getVal('addRole');
            const studentFields = document.querySelectorAll('.student-only');
            studentFields.forEach(el => el.style.display = role === 'student' ? 'block' : 'none');
        };

        window.addUserManual = async (e) => {
            e.preventDefault();
            const id = getVal('editUserId');
            const d = { name: getVal('addName'), email: getVal('addEmail'), role: getVal('addRole'), phone: getVal('addPhone') };
            if(d.role === 'student') { d.class = getVal('addClass'); d.batch = getVal('addBatch'); }
            
            try {
                if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), d);
                else {
                    const uid = 'm_' + Math.random().toString(36).substr(2,9);
                    d.uid = uid; d.createdAt = new Date().toISOString();
                    if(d.role==='student') { d.mood=50; d.avatar='male'; }
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), d);
                }
                alert('Tersimpan'); loadAdminDashboard();
                document.getElementById('addUserForm').classList.add('hidden');
                setVal('editUserId','');
            } catch(e) { alert(e.message); }
        };

        window.editUser = (id,n,e,r,c,b,p) => {
            setVal('editUserId', id); setVal('addName', n); setVal('addEmail', e);
            setVal('addRole', r); setVal('addPhone', p);
            // Set fields if role is student
            if(r === 'student') {
                setVal('addClass', c); setVal('addBatch', b);
            }
            toggleUserFields(); // Show/hide fields based on role
            document.getElementById('formUserTitle').innerText = 'Edit User';
            show('addUserForm');
        };
        
        window.deleteUser = async(id) => {
            if(confirm('Hapus Data User? (Login Auth akan tetap aktif)')) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id)); loadAdminDashboard(); }
        };

        // Menus
        window.loadAdminMenus = async () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'menus'));
            const s = await getDocs(q);
            let h = '<div class="list-group list-group-flush">';
            s.forEach(d => {
                const m = d.data();
                h += `<div class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                    <div><i class="fas ${m.icon} me-2 text-primary"></i>${m.title} <span class="badge bg-light text-dark">${m.role}</span></div>
                    <div><button onclick="editMenu('${d.id}','${m.title}','${m.role}','${m.icon}','${m.link}')" class="btn btn-sm text-warning"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteMenu('${d.id}')" class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button></div></div>`;
            });
            document.getElementById('menuListAdmin').innerHTML = h + '</div>';
        };

        window.saveMenu = async(e) => {
            e.preventDefault();
            const id = getVal('menuId');
            const d = { title: getVal('menuTitle'), role: getVal('menuRole'), icon: getVal('menuIcon'), link: getVal('menuLink') };
            if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'menus', id), d);
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'menus'), d);
            alert('Menu Saved'); loadAdminMenus(); hide('addMenuForm');
        };
        
        window.editMenu = (id,t,r,i,l) => {
            setVal('menuId', id); setVal('menuTitle', t); setVal('menuRole', r);
            setVal('menuIcon', i); setVal('menuLink', l);
            show('addMenuForm');
        };
        
        window.deleteMenu = async(id) => { if(confirm('Del?')) { await deleteDoc(doc(db,'artifacts',appId,'public','data','menus',id)); loadAdminMenus(); }};

        // --- STUDENT LOGIC ---
        async function loadStudentDashboard() {
            if(userData) {
                document.getElementById('dispClass').innerText = userData.class || '-';
                document.getElementById('dispHobby').innerText = userData.batch || '-'; 
                document.getElementById('dispDream').innerText = userData.dream || '-';
                setVal('editName', userData.name||''); 
                setVal('editHobby', userData.hobby||''); 
                setVal('editDream', userData.dream||'');
                setVal('editAddress', userData.address||''); 
                setVal('editPhone', userData.phone||'');
                
                // Set teacher dropdown in profile if exists
                loadGuruFromDatabase('editTeacherSelect');
                if(userData.teacherUid) {
                    setTimeout(() => setVal('editTeacherSelect', userData.teacherUid), 1500); // Delay for options to load
                }
                
                const currentAvatar = userData.avatar || 'male';
                setVal('editAvatarValue', currentAvatar);
                document.getElementById('previewAvatar').src = getAvatarUrl(currentAvatar, 'student');
                highlightAvatarOption(currentAvatar);

                loadGoals(currentUser.uid); 
                loadAchievements(currentUser.uid); 
                loadOrganizations(currentUser.uid); 
                loadSkills(currentUser.uid);
                loadPersonality(currentUser.uid); // NEW: Load Personality
                initChatListener(currentUser.uid);
                loadMoodHistory();
				initPetSystem();
                
                // NEW: Load Teacher Info & Greeting
                if(userData.teacherUid) {
                    loadTeacherInfo(userData.teacherUid);
                    loadTeacherGreeting(userData.teacherUid);
                } else {
                    document.getElementById('myTeacherInfo').innerHTML = '<div class="text-danger small">Belum ada Guru Wali. Silakan pilih di menu "Edit Profil" diatas.</div>';
                }
				// Di dalam loadStudentDashboard(), paling bawah:
			logUserActivity("Login ke Aplikasi");
            }
			
        }
        
       





	   // NEW: Load Teacher Profile in Profile Tab
        async function loadTeacherInfo(teacherUid) {
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', teacherUid));
                if(snap.exists()) {
                    const t = snap.data();
                    const ava = getAvatarUrl(t.avatar, 'teacher');
                    document.getElementById('myTeacherInfo').innerHTML = `
                        <img src="${ava}" class="rounded-circle border" width="50" height="50" style="object-fit:cover;">
                        <div>
                            <div class="fw-bold text-dark">${t.name}</div>
                            <div class="small text-muted">Guru Wali</div>
                        </div>
                    `;
                    // Also set greeting widget details
                    document.getElementById('greetTeacherAvatar').src = ava;
                    document.getElementById('greetTeacherName').innerText = t.name;
                }
            } catch(e) { console.error("Err loading teacher", e); }
        }

        // NEW: Load Greeting
        async function loadTeacherGreeting(teacherUid) {
            if(!teacherUid) return; // Guard clause
            
            try {
                // Get messages from this teacher
                // Hapus orderBy untuk menghindari error index Firestore
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'daily_messages'), 
                    where('senderUid', '==', teacherUid)
                );
                
                const snap = await getDocs(q);
                if(!snap.empty) {
                    // Manual Sort in JS (Newest First / Descending)
                    let msgs = [];
                    snap.forEach(d => {
                        const m = d.data();
                        // FILTER HERE: Show if TARGET is ALL or MyUID
                        if(m.targetUid === 'ALL' || m.targetUid === currentUser.uid) {
                            msgs.push(m);
                        }
                    });
                    
                    if(msgs.length > 0) {
                        msgs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        const msg = msgs[0]; // Ambil pesan paling baru
                        
                        // Show Widget & Fill Data
                        const widget = document.getElementById('teacherGreetingWidget');
                        if(widget) {
                            // Pastikan data guru (Avatar/Nama) sudah termuat sebelumnya lewat loadTeacherInfo
                            // Tapi kita set lagi disini untuk memastikan
                            const tAvatar = document.getElementById('greetTeacherAvatar');
                            if(tAvatar && !tAvatar.src) {
                                // Fallback jika avatar belum ada, pakai icon default sementara
                                tAvatar.src = "https://api.dicebear.com/9.x/avataaars/svg?seed=Teacher";
                            }
                            
                            document.getElementById('greetMessage').innerText = `"${msg.body}"`;
                            
                            // Format Time nice
                            const d = new Date(msg.timestamp);
                            const timeStr = d.toLocaleDateString('id-ID', {day:'numeric', month:'short'}) + '  ' + d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                            document.getElementById('greetTime').innerText = timeStr;
                            
                            // Munculkan widget
                            widget.classList.remove('hidden');
                        }
                    }
                }
            } catch(e) { console.error("Greeting load err", e); }
        }

        // --- NEW: PERSONALITY LOGIC ---
        async function loadPersonality(uid) {
            try {
                const s = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'personality', 'main'));
                if(s.exists()) {
                    personalityData = s.data();
                } else {
                    personalityData = { char: [], interest: [], diffStudy: [], diffLife: [] };
                }
                renderPersonalityList('char');
                renderPersonalityList('interest');
                renderPersonalityList('diffStudy');
                renderPersonalityList('diffLife');
            } catch(e) { console.error(e); }
        }

        window.renderPersonalityList = (type) => {
            let containerId = '';
            if(type === 'char') containerId = 'persCharList';
            if(type === 'interest') containerId = 'persInterestList';
            if(type === 'diffStudy') containerId = 'persDiffStudyList';
            if(type === 'diffLife') containerId = 'persDiffLifeList';
            
            const list = personalityData[type] || [];
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            list.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'goal-item-row';
                row.innerHTML = `
                    <input type="text" class="form-control goal-item-input" value="${item}" onchange="updatePersonalityItem('${type}', ${index}, this.value)" placeholder="Isi disini...">
                    <button type="button" class="goal-delete-btn" onclick="deletePersonalityItem('${type}', ${index})"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(row);
            });
        };

        window.addPersonalityRow = (type) => {
            if(!personalityData[type]) personalityData[type] = [];
            personalityData[type].push("");
            renderPersonalityList(type);
        };

        window.updatePersonalityItem = (type, index, value) => {
            personalityData[type][index] = value;
        };

        window.deletePersonalityItem = (type, index) => {
            personalityData[type].splice(index, 1);
            renderPersonalityList(type);
        };

        window.savePersonality = async (e) => {
            e.preventDefault();
            // Clean empty
            const clean = (arr) => arr.filter(t => t && t.trim() !== "");
            const dataToSave = {
                char: clean(personalityData.char),
                interest: clean(personalityData.interest),
                diffStudy: clean(personalityData.diffStudy),
                diffLife: clean(personalityData.diffLife)
            };
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'personality', 'main'), dataToSave);
                personalityData = dataToSave;
                // Re-render to show clean lists
                renderPersonalityList('char'); renderPersonalityList('interest');
                renderPersonalityList('diffStudy'); renderPersonalityList('diffLife');
                alert("Data Kepribadian Tersimpan!");
            } catch(e) { alert("Gagal simpan: " + e.message); }
        };

        // --- SKILLS LOGIC (NEW) ---
        async function loadSkills(uid, isTeacherMode=false) {
            if(!uid) return;
            const containerOwned = document.getElementById('ownedSkillsList');
            const containerWanted = document.getElementById('wantedSkillsList');
            const noteDisplay = document.getElementById('skillTeacherNoteDisplay');
            
            if(containerOwned) containerOwned.innerHTML = '<div class="text-center small text-muted">Memuat...</div>';
            
            try {
                const s = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'skills', 'main'));
                if(s.exists()) {
                    const d = s.data();
                    skillsList.owned = d.owned || [];
                    skillsList.wanted = d.wanted || [];
                    teacherSkillNoteVal = d.teacherNote || "Belum ada saran.";
                } else {
                    skillsList = { owned: [], wanted: [] };
                    teacherSkillNoteVal = "Belum ada saran.";
                }
                
                if(isTeacherMode) {
                    renderTeacherSkillsView();
                } else {
                    renderSkillsList();
                    if(noteDisplay) noteDisplay.innerText = teacherSkillNoteVal;
                }
            } catch(e) {
                console.error("Load Skills Error:", e);
            }
        }

        window.renderSkillsList = () => {
            const containerOwned = document.getElementById('ownedSkillsList');
            const containerWanted = document.getElementById('wantedSkillsList');
            
            if(!containerOwned || !containerWanted) return;

            // Render Owned
            if(skillsList.owned.length === 0) {
                containerOwned.innerHTML = '<div class="text-center small text-muted py-2">Belum ada data.</div>';
            } else {
                let h = '';
                skillsList.owned.forEach((s, idx) => {
                    h += `<div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                        <div>
                            <div class="fw-bold small">${s.name}</div>
                            <div class="text-muted" style="font-size:0.75rem">${s.level}</div>
                        </div>
                        <button class="btn btn-sm text-danger" onclick="deleteSkill(${idx}, 'owned')"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                containerOwned.innerHTML = h;
            }

            // Render Wanted
            if(skillsList.wanted.length === 0) {
                containerWanted.innerHTML = '<div class="text-center small text-muted py-2">Belum ada data.</div>';
            } else {
                let h = '';
                skillsList.wanted.forEach((s, idx) => {
                    h += `<div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-2">
                        <div>
                            <div class="fw-bold small">${s.name}</div>
                            <div class="text-primary mt-1" style="font-size:0.75rem"><i class="fas fa-arrow-right me-1"></i>${s.plan}</div>
                        </div>
                        <button class="btn btn-sm text-danger" onclick="deleteSkill(${idx}, 'wanted')"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                containerWanted.innerHTML = h;
            }
        };

        window.toggleSkillPlanField = () => {
            const type = document.getElementById('skillType').value;
            if(type === 'wanted') {
                show('skillPlanDiv'); hide('skillOwnedDiv');
                document.getElementById('skillPlan').required = true;
                document.getElementById('skillLevel').required = false;
            } else {
                hide('skillPlanDiv'); show('skillOwnedDiv');
                document.getElementById('skillPlan').required = false;
                document.getElementById('skillLevel').required = true;
            }
        };

        window.addSkill = async (e) => {
            e.preventDefault();
            const type = getVal('skillType');
            const name = getVal('skillName');
            
            if(type === 'owned') {
                const level = getVal('skillLevel');
                skillsList.owned.push({ name, level });
            } else {
                const plan = getVal('skillPlan');
                skillsList.wanted.push({ name, plan });
            }
            
            await saveSkills();
            e.target.reset();
            toggleSkillPlanField(); // Reset fields
            alert("Keahlian tersimpan!");
        };

        window.deleteSkill = async (idx, type) => {
            if(!confirm("Hapus keahlian ini?")) return;
            if(type === 'owned') skillsList.owned.splice(idx, 1);
            else skillsList.wanted.splice(idx, 1);
            await saveSkills();
        };

        async function saveSkills() {
            try {
                // Ensure we don't overwrite teacher note if student saves
                // But here we rely on local state which has teacherSkillNoteVal
                // Ideally fetching fresh might be safer but for simplicity:
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'skills', 'main'), {
                    owned: skillsList.owned,
                    wanted: skillsList.wanted,
                    teacherNote: teacherSkillNoteVal
                });
                renderSkillsList();
            } catch(e) { alert("Gagal simpan: " + e.message); }
        }

        // --- ORGANIZATIONS LOGIC ---
       // --- ORGANIZATIONS LOGIC (UPDATED) ---
        async function loadOrganizations(uid, isTeacherMode = false) {
            if(!uid) return;
            if(!isTeacherMode) {
                const container = document.getElementById('orgListContainer');
                if(container) container.innerHTML = '<div class="text-center small text-muted py-3">Memuat data...</div>';
            }
            
            try {
                const s = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'organizations', 'main'));
                organizationList = s.exists() ? (s.data().list || []) : [];
                
                if(isTeacherMode) {
                    renderTeacherOrgView(); // Fungsi baru (nanti dibuat di Langkah 4)
                } else {
                    renderOrganizations();
                }
            } catch(e) {
                console.error("Load Org Error:", e);
                if(!isTeacherMode) document.getElementById('orgListContainer').innerHTML = '<div class="text-danger small">Gagal memuat data.</div>';
            }
        }

        window.renderOrganizations = () => {
            const container = document.getElementById('orgListContainer');
            if(organizationList.length === 0) {
                container.innerHTML = '<div class="text-center small text-muted py-3">Belum ada data organisasi.</div>';
                return;
            }

            let h = '';
            organizationList.forEach((org, index) => {
                let badgeClass = 'bg-secondary';
                if(org.type === 'Intra Sekolah') badgeClass = 'bg-primary';
                if(org.type === 'Ekstra Sekolah') badgeClass = 'bg-warning text-dark';
                if(org.type === 'Luar Sekolah') badgeClass = 'bg-success';

                h += `
                <div class="ach-card" style="border-left-color: var(--secondary-color);">
                    <button class="ach-delete-btn" onclick="deleteOrganization(${index})"><i class="fas fa-trash"></i></button>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge ${badgeClass} ach-badge">${org.type}</span>
                        <small class="text-muted fw-bold">${org.year}</small>
                    </div>
                    <h6 class="fw-bold mb-1">${org.name}</h6>
                    <div class="small text-primary mb-2 fw-bold">
                        ${org.position} 
                        ${org.field ? `<span class="text-muted fw-normal ms-1">(${org.field})</span>` : ''}
                    </div>
                </div>`;
            });
            container.innerHTML = h;
        };

        window.toggleOrgField = () => {
            const val = document.getElementById('orgPosition').value;
            const fieldDiv = document.getElementById('orgFieldDiv');
            if(val === 'Pengurus' || val === 'Koordinator Seksi') {
                fieldDiv.classList.remove('hidden');
                document.getElementById('orgField').required = true;
            } else {
                fieldDiv.classList.add('hidden');
                document.getElementById('orgField').required = false;
                document.getElementById('orgField').value = '';
            }
        };

        window.addOrganization = async (e) => {
            e.preventDefault();
            const newOrg = {
                type: getVal('orgType'),
                name: getVal('orgName'),
                position: getVal('orgPosition'),
                field: getVal('orgField'),
                year: getVal('orgYear'),
                timestamp: new Date().toISOString()
            };
            
            organizationList.push(newOrg);
            organizationList.sort((a,b) => b.year - a.year);
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'organizations', 'main'), { list: organizationList });
                renderOrganizations();
                e.target.reset();
                toggleOrgField(); // Reset conditional field visibility
                alert("Organisasi berhasil ditambahkan!");
            } catch(err) {
                alert("Gagal menyimpan: " + err.message);
            }
        };

        window.deleteOrganization = async (index) => {
            if(!confirm("Hapus data organisasi ini?")) return;
            organizationList.splice(index, 1);
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'organizations', 'main'), { list: organizationList });
                renderOrganizations();
            } catch(err) {
                alert("Gagal menghapus: " + err.message);
            }
        };
        
        // --- ACHIEVEMENTS LOGIC ---
        // --- ACHIEVEMENTS LOGIC (UPDATED) ---
        async function loadAchievements(uid, isTeacherMode = false) {
            if(!uid) return;
            // Hanya bersihkan container siswa jika bukan mode guru
            if(!isTeacherMode) {
                const container = document.getElementById('achievementListContainer');
                if(container) container.innerHTML = '<div class="text-center small text-muted py-3">Memuat data...</div>';
            }
            
            try {
                const s = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'achievements', 'main'));
                achievementsList = s.exists() ? (s.data().list || []) : [];
                
                if(isTeacherMode) {
                    renderTeacherAchievementsView(); // Fungsi baru (nanti dibuat di Langkah 4)
                } else {
                    renderAchievements();
                }
            } catch(e) {
                console.error("Load Achievements Error:", e);
                if(!isTeacherMode) document.getElementById('achievementListContainer').innerHTML = '<div class="text-danger small">Gagal memuat data.</div>';
            }
        }
		
        window.renderAchievements = () => {
            const container = document.getElementById('achievementListContainer');
            if(achievementsList.length === 0) {
                container.innerHTML = '<div class="text-center small text-muted py-3">Belum ada data prestasi.</div>';
                return;
            }

            let h = '';
            achievementsList.forEach((ach, index) => {
                let badgeClass = 'bg-secondary';
                if(ach.level === 'Sekolah') badgeClass = 'bg-info';
                if(ach.level === 'Kecamatan') badgeClass = 'bg-primary';
                if(ach.level === 'Kabupaten') badgeClass = 'bg-success';
                if(ach.level === 'Provinsi') badgeClass = 'bg-warning text-dark';
                if(ach.level === 'Nasional') badgeClass = 'bg-danger';

                h += `
                <div class="ach-card">
                    <button class="ach-delete-btn" onclick="deleteAchievement(${index})"><i class="fas fa-trash"></i></button>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge ${badgeClass} ach-badge">${ach.level}</span>
                        <small class="text-muted fw-bold">${ach.year}</small>
                    </div>
                    <h6 class="fw-bold mb-1">${ach.name}</h6>
                    <div class="small text-muted mb-2">${ach.organizer}</div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-light text-dark border">${ach.rank}</span>
                        <span class="badge bg-light text-dark border">${ach.type}</span>
                    </div>
                </div>`;
            });
            container.innerHTML = h;
        };

        window.addAchievement = async (e) => {
            e.preventDefault();
            const newAch = {
                level: getVal('achLevel'),
                type: getVal('achType'),
                name: getVal('achName'),
                rank: getVal('achRank'),
                year: getVal('achYear'),
                organizer: getVal('achOrganizer'),
                timestamp: new Date().toISOString()
            };
            
            achievementsList.push(newAch);
            // Sort: Newest Year First
            achievementsList.sort((a,b) => b.year - a.year);
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'achievements', 'main'), { list: achievementsList });
                renderAchievements();
                e.target.reset();
                alert("Prestasi berhasil ditambahkan!");
            } catch(err) {
                alert("Gagal menyimpan: " + err.message);
            }
        };

        window.deleteAchievement = async (index) => {
            if(!confirm("Hapus data prestasi ini?")) return;
            achievementsList.splice(index, 1);
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'achievements', 'main'), { list: achievementsList });
                renderAchievements();
            } catch(err) {
                alert("Gagal menghapus: " + err.message);
            }
        };

        
        // Avatar Selection Logic
        window.selectAvatar = (type) => {
            setVal('editAvatarValue', type);
            document.getElementById('previewAvatar').src = getAvatarUrl(type, 'student');
            highlightAvatarOption(type);
        };

        function highlightAvatarOption(type) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.avatar-upload-label').forEach(el => el.style.borderColor = '#cbd5e1');

            if(type === 'male') document.getElementById('avOptMale').classList.add('selected');
            else if(type === 'female') document.getElementById('avOptFemale').classList.add('selected');
            else {
                document.querySelector('.avatar-upload-label').style.borderColor = 'var(--primary-color)';
            }
        }

        window.handleFileUpload = (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 500000) { // Limit 500KB
                    alert("Ukuran foto terlalu besar (Max 500KB)");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 150;
                        const MAX_HEIGHT = 150;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const resizedBase64 = canvas.toDataURL("image/jpeg", 0.7); 
                        
                        setVal('editAvatarValue', resizedBase64);
                        document.getElementById('previewAvatar').src = resizedBase64;
                        highlightAvatarOption('custom');
                    }
                    img.src = base64;
                }
                reader.readAsDataURL(file);
            }
        };
        
        window.updateProfile = async(e) => {
            e.preventDefault();
            const u = { 
                name: getVal('editName'),
                hobby: getVal('editHobby'), 
                dream: getVal('editDream'), 
                address: getVal('editAddress'), 
                phone: getVal('editPhone'), 
                avatar: getVal('editAvatarValue') 
            };
            
            // NEW: UPDATE TEACHER UID IF SELECTED
            const newTeacher = getVal('editTeacherSelect');
            if(newTeacher) u.teacherUid = newTeacher;

            await updateDoc(doc(db,'artifacts',appId,'public','data','users',currentUser.uid), u);
            alert('Profil Berhasil Diupdate!'); 
            userData = { ...userData, ...u };
            updateUI(userData);
            loadStudentDashboard();
        };

        // --- TEACHER LOGIC ---
        // 1. Fetch Students & Group by Class (X, XI, XII)
window.fetchStudents = async (gradeFilter = 'X', tabEl) => {
    // Update Tab Aktif (Visual)
    if(tabEl) {
        document.querySelectorAll('#studentGradeTabs .nav-link').forEach(l => l.classList.remove('active'));
        tabEl.classList.add('active');
    }
    if (gradeFilter) {
        currentTeacherGrade = gradeFilter;
        currentTeacherPage = 1; // Reset Page on tab switch
    }
    
    // Cek Cache (agar tidak request terus menerus)
    if(allStudentsCache.length === 0) {
        const container = document.getElementById('studentsContainer');
        container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';
        try {
            const q = query(collection(db,'artifacts',appId,'public','data','users'), where('role','==','student'));
            const s = await getDocs(q);
            allStudentsCache = [];
            s.forEach(d => allStudentsCache.push({id: d.id, ...d.data()}));
            // Populate select for messaging
            populateMessageTargets();
            renderTeacherStudents();
        } catch(e) { 
            console.error(e); 
            container.innerHTML = '<div class="text-danger">Gagal memuat data.</div>'; 
        }
    } else {
        renderTeacherStudents();
    }
};

window.changeTeacherPage = (newPage) => {
    currentTeacherPage = newPage;
    renderTeacherStudents();
}

function renderTeacherStudents() {
    const container = document.getElementById('studentsContainer');
    container.innerHTML = ''; // Reset container

    // Filter berdasarkan Angkatan (Cek string kelas dimulai dengan "X ", "XI ", dll)
    const filtered = allStudentsCache.filter(u => {
        if(!u.class) return false;
        const c = u.class.toUpperCase();
        if(currentTeacherGrade === 'X') return c.startsWith('X ') || c === 'X';
        if(currentTeacherGrade === 'XI') return c.startsWith('XI ') || c === 'XI';
        if(currentTeacherGrade === 'XII') return c.startsWith('XII ') || c === 'XII';
        return false;
    });
    
    // --- PAGINATION LOGIC TEACHER ---
    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    if(currentTeacherPage > totalPages) currentTeacherPage = totalPages || 1;

    const start = (currentTeacherPage - 1) * itemsPerPage;
    const paginated = filtered.slice(start, start + itemsPerPage);

    // Grouping: Kelompokkan siswa *yang ada di halaman ini* berdasarkan Nama Kelasnya
    const grouped = {};
    
    paginated.forEach(u => {
        const cls = u.class || 'Tanpa Kelas';
        if(!grouped[cls]) grouped[cls] = [];
        grouped[cls].push(u);
    });

    // Render HTML
    let html = '';
    const sortedClasses = Object.keys(grouped).sort();
    
    if(sortedClasses.length === 0) {
        html = '<div class="col-12 text-center text-muted fst-italic py-4">Tidak ada siswa di angkatan ini (Halaman Kosong).</div>';
    }

    sortedClasses.forEach(clsName => {
        // Header Kelas
        html += `<div class="col-12 mt-4"><h6 class="fw-bold text-primary border-bottom pb-2">${clsName} <span class="badge bg-light text-dark ms-2">${grouped[clsName].length} Siswa</span></h6></div>`;
        
        // Kartu Siswa
        grouped[clsName].forEach(u => {
            //  ANALISIS MOOD BERDASARKAN ARRAY 'mood_history' ATAU SINGLE VALUE 'mood'
            let statusClass = ''; 
            let statusText = '';
            let dominantMood = 'neutral';

            // Jika ada history (disimpan sebagai array string: ['sad', 'happy', ...])
            if (u.mood_history && Array.isArray(u.mood_history) && u.mood_history.length > 0) {
                const counts = { sad: 0, angry: 0, happy: 0, neutral: 0 };
                // Ambil 7 terakhir
                const last7 = u.mood_history.slice(-7);
                last7.forEach(m => { if(counts[m] !== undefined) counts[m]++; });
                
                // Logika Peringatan
                if (counts.sad + counts.angry > counts.happy) {
                    statusClass = 'status-danger';
                    statusText = ' SISWA PERLU PERHATIAN KHUSUS';
                    dominantMood = 'sad';
                } else if (counts.happy > (counts.sad + counts.angry + counts.neutral)) {
                        statusClass = 'status-success';
                        statusText = ' PERLU APRESIASI';
                        dominantMood = 'happy';
                }
            } 
            // Fallback: Pakai Mood Score (0-100) jika history kosong
            else {
                const score = u.mood || 50;
                if(score <= 30) {
                    statusClass = 'status-danger';
                    statusText = ' Mood Cenderung Rendah';
                } else if (score >= 80) {
                    statusClass = 'status-success';
                    statusText = ' Mood Sangat Baik';
                }
            }

            const avaUrl = getAvatarUrl(u.avatar, 'student');
            
            // Render Card
            html += `
            <div class="col-md-6 col-lg-4 student-card-item">
                <div class="card h-100 p-3 shadow-sm border ${statusClass}">
                    <div class="d-flex align-items-center gap-3">
                        <div class="position-relative">
                            <img src="${avaUrl}" class="rounded-circle border bg-white" width="50" height="50" style="object-fit:cover;">
                            <!-- Dot status online/offline style -->
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="fw-bold text-truncate student-name text-dark">${u.name}</div>
                            <div class="small text-muted">${u.class}</div>
                            ${statusText ? `<div class="mt-1 badge ${statusClass === 'status-danger' ? 'bg-danger' : 'bg-success'} text-white" style="font-size:0.65rem">${statusText}</div>` : ''}
                        </div>
                        <button class="btn btn-sm btn-light text-primary rounded-circle shadow-sm" onclick="openTeacherReport('${u.id}', '${u.name}')" title="Raport">
                            <i class="fas fa-chart-pie"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        });
    });
    
    container.innerHTML = html;
    
    // Render Pagination Controls Teacher
    renderPaginationControls('teacherPagination', currentTeacherPage, totalPages, 'changeTeacherPage');
}


        window.filterStudents = () => {
            const t = getVal('searchStudent').toLowerCase();
            document.getElementById('studentsContainer').childNodes.forEach(c=>{
                if(c.nodeType===1) c.style.display = c.innerText.toLowerCase().includes(t)?'block':'none';
            });
        };

        // --- NEW: TEACHER MESSAGE & HISTORY LOGIC ---
        function populateMessageTargets() {
            const select = document.getElementById('msgTarget');
            // Keep "All" option
            select.innerHTML = '<option value="ALL">Semua Siswa Perwalian</option>';
            // Add individuals
            allStudentsCache.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.uid; // Ensure using UID
                opt.text = `${s.name} (${s.class})`;
                select.appendChild(opt);
            });
        }

        window.sendDailyMessage = async (e) => {
            e.preventDefault();
            const target = getVal('msgTarget');
            const body = getVal('msgBody');
            const timestamp = new Date().toISOString();
            
            // Determine target Name for display history
            let targetName = 'Semua Siswa';
            if(target !== 'ALL') {
                const s = allStudentsCache.find(x => x.uid === target);
                if(s) targetName = s.name;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'daily_messages'), {
                    senderUid: currentUser.uid,
                    senderName: userData.name,
                    targetUid: target, // 'ALL' or specific UID
                    targetName: targetName,
                    body: body,
                    timestamp: timestamp
                });
                alert("Pesan Terkirim!");
                setVal('msgBody', '');
                loadMessageHistory(); // Refresh history
            } catch(e) { alert("Gagal kirim: " + e.message); }
        };

        window.loadMessageHistory = async () => {
             // Load cache
             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'daily_messages'),
                where('senderUid', '==', currentUser.uid)
                //, orderBy('timestamp', 'desc') // Requires index, sort in JS instead
             );
             
             try {
                 const snap = await getDocs(q);
                 allMsgHistoryCache = [];
                 snap.forEach(d => allMsgHistoryCache.push({id:d.id, ...d.data()}));
                 // Sort desc
                 allMsgHistoryCache.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                 renderMessageHistory();
             } catch(e) { console.error(e); }
        };

        window.renderMessageHistory = () => {
            const container = document.getElementById('msgHistoryBody');
            
            const totalPages = Math.ceil(allMsgHistoryCache.length / itemsPerPage);
            if(currentMsgHistoryPage > totalPages) currentMsgHistoryPage = totalPages || 1;
            
            const start = (currentMsgHistoryPage - 1) * itemsPerPage;
            const paged = allMsgHistoryCache.slice(start, start + itemsPerPage);
            
            if(paged.length === 0) {
                container.innerHTML = '<tr><td colspan="3" class="text-center py-3 small text-muted">Belum ada riwayat pesan.</td></tr>';
                return;
            }

            let h = '';
            paged.forEach(m => {
                const date = new Date(m.timestamp).toLocaleDateString() + ' ' + new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                h += `<tr>
                    <td>${date}</td>
                    <td><span class="badge bg-light text-dark border">${m.targetName}</span></td>
                    <td class="text-truncate" style="max-width: 200px;">${m.body}</td>
                </tr>`;
            });
            container.innerHTML = h;
            renderPaginationControls('msgPagination', currentMsgHistoryPage, totalPages, 'changeMsgHistoryPage');
        };

        window.changeMsgHistoryPage = (p) => {
            currentMsgHistoryPage = p;
            renderMessageHistory();
        };
        
        // --- TEACHER REPORT LOGIC ---
        window.openTeacherReport = async(studentId, name) => {
            currentStudentReportId = studentId;
            document.getElementById('teacherReportModalOverlay').classList.remove('hidden');
            document.getElementById('teacherReportModalOverlay').classList.add('active');
            
            const content = document.getElementById('teacherReportContent');
            content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>Memuat data...</p></div>';
            
            // Switch to default tab
            switchTeacherModalView('goals');
        };

        window.closeTeacherReportModal = () => {
            document.getElementById('teacherReportModalOverlay').classList.remove('active');
            setTimeout(() => document.getElementById('teacherReportModalOverlay').classList.add('hidden'), 300);
            currentStudentReportId = null;
        };

      // --- TEACHER MODAL NAVIGATION (UPDATED) ---
// Cari fungsi switchTeacherModalView(view) dan update isinya:

window.switchTeacherModalView = (view) => {
    // 1. UPDATE BAGIAN MAP INI (Tambahkan 'activity': 5)
    const map = { 'profile':0, 'goals':1, 'achievements':2, 'org':3, 'skills':4, 'activity':5 };
    
    const tabs = document.querySelectorAll('#teacherModalTabs .nav-link');
    tabs.forEach(el => el.classList.remove('active'));
    if(tabs[map[view]]) tabs[map[view]].classList.add('active');

    const content = document.getElementById('teacherReportContent');
    content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 small text-muted">Memuat data...</p></div>';

    // 2. TAMBAHKAN 'else if' DI PALING BAWAH LOGIKA IF
    if(view === 'goals') {
        loadGoals(currentStudentReportId, true);
    } else if(view === 'skills') {
        loadSkills(currentStudentReportId, true);
    } else if(view === 'profile') {
        renderTeacherProfileView();
    } else if(view === 'achievements') {
        loadAchievements(currentStudentReportId, true);
    } else if(view === 'org') {
        loadOrganizations(currentStudentReportId, true);
    } 
    // --- TAMBAHAN BARU ---
    else if(view === 'activity') {
        renderTeacherActivityLog(); 
    }
};
       

        window.saveTeacherNote = async () => {
            const note = document.getElementById('teacherNoteInput').value;
            if(!currentStudentReportId) return;
            try {
                const ref = doc(db,'artifacts',appId,'users',currentStudentReportId,'goals','main');
                const s = await getDoc(ref);
                let data = s.exists() ? s.data() : {};
                data.teacherNote = note;
                await setDoc(ref, data);
                alert("Catatan Evaluasi tersimpan!");
            } catch(e) { alert("Gagal simpan: " + e.message); }
        };

        window.saveTeacherSkillNote = async () => {
            const note = document.getElementById('teacherSkillNoteInput').value;
            if(!currentStudentReportId) return;
            try {
                const ref = doc(db,'artifacts',appId,'users',currentStudentReportId,'skills','main');
                const s = await getDoc(ref);
                let data = s.exists() ? s.data() : {};
                data.teacherNote = note;
                await setDoc(ref, data);
                alert("Saran Keahlian tersimpan!");
            } catch(e) { alert("Gagal simpan: " + e.message); }
        };

        // --- NEW: UNLOCK FINAL GOAL (TEACHER) ---
        window.unlockFinalGoalTeacher = async () => {
            if(!currentStudentReportId) return;
            
            // Check current status first to toggle
            try {
                const ref = doc(db,'artifacts',appId,'users',currentStudentReportId,'goals','main');
                const s = await getDoc(ref);
                let currentStatus = true; // Assume locked if undefined or true
                if(s.exists() && s.data().finalGoalLocked !== undefined) {
                    currentStatus = s.data().finalGoalLocked;
                }
                
                // Toggle it
                const newStatus = !currentStatus;
                await updateDoc(ref, { finalGoalLocked: newStatus });
                
                const statusText = newStatus ? "DIKUNCI" : "DIBUKA";
                alert(`Status Tujuan Akhir siswa berhasil ${statusText}.`);
                
                // Refresh view
                loadGoals(currentStudentReportId, true);
                
            } catch(e) {
                alert("Gagal mengubah status: " + e.message);
            }
        };

        // --- TEACHER INBOX LOGIC ---
       // 2. Inbox with Tabs & Badges Logic
window.loadTeacherInbox = async() => {
    const q = query(collection(db,'artifacts',appId,'public','data','curhat_messages')); 
    
    // Pakai onSnapshot agar realtime update badge
    onSnapshot(q, (snapshot) => {
        let msgs = [];
        snapshot.forEach(d => msgs.push(d.data()));
        msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        let conversations = {};
        let totalUnread = 0;

        // Proses pesan untuk dikelompokkan per siswa
        msgs.forEach(m => {
            if(m.studentUid) { 
                if(!conversations[m.studentUid]) {
                    conversations[m.studentUid] = { 
                        name: m.fromName || 'Siswa', 
                        class: m.fromClass || '',
                        lastMsg: m.message,
                        category: m.category || '',
                        timestamp: m.timestamp,
                        uid: m.studentUid,
                        lastSender: m.senderRole
                    };
                } else {
                    conversations[m.studentUid].lastMsg = m.message;
                    conversations[m.studentUid].category = m.category || '';
                    conversations[m.studentUid].timestamp = m.timestamp;
                    conversations[m.studentUid].lastSender = m.senderRole;
                }
            }
        });

        // Hitung Unread
        Object.values(conversations).forEach(c => {
            if(c.lastSender === 'student') totalUnread++;
        });

        //  UPDATE BADGE DI SIDEBAR & HOME
        const badgeSidebar = document.querySelector('[data-target="t_inbox"] .badge-notif');
        const badgeHome = document.getElementById('homeInboxBadge');
        
        if(totalUnread > 0) {
            // Sidebar Badge
            if(badgeSidebar) {
                badgeSidebar.innerText = totalUnread;
                badgeSidebar.classList.remove('hidden');
            } else {
                // Tambahkan badge jika belum ada
                const inboxLink = document.querySelector('[data-target="t_inbox"]');
                if(inboxLink && !inboxLink.querySelector('.badge-notif')) {
                    const badge = document.createElement('span');
                    badge.className = 'badge-notif';
                    badge.innerText = totalUnread;
                    inboxLink.appendChild(badge);
                }
            }
            
            // Home Badge
            if(badgeHome) {
                badgeHome.innerText = totalUnread;
                badgeHome.classList.remove('hidden');
            }
        } else {
            if(badgeSidebar) badgeSidebar.classList.add('hidden');
            if(badgeHome) badgeHome.classList.add('hidden');
        }

        // Simpan ke cache
        allInboxCache = Object.values(conversations).sort((a,b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        );
        
        // Render list (default Kelas X)
        filterInbox('X');
    });
};


// Fungsi Filter Inbox
window.filterInbox = (grade, tabEl) => {
    if(tabEl) {
        document.querySelectorAll('#inboxGradeTabs .nav-link').forEach(l => l.classList.remove('active'));
        tabEl.classList.add('active');
    }

    const listEl = document.getElementById('inboxList');
    if(!listEl) return;

    // Filter list berdasarkan kelas
    const filtered = allInboxCache.filter(c => {
        const cls = (c.class || '').toUpperCase();
        if(grade === 'X') return cls.startsWith('X ') || cls === 'X';
        if(grade === 'XI') return cls.startsWith('XI ') || cls === 'XI';
        if(grade === 'XII') return cls.startsWith('XII ') || cls === 'XII';
        return false;
    });

    if(filtered.length === 0) {
        listEl.innerHTML = '<div class="p-4 text-center text-muted small">Tidak ada pesan untuk angkatan ini.</div>';
        return;
    }

    let h = '';
    filtered.forEach(c => {
        const isUnread = c.lastSender === 'student';
        // Tambahkan dot merah jika unread
        const unreadIndicator = isUnread ? '<span class="unread-dot" style="width:10px; height:10px; background:red; border-radius:50%; display:inline-block; margin-left:5px;"></span>' : '';
        
        h += `
        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-start border-0 border-bottom" onclick="openTeacherChat('${c.uid}', '${c.name}')">
            <div class="ms-2 me-auto w-100">
                <div class="d-flex justify-content-between">
                    <div class="fw-bold text-dark mb-1">
                        ${c.name} ${unreadIndicator}
                    </div>
                    <small class="text-muted" style="font-size:0.65rem">${new Date(c.timestamp).toLocaleDateString()}</small>
                </div>
                <div class="small text-muted mb-1">${c.class}</div>
                <small class="text-muted text-truncate d-block" style="max-width: 95%; opacity: 0.8;">
                    ${c.category ? `<span class="badge bg-secondary me-1" style="font-size:0.6rem">${c.category}</span>` : ''} 
                    ${c.lastSender === 'teacher' ? '<i class="fas fa-reply me-1"></i>' : ''}${c.lastMsg}
                </small>
            </div>
        </button>`;
    });
    listEl.innerHTML = h;
};



        window.openTeacherChat = async(studentId, name) => {
            selectedStudentChatId = studentId;
            document.getElementById('inboxList').style.display = 'none';
            document.getElementById('teacherChatArea').style.display = 'flex';
            document.getElementById('teacherChatArea').classList.remove('hidden');
            document.getElementById('chatWithStudentName').innerText = "Chat: " + name;
            
            const q = query(collection(db,'artifacts',appId,'public','data','curhat_messages'), where('studentUid', '==', studentId));
            
            onSnapshot(q, (snap) => {
                let msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                let h = '';
                msgs.forEach(m => {
                    const isMe = m.senderRole === 'teacher';
                    const bubbleClass = isMe ? 'sent' : 'received';
                    const senderName = isMe ? 'Saya' : 'Guru';
                    const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    h += `<div class="chat-bubble ${bubbleClass}">
                        ${m.category && !isMe ? `<span class="chat-category-badge">${m.category}</span><br>` : ''}
                        ${m.message}
                        <div class="chat-meta">${time}</div>
                    </div>`;
                });
                const container = document.getElementById('teacherChatMessages');
                container.innerHTML = h;
                container.scrollTop = container.scrollHeight;
            });
        };
        
        window.closeTeacherChat = () => {
    selectedStudentChatId = null;
    const chatArea = document.getElementById('teacherChatArea');
    const inboxList = document.getElementById('inboxList');
    
    if(chatArea) {
        chatArea.style.display = 'none';
        chatArea.classList.add('hidden');
    }
    if(inboxList) {
        inboxList.style.display = 'block';
        inboxList.classList.remove('hidden');
    }
};
        
        window.replyAsTeacher = async() => {
            if(!selectedStudentChatId || !getVal('teacherReplyMsg')) return;
            
            await addDoc(collection(db,'artifacts',appId,'public','data','curhat_messages'), {
                studentUid: selectedStudentChatId,
                senderRole: 'teacher', 
                fromUid: currentUser.uid,
                fromName: userData.name,
                message: getVal('teacherReplyMsg'),
                timestamp: new Date().toISOString()
            });
            
            setVal('teacherReplyMsg', '');
        };

        // Common
        async function loadDynamicMenus(r) {
            const q = query(collection(db,'artifacts',appId,'public','data','menus'));
            const s = await getDocs(q);
            let h='';
            s.forEach(d => {
                const m=d.data();
                if(m.role==='all'||m.role===r) h+=`<a href="${m.link}" target="_blank" class="app-icon-btn"><div class="app-icon-box"><i class="fas ${m.icon}"></i></div><div class="small fw-bold">${m.title}</div></a>`;
            });
            const cid = r==='student'?'studentDynamicMenus':'teacherDynamicMenus';
            document.getElementById(cid).innerHTML=h||'<div class="col-12 small text-center text-muted">Empty</div>';
        }

        async function loadGoals(targetUid, isTeacherMode = false) {
            if(!targetUid) targetUid = currentUser.uid;
            
            try {
                // 1. Determine Class Level
                if(!isTeacherMode && userData) {
                    const classStr = userData.class || "";
                    if (classStr.startsWith('XII')) studentClassLevel = 12;
                    else if (classStr.startsWith('XI')) studentClassLevel = 11;
                    else studentClassLevel = 10;
                }
                
                // NEW: Pastikan Personality Data Termuat untuk User/Siswa Tersebut (Penting untuk Guru)
                if(targetUid !== currentUser.uid || !personalityData.char) {
                     await loadPersonality(targetUid);
                }

                // 2. Fetch Data
                const s = await getDoc(doc(db,'artifacts',appId,'users',targetUid,'goals','main'));
                if(s.exists()) { 
                    const d = s.data(); 
                    
                    const normalize = (arr) => {
                        if(!Array.isArray(arr)) return [];
                        return arr.map(item => {
                            if(typeof item === 'string') return { t: item, d: false };
                            return item; 
                        });
                    };

                    goalObjects.x = normalize(d.sem1);
                    goalObjects.xi = normalize(d.sem3);
                    goalObjects.xii = normalize(d.sem5);
                    
                    currentGoals.x = goalObjects.x.map(o => o.t);
                    currentGoals.xi = goalObjects.xi.map(o => o.t);
                    currentGoals.xii = goalObjects.xii.map(o => o.t);
                    
                    // Locked states
                    reportLocked = d.locked || { x: false, xi: false, xii: false };
                    
                    // NEW: Load Personality Eval Map from DB
                    personalityEvalData = d.personalityEval || {
                        x: { char: {}, interest: {}, diff: {} },
                        xi: { char: {}, interest: {}, diff: {} },
                        xii: { char: {}, interest: {}, diff: {} }
                    };

                    // NEW: Final Goal Data Map
                    finalGoalData = {
                        type: d.finalGoalType || "",
                        reason: d.finalGoalReason || "",
                        confidence: d.finalGoalConfidence || "",
                        locked: d.finalGoalLocked || false
                    };
                    
                    // Set Values
                    if(!isTeacherMode) {
                        setVal('finalGoalType', finalGoalData.type);
                        setVal('finalGoalReason', finalGoalData.reason);
                        setVal('finalGoalConfidence', finalGoalData.confidence);
                        
                        // Handle Locking UI
                        const inputs = ['finalGoalType', 'finalGoalReason', 'finalGoalConfidence'];
                        const btnLock = document.getElementById('btnLockFinalGoal');
                        const msgLock = document.getElementById('finalGoalLockMsg');
                        const statusBadge = document.getElementById('finalGoalLockStatus');
                        
                        if(finalGoalData.locked) {
                            inputs.forEach(id => document.getElementById(id).disabled = true);
                            btnLock.classList.add('hidden');
                            msgLock.classList.remove('hidden');
                            statusBadge.className = 'badge bg-success';
                            statusBadge.innerText = 'Terkunci';
                        } else {
                            inputs.forEach(id => document.getElementById(id).disabled = false);
                            btnLock.classList.remove('hidden');
                            msgLock.classList.add('hidden');
                            statusBadge.className = 'badge bg-secondary';
                            statusBadge.innerText = 'Draft';
                        }
						
						//  TEMPELKAN KODE LOGIKA BARU DI SINI 

                        // --- UPDATE LOGIKA PENGUNCIAN TAB KELAS (X, XI, XII) ---
                        // 1. Reset tombol tab terlebih dahulu (hapus gembok lama)
                        const tabX = document.getElementById('tab-x-btn');
                        const tabXI = document.getElementById('tab-xi-btn');
                        const tabXII = document.getElementById('tab-xii-btn');

                        [tabX, tabXI, tabXII].forEach(btn => {
                            if(btn) {
                                btn.disabled = false;
                                btn.innerHTML = btn.innerText.replace(' ', ''); 
                            }
                        });

                        // 2. Logika Penguncian Berdasarkan Jenjang Kelas Siswa
                        
                        // Jika Kelas XI (11): Kunci Tab X
                        if (studentClassLevel > 10 && tabX) {
                            tabX.disabled = true;
                            tabX.innerHTML = ` ${tabX.innerText}`;
                            // Pindah paksa ke tab XI jika user sedang melihat tab X
                            if(tabX.classList.contains('active')) {
                                tabXI.click(); 
                            }
                        }

                        // Jika Kelas XII (12): Kunci Tab X dan XI
                        if (studentClassLevel > 11 && tabXI) {
                            tabXI.disabled = true;
                            tabXI.innerHTML = ` ${tabXI.innerText}`;
                            // Pindah paksa ke tab XII
                            if(tabXI.classList.contains('active') || (tabX && tabX.classList.contains('active'))) {
                                tabXII.click();
                            }
                        }
                        
                        //  AKHIR KODE BARU 
						
                    }

                    teacherNoteVal = d.teacherNote || "Belum ada catatan.";
                } else {
                    // Defaults
                    currentGoals = { x: [], xi: [], xii: [] };
                    goalObjects = { x: [], xi: [], xii: [] };
                    reportLocked = { x: false, xi: false, xii: false };
                    personalityEvalData = { x: { char: {}, interest: {}, diff: {} }, xi: { char: {}, interest: {}, diff: {} }, xii: { char: {}, interest: {}, diff: {} } };
                    finalGoalData = { type: "", reason: "", confidence: "", locked: false };
                    teacherNoteVal = "Belum ada catatan.";
                }

                if(isTeacherMode) {
                    renderTeacherReportView();
                } else {
                    // UPDATE: Logika Edit Peta Masa Depan
                    // Sekarang bisa diedit SELAMA belum dikunci (reportLocked[key] == false)
                    // Tidak lagi dibatasi oleh jenjang kelas (studentClassLevel)
                    renderGoalList('x', 'goalsListX', !reportLocked.x);
                    renderGoalList('xi', 'goalsListXI', !reportLocked.xi);
                    renderGoalList('xii', 'goalsListXII', !reportLocked.xii);

                    // Pastikan tombol tambah muncul jika belum dikunci
                    const btnX = document.querySelector('#tab-x-content button');
                    const btnXI = document.querySelector('#tab-xi-content button');
                    const btnXII = document.querySelector('#tab-xii-content button');
                    
                    if(btnX) btnX.style.display = reportLocked.x ? 'none' : 'inline-block';
                    if(btnXI) btnXI.style.display = reportLocked.xi ? 'none' : 'inline-block';
                    if(btnXII) btnXII.style.display = reportLocked.xii ? 'none' : 'inline-block';
                    
                    renderStudentReportView();
                }

            } catch(e){ console.error(e); }
        }

        // --- GOAL EDIT VIEW (Student Tab 2) ---
        window.renderGoalList = (key, containerId, isEditable) => {
            const list = currentGoals[key];
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div class="text-muted small fst-italic">Belum ada target.</div>';
                return;
            }

            list.forEach((goal, index) => {
                const row = document.createElement('div');
                row.className = 'goal-item-row';
                
                if (isEditable) {
                    row.innerHTML = `
                        <input type="text" class="form-control goal-item-input" value="${goal}" onchange="updateGoalItem('${key}', ${index}, this.value)" placeholder="Tulis target...">
                        <button type="button" class="goal-delete-btn" onclick="deleteGoalItem('${key}', ${index})"><i class="fas fa-trash"></i></button>
                    `;
                } else {
                    row.innerHTML = `
                        <div class="flex-grow-1 p-2 bg-white rounded border text-muted small"><i class="fas fa-check-circle text-success me-2"></i>${goal}</div>
                    `;
                }
                container.appendChild(row);
            });
        };

        window.addGoalRow = (key) => {
            currentGoals[key].push("");
            // Re-render based on current student level logic
            const isEditable = (key === 'x' && studentClassLevel === 10) || 
                               (key === 'xi' && studentClassLevel <= 11) || 
                               (key === 'xii');
            renderGoalList(key, key === 'x' ? 'goalsListX' : (key === 'xi' ? 'goalsListXI' : 'goalsListXII'), isEditable);
        };

        window.updateGoalItem = (key, index, value) => {
            currentGoals[key][index] = value;
        };

        window.deleteGoalItem = (key, index) => {
            currentGoals[key].splice(index, 1);
            // Re-render
            renderGoalList(key, key === 'x' ? 'goalsListX' : (key === 'xi' ? 'goalsListXI' : 'goalsListXII'), true);
        };
        
        // NEW: Lock Final Goal Function (Student)
        window.lockFinalGoal = async () => {
            if(!confirm("Yakin ingin mengunci Tujuan Akhir? Data tidak bisa diubah lagi kecuali dibuka oleh Guru Wali.")) return;
            
            // Set local state to locked true temporarily to save
            finalGoalData.locked = true;
            
            // Trigger save
            await saveGoals(new Event('submit')); 
        };

        window.saveGoals = async(e) => {
            if(e) e.preventDefault();
            
            // Merge text edits back into objects
            const merge = (textArr, objArr) => {
                return textArr.filter(t => t.trim() !== "").map((text, i) => {
                    const status = objArr[i] ? objArr[i].d : false; // Preserve status
                    return { t: text, d: status };
                });
            };

            const cleanData = {
                sem1: merge(currentGoals.x, goalObjects.x),
                sem3: merge(currentGoals.xi, goalObjects.xi),
                sem5: merge(currentGoals.xii, goalObjects.xii),
                // NEW: Save Final Goal Fields
                finalGoalType: getVal('finalGoalType'),
                finalGoalReason: getVal('finalGoalReason'),
                finalGoalConfidence: getVal('finalGoalConfidence'),
                finalGoalLocked: finalGoalData.locked, // Use state variable
                // NEW: Save Personality Eval
                personalityEval: personalityEvalData,
                teacherNote: teacherNoteVal,
                locked: reportLocked 
            };

            await setDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'goals','main'), cleanData);
            
            // Update Public User Profile for easy teacher access if needed (optional summary)
            await updateDoc(doc(db,'artifacts',appId,'public','data','users',currentUser.uid), {
                finalGoal: cleanData.finalGoalType // Just store the type for quick view
            });
            // Di dalam saveGoals():
			logUserActivity("Memperbarui Peta Masa Depan (Goals)");
            alert('Peta Masa Depan Tersimpan!');
            loadGoals(); 
        };

        // --- RAPORT VIEW (Student Tab 3) ---
        window.switchReportTab = (tab) => {
            activeReportTab = tab;
            document.querySelectorAll('#reportTabs .nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`rep-${tab}-btn`).classList.add('active');
            renderStudentReportView(); // Re-render with active tab
        }
        
        // NEW: Function to Update Personality Eval State (Auto Save UI)
        window.updatePersonalityEvalState = async (grade, type, index, value) => {
            if(reportLocked[grade]) return;
            
            if(!personalityEvalData[grade]) personalityEvalData[grade] = { char: {}, interest: {}, diff: {} };
            if(!personalityEvalData[grade][type]) personalityEvalData[grade][type] = {};
            
            personalityEvalData[grade][type][index] = value;
            
            // Auto Save UI State (Coloring)
            const elId = `eval-${grade}-${type}-${index}`;
            const el = document.getElementById(elId);
            if(el) {
                el.className = 'form-select eval-select'; // reset
                if(value === 'better') el.classList.add('better');
                if(value === 'solved') el.classList.add('solved');
            }

            // Silent Save to DB
            try {
                // Construct clean data similar to saveGoals but keep existing goals
                const cleanData = {
                    sem1: goalObjects.x,
                    sem3: goalObjects.xi,
                    sem5: goalObjects.xii,
                    finalGoalType: finalGoalData.type,
                    finalGoalReason: finalGoalData.reason,
                    finalGoalConfidence: finalGoalData.confidence,
                    finalGoalLocked: finalGoalData.locked,
                    personalityEval: personalityEvalData, // The important part
                    teacherNote: teacherNoteVal,
                    locked: reportLocked 
                };
                await setDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'goals','main'), cleanData);
            } catch(e) { console.error("Auto-save eval failed", e); }
        };

        window.renderStudentReportView = () => {
            const key = activeReportTab; // x, xi, or xii
            const container = document.getElementById('reportContentArea');
            document.getElementById('reportTeacherNote').innerText = teacherNoteVal || "Belum ada catatan.";
            
            const items = goalObjects[key];
            const isLocked = reportLocked[key];
            
            let total = items.length; 
            let achieved = 0;
            let listHtml = '';

            items.forEach((item, idx) => {
                if(item.d) achieved++;
                const checked = item.d ? 'checked' : '';
                const cls = item.d ? 'done' : '';
                const disabled = isLocked ? 'disabled' : '';
                
                listHtml += `
                <div class="report-item ${cls}">
                    <span class="small">${item.t}</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" ${checked} ${disabled} onchange="toggleGoalStatus('${key}', ${idx})">
                    </div>
                </div>`;
            });
            
            // --- NEW: RENDER PERSONALITY EVAL SECTION (STUDENT) ---
            const generateEvalRow = (label, list, type, options) => {
                if(!list || list.length === 0) return '';
                let rows = `<div class="small fw-bold text-muted mb-2">${label}</div>`;
                
                list.forEach((itemText, idx) => {
                    const savedVal = personalityEvalData[key]?.[type]?.[idx] || '';
                    const disabled = isLocked ? 'disabled' : '';
                    let selectClass = 'eval-select';
                    if(savedVal === 'better') selectClass += ' better';
                    if(savedVal === 'solved') selectClass += ' solved';

                    let optsHtml = options.map(opt => 
                        `<option value="${opt.val}" ${savedVal === opt.val ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');

                    rows += `
                    <div class="eval-row">
                        <span class="small text-dark">${itemText}</span>
                        <select id="eval-${key}-${type}-${idx}" class="form-select ${selectClass}" ${disabled} 
                            onchange="updatePersonalityEvalState('${key}', '${type}', ${idx}, this.value)">
                            ${optsHtml}
                        </select>
                    </div>`;
                });
                return rows;
            };

            const charList = personalityData.char || [];
            const interestList = personalityData.interest || [];
            const diffList = [...(personalityData.diffStudy||[]), ...(personalityData.diffLife||[])];

            let persEvalHtml = '';
            
            if(charList.length > 0 || interestList.length > 0 || diffList.length > 0) {
                 persEvalHtml += `<div class="mt-4"><h6 class="fw-bold small text-secondary border-bottom pb-2 mb-3">Evaluasi Diri & Kepribadian</h6>`;
                 
                 // Section 1: Sifat & Minat
                 if(charList.length > 0 || interestList.length > 0) {
                     persEvalHtml += `<div class="eval-section">`;
                     persEvalHtml += generateEvalRow("Sifat / Karakter", charList, 'char', [
                         {val: 'same', label: 'Tetap'}, {val: 'better', label: 'Lebih Baik'}
                     ]);
                     if(charList.length > 0 && interestList.length > 0) persEvalHtml += `<hr class="my-2" style="border-style:dashed; opacity:0.3;">`;
                     persEvalHtml += generateEvalRow("Minat & Bakat", interestList, 'interest', [
                         {val: 'same', label: 'Tetap'}, {val: 'better', label: 'Lebih Baik'}
                     ]);
                     persEvalHtml += `</div>`;
                 }

                 // Section 2: Kesulitan
                 if(diffList.length > 0) {
                      persEvalHtml += `<div class="eval-section border-danger border-opacity-25 bg-danger bg-opacity-10">`;
                      persEvalHtml += generateEvalRow("Daftar Kesulitan", diffList, 'diff', [
                         {val: 'unsolved', label: 'Belum'}, {val: 'solved', label: 'Teratasi'}
                     ]);
                      persEvalHtml += `</div>`;
                 }
                 persEvalHtml += `</div>`;
            } else {
                persEvalHtml = `<div class="alert alert-light border mt-4 small"><i class="fas fa-info-circle me-1"></i>Isi data di menu "Personality" agar bisa dievaluasi disini.</div>`;
            }

            const percent = total === 0 ? 0 : Math.round((achieved / total) * 100);
            
            let html = `
                <!-- Statistic Chart -->
                <div class="text-center mb-4">
                    <div class="donut-chart" style="background: conic-gradient(var(--success-color) ${percent}%, #e2e8f0 ${percent}% 100%)">
                        <div class="donut-inner">
                            <h3 class="fw-bold mb-0 text-success">${percent}%</h3>
                            <small class="text-muted" style="font-size: 0.7rem;">Terwujud</small>
                        </div>
                    </div>
                    <div class="mt-3 small">
                        ${isLocked ? '<span class="badge bg-danger"><i class="fas fa-lock me-1"></i>Terkunci</span>' : ''}
                        <span class="badge bg-success">Terwujud: ${achieved}</span>
                        <span class="badge bg-secondary">Total: ${total}</span>
                    </div>
                </div>

                <!-- List -->
                <div class="mb-2">
                    <h6 class="small fw-bold text-muted border-bottom pb-2 mb-3">Target Pencapaian (Goals)</h6>
                    <div>${listHtml || '<div class="text-center small text-muted">Belum ada target.</div>'}</div>
                </div>
                
                <!-- NEW: Inserted Personality Eval -->
                ${persEvalHtml}
                
                <!-- Lock Button -->
                ${!isLocked ? `
                <div class="alert alert-warning d-flex align-items-center mb-0 mt-4">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    <div class="small lh-sm flex-grow-1">Jika sudah selesai, kunci laporan untuk dikirim ke Wali Kelas.</div>
                </div>
                <button onclick="lockReport('${key}')" class="btn btn-dark w-100 rounded-pill mt-2">
                    <i class="fas fa-key me-2"></i>Kunci & Kirim ke Wali Kelas
                </button>` : ''}
            `;
            
            container.innerHTML = html;
        };

        window.toggleGoalStatus = async (key, idx) => {
            if(reportLocked[key]) return; // Security check
            
            // Toggle local state
            goalObjects[key][idx].d = !goalObjects[key][idx].d;
            
            // Save immediately (Silent save)
            try {
                const data = {
                    sem1: goalObjects.x,
                    sem3: goalObjects.xi,
                    sem5: goalObjects.xii,
                    // Preserve Final Goal Data on auto-save
                    finalGoalType: finalGoalData.type,
                    finalGoalReason: finalGoalData.reason,
                    finalGoalConfidence: finalGoalData.confidence,
                    finalGoalLocked: finalGoalData.locked,
                    // Preserve Eval
                    personalityEval: personalityEvalData,
                    teacherNote: teacherNoteVal,
                    locked: reportLocked
                };
                
                const targetUid = currentStudentReportId || currentUser.uid;
                await setDoc(doc(db,'artifacts',appId,'users',targetUid,'goals','main'), data);
                
                if(currentStudentReportId) renderTeacherReportView();
                else renderStudentReportView();
                
            } catch(e) { console.error("Auto-save failed", e); }
        };
        
        window.lockReport = async (key) => {
            if(!confirm("Yakin ingin mengunci laporan ini? Data tidak bisa diubah lagi setelah dikunci.")) return;
            
            reportLocked[key] = true;
            try {
                const data = {
                    sem1: goalObjects.x,
                    sem3: goalObjects.xi,
                    sem5: goalObjects.xii,
                    finalGoalType: finalGoalData.type,
                    finalGoalReason: finalGoalData.reason,
                    finalGoalConfidence: finalGoalData.confidence,
                    finalGoalLocked: finalGoalData.locked,
                    personalityEval: personalityEvalData,
                    teacherNote: teacherNoteVal,
                    locked: reportLocked
                };
                await setDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'goals','main'), data);
                renderStudentReportView();
                alert("Laporan berhasil dikunci dan dikirim!");
            } catch(e) { alert("Gagal mengunci: " + e.message); }
        };

        // --- TEACHER REPORT VIEW (Modal) ---
        let activeTeacherReportTab = 'x';
        
        window.switchTeacherReportTab = (tab) => {
            activeTeacherReportTab = tab;
            document.querySelectorAll('#teacherReportTabs .nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`teach-rep-${tab}-btn`).classList.add('active');
            renderTeacherReportView(); 
        }

        window.renderTeacherReportView = () => {
            const container = document.getElementById('teacherReportContent');
            const key = activeTeacherReportTab;
            
            // Tab Navigation for Teacher (Inside Goals Tab)
            let tabsHtml = `
            <ul class="nav nav-pills mb-3 no-print" id="teacherReportTabs">
                <li class="nav-item flex-fill text-center"><button class="nav-link w-100 ${key==='x'?'active':''}" onclick="switchTeacherReportTab('x')" id="teach-rep-x-btn">Kelas X</button></li>
                <li class="nav-item flex-fill text-center"><button class="nav-link w-100 ${key==='xi'?'active':''}" onclick="switchTeacherReportTab('xi')" id="teach-rep-xi-btn">Kelas XI</button></li>
                <li class="nav-item flex-fill text-center"><button class="nav-link w-100 ${key==='xii'?'active':''}" onclick="switchTeacherReportTab('xii')" id="teach-rep-xii-btn">Kelas XII</button></li>
            </ul>`;

            const items = goalObjects[key];
            const isLocked = reportLocked[key];
            
            let total = 0, achieved = 0;
            let listHtml = '';

            // NEW: Tombol Buka Kunci untuk Guru
            let statusBadge = isLocked 
                ? `<span class="badge bg-danger"><i class="fas fa-lock me-1"></i>Terkunci</span> <button class="btn btn-sm btn-outline-danger ms-2 no-print" onclick="unlockReportTeacher('${key}')" style="font-size: 0.7rem;"><i class="fas fa-key me-1"></i>Buka Kunci</button>` 
                : `<span class="badge bg-success"><i class="fas fa-unlock me-1"></i>Terbuka</span>`;

            if(items.length > 0) {
                listHtml += `<div class="bg-light p-2 rounded mb-2 border no-print small d-flex justify-content-between align-items-center">
                    <span class="text-muted fw-bold">Status Laporan:</span>
                    <div>${statusBadge}</div>
                </div>`;
                
                items.forEach((item, idx) => {
                    total++;
                    if(item.d) achieved++;
                    const checked = item.d ? 'checked' : '';
                    // Teacher can toggle even if locked? Ideally no, to respect the "report", but let's allow fixes.
                    listHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                        <span class="small">${item.t}</span>
                        <div class="form-check form-switch no-print">
                            <input class="form-check-input" type="checkbox" ${checked} onchange="toggleGoalStatus('${key}', ${idx})">
                        </div>
                        <div class="only-print small fw-bold">${item.d ? 'OK' : '-'}</div>
                    </div>`;
                });
            } else {
                 listHtml += `<div class="bg-light p-2 rounded mb-2 border no-print small d-flex justify-content-between align-items-center">
                    <span class="text-muted fw-bold">Status Laporan:</span>
                    <div>${statusBadge}</div>
                </div><div class="text-muted small text-center py-3">Siswa belum mengisi target.</div>`;
            }

            const percent = total === 0 ? 0 : Math.round((achieved / total) * 100);

            // --- NEW: TEACHER VIEW PERSONALITY EVAL (READ ONLY) ---
            const generateTeacherEvalRow = (label, list, type) => {
                if(!list || list.length === 0) return '';
                let rows = `<div class="small fw-bold text-muted mb-2">${label}</div>`;
                
                list.forEach((itemText, idx) => {
                    const savedVal = personalityEvalData[key]?.[type]?.[idx] || '';
                    let badge = '<span class="badge bg-light text-dark border">-</span>';
                    
                    if(savedVal === 'better') badge = '<span class="badge bg-success">Lebih Baik</span>';
                    if(savedVal === 'same') badge = '<span class="badge bg-secondary">Tetap</span>';
                    if(savedVal === 'solved') badge = '<span class="badge bg-primary">Teratasi</span>';
                    if(savedVal === 'unsolved') badge = '<span class="badge bg-danger">Belum</span>';

                    rows += `
                    <div class="d-flex justify-content-between align-items-center mb-1 border-bottom border-light pb-1">
                        <span class="small text-dark">${itemText}</span>
                        ${badge}
                    </div>`;
                });
                return rows;
            };

            const charList = personalityData.char || [];
            const interestList = personalityData.interest || [];
            const diffList = [...(personalityData.diffStudy||[]), ...(personalityData.diffLife||[])];

            let persEvalHtml = '';
            
            if(charList.length > 0 || interestList.length > 0 || diffList.length > 0) {
                 persEvalHtml += `<div class="mt-4 border p-3 rounded bg-white"><h6 class="fw-bold small text-primary border-bottom pb-2 mb-3">Evaluasi Kepribadian Siswa</h6>`;
                 
                 if(charList.length > 0 || interestList.length > 0) {
                     persEvalHtml += generateTeacherEvalRow("Sifat & Minat", charList, 'char');
                     persEvalHtml += generateTeacherEvalRow("", interestList, 'interest'); 
                 }

                 if(diffList.length > 0) {
                      persEvalHtml += `<div class="mt-3"></div>`;
                      persEvalHtml += generateTeacherEvalRow("Kesulitan & Hambatan", diffList, 'diff');
                 }
                 persEvalHtml += `</div>`;
            } else {
                 persEvalHtml = `<div class="mt-4 p-3 border rounded bg-light text-muted small text-center fst-italic">Siswa belum mengisi data personality.</div>`;
            }

            // Final Goal Section for Teacher
            const finalGoalHtml = `
            <div class="mt-4 pt-3 border-top">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold text-dark"><i class="fas fa-flag-checkered me-2"></i>Tujuan Akhir</h6>
                    ${finalGoalData.locked ? `<button class="btn btn-sm btn-outline-danger no-print" onclick="unlockFinalGoalTeacher()"><i class="fas fa-lock me-1"></i>Buka Kunci</button>` : `<span class="badge bg-secondary no-print">Belum Dikunci</span>`}
                </div>
                <div class="bg-light p-3 rounded border">
                    <div class="row g-2">
                        <div class="col-6">
                            <small class="text-muted d-block">Pilihan:</small>
                            <strong>${finalGoalData.type || '-'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Keyakinan:</small>
                            <strong>${finalGoalData.confidence || '-'}</strong>
                        </div>
                        <div class="col-12 mt-2">
                            <small class="text-muted d-block">Alasan:</small>
                            <p class="small mb-0 fst-italic">${finalGoalData.reason || '-'}</p>
                        </div>
                    </div>
                </div>
            </div>`;

            container.innerHTML = `
                ${tabsHtml}
                
                <div id="printContent">
                    <div class="text-center mb-4 only-print" style="display:none;">
                        <h3>RAPORT EVALUASI DIRI</h3>
                        <p>SMK N 1 BRONDONG</p>
                        <hr>
                    </div>

                    <div class="row mb-4 align-items-center">
                        <div class="col-4">
                            <div class="donut-chart" style="width:100px; height:100px; background: conic-gradient(var(--success-color) ${percent}%, #e2e8f0 ${percent}% 100%)">
                                <div class="donut-inner" style="width:70px; height:70px;">
                                    <span class="fw-bold text-success">${percent}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-8">
                            <h6 class="fw-bold">Statistik Pencapaian Kelas ${key.toUpperCase()}</h6>
                            <div class="small text-muted">Total Target: ${total}</div>
                            <div class="small text-success">Terwujud: ${achieved}</div>
                        </div>
                    </div>
                    <div class="mb-4">${listHtml}</div>
                    
                    ${persEvalHtml}

                    ${finalGoalHtml}

                    <div class="mb-3 no-print mt-4">
                        <label class="fw-bold small mb-2">Catatan Guru Wali (Untuk Siswa)</label>
                        <textarea class="form-control" id="teacherNoteInput" rows="3" placeholder="Berikan semangat atau evaluasi...">${teacherNoteVal}</textarea>
                    </div>
                    
                    <div class="only-print mt-4 pt-4 border-top" style="display:none;">
                        <p class="small"><strong>Catatan Wali Kelas:</strong></p>
                        <p class="small fst-italic border p-2 rounded">${teacherNoteVal || '-'}</p>
                    </div>
                </div>

                <div class="d-flex gap-2 no-print mt-3">
                    <button class="btn btn-outline-dark flex-fill rounded-pill" onclick="printReport('${key}')"><i class="fas fa-print me-1"></i> Cetak PDF</button>
                    <button class="btn btn-primary flex-fill rounded-pill" onclick="saveTeacherNote()">Simpan Catatan</button>
                </div>
            `;
        };

        // NEW FUNCTION: Unlock Report Logic
        window.unlockReportTeacher = async (key) => {
            if(!confirm(`Buka kunci laporan Kelas ${key.toUpperCase()} untuk siswa ini? Siswa akan bisa mengedit kembali.`)) return;
            
            // Update local state temporarily for UI responsiveness
            reportLocked[key] = false;
            
            try {
                const ref = doc(db,'artifacts',appId,'users',currentStudentReportId,'goals','main');
                // Menggunakan sintaks update field nested Firestore "field.subfield"
                await updateDoc(ref, { [`locked.${key}`]: false }); 
                
                // Refresh view
                renderTeacherReportView();
            } catch(e) { 
                alert("Gagal membuka kunci: " + e.message);
                // Reload to revert state if failed
                loadGoals(currentStudentReportId, true);
            }
        };

        // --- RENDER TEACHER SKILLS VIEW (New Function) ---
        window.renderTeacherSkillsView = () => {
            const container = document.getElementById('teacherReportContent');
            
            let ownedHtml = '';
            if(skillsList.owned.length === 0) {
                ownedHtml = '<div class="text-muted small fst-italic">Tidak ada data.</div>';
            } else {
                skillsList.owned.forEach(s => {
                    ownedHtml += `<li class="mb-1">${s.name} <span class="badge bg-light text-dark border ms-1">${s.level}</span></li>`;
                });
                ownedHtml = `<ul class="list-unstyled small mb-0">${ownedHtml}</ul>`;
            }

            let wantedHtml = '';
            if(skillsList.wanted.length === 0) {
                wantedHtml = '<div class="text-muted small fst-italic">Tidak ada data.</div>';
            } else {
                skillsList.wanted.forEach(s => {
                    wantedHtml += `<div class="mb-2 pb-2 border-bottom">
                        <div class="fw-bold small">${s.name}</div>
                        <div class="text-muted fst-italic" style="font-size:0.75rem">${s.plan}</div>
                    </div>`;
                });
            }

            container.innerHTML = `
                <div class="mb-4">
                    <h6 class="fw-bold text-success border-bottom pb-2 mb-2">Keahlian Dimiliki</h6>
                    ${ownedHtml}
                </div>
                <div class="mb-4">
                    <h6 class="fw-bold text-warning border-bottom pb-2 mb-2">Target Pengembangan</h6>
                    ${wantedHtml}
                </div>
                <div class="mb-3">
                    <label class="fw-bold small mb-2">Saran Pengembangan (Untuk Siswa)</label>
                    <textarea class="form-control" id="teacherSkillNoteInput" rows="3" placeholder="Berikan saran atau rekomendasi...">${teacherSkillNoteVal}</textarea>
                </div>
                <button class="btn btn-primary w-100 rounded-pill" onclick="saveTeacherSkillNote()">Simpan Saran</button>
            `;
        };

        window.printReport = (key) => {
            const content = document.getElementById('printContent').innerHTML;
            const printArea = document.getElementById('printArea');
            
            // Inject content to print area
            printArea.innerHTML = `
                <div style="padding:20px; text-align:center;">
                    <h2>RAPORT EVALUASI DIRI</h2>
                    <h4>KELAS ${key.toUpperCase()}</h4>
                    <p style="margin-bottom:30px;">SMK N 1 BRONDONG</p>
                </div>
                ${content}
            `;
            
            // Manipulate DOM styles for print
            // Remove 'no-print' elements from printArea
            printArea.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');
            printArea.querySelectorAll('.only-print').forEach(e => e.style.display = 'block');
            
            window.print();
            
            // Cleanup
            setTimeout(() => { printArea.innerHTML = ''; }, 1000);
        };

        // --- NEW CHAT SYSTEM (STUDENT SIDE) ---
        window.handleEnterChat = (e) => { if(e.key === 'Enter') sendCurhat('student'); }

        window.sendCurhat = async(role) => {
            const msg = getVal('curhatMsg');
            const category = getVal('chatCategory') || 'Curhat';
            if(!msg) return;
            
            await addDoc(collection(db,'artifacts',appId,'public','data','curhat_messages'), {
                studentUid: currentUser.uid, 
                senderRole: 'student', 
                fromUid: currentUser.uid, 
                fromName: userData.name, 
                fromClass: userData.class || '',
                message: msg, 
                category: category,
                timestamp: new Date().toISOString()
            });
            setVal('curhatMsg',''); 
            // Reset scroll to ensure user sees message
            const container = document.getElementById('myCurhatList');
            setTimeout(() => { if(container) container.scrollTop = container.scrollHeight; }, 300);
        };

        let chatListenerUnsub = null;
        
        function initChatListener(myUid) {
    if(chatListenerUnsub) chatListenerUnsub();
    
    const q = query(collection(db,'artifacts',appId,'public','data','curhat_messages'), where('studentUid','==',myUid));
    
    chatListenerUnsub = onSnapshot(q, (snapshot) => {
        let msgs = [];
        snapshot.forEach(d => msgs.push(d.data()));
        msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // --- LOGIKA BARU: HITUNG BADGE ---
        // Asumsi sederhana: Jika pesan terakhir adalah dari Guru, anggap ada notifikasi
        // Atau hitung jumlah pesan guru (untuk sistem read/unread yang kompleks butuh field 'read' di database)
        let unreadCount = 0;
        if (msgs.length > 0) {
            // Cek pesan-pesan terakhir
            const lastMsg = msgs[msgs.length - 1];
            if (lastMsg.senderRole === 'teacher') {
                unreadCount = 1; // Tampilkan badge (titik merah atau angka 1)
            }
        }
        
        const badgeEl = document.getElementById('studentInboxBadge');
        if (badgeEl) {
            if (unreadCount > 0) {
                badgeEl.innerText = "!"; // Atau angka
                badgeEl.classList.remove('hidden');
            } else {
                badgeEl.classList.add('hidden');
            }
        }
        // ----------------------------------

        let h = '';
        if(msgs.length === 0) h = '<div class="text-center text-muted small mt-5">Belum ada pesan. Mulai chat dengan guru wali/BK Anda.</div>';
        
        msgs.forEach(m => {
            const isMe = m.senderRole === 'student';
            const bubbleClass = isMe ? 'sent' : 'received';
            const senderName = isMe ? 'Saya' : 'Guru';
            const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            h += `<div class="chat-bubble ${bubbleClass}">
                ${!isMe ? '<div class="small fw-bold text-primary mb-1">'+senderName+'</div>' : ''}
                ${m.category && isMe ? `<span class="chat-category-badge">${m.category}</span><br>` : ''}
                ${m.message}
                <div class="chat-meta">${time}</div>
            </div>`;
        });
        
        const container = document.getElementById('myCurhatList');
        if(container) {
            container.innerHTML = h;
            container.scrollTop = container.scrollHeight; 
        }
    });
}


	// 3. Teacher Profile & Security Logic
window.loadTeacherProfile = () => {
    if(!userData) return;
    setVal('editTeacherName', userData.name);
    setVal('editTeacherNIP', userData.nip || '');
    setVal('editTeacherPhone', userData.phone || '');
    setVal('editTeacherEmailDisplay', userData.email);
    setVal('editTeacherAvatar', userData.avatar);
    
    // Reuse fungsi getAvatarUrl yang sudah ada
    document.getElementById('teacherPreviewAvatar').src = getAvatarUrl(userData.avatar, 'teacher');
};

window.saveTeacherProfile = async (e) => {
    e.preventDefault();
    const newEmail = getVal('newAuthEmail');
    const newPass = getVal('newAuthPassword');
    
    try {
        // Update Data Firestore (Profil)
        await updateDoc(doc(db,'artifacts',appId,'public','data','users',currentUser.uid), {
            name: getVal('editTeacherName'),
            nip: getVal('editTeacherNIP'),
            phone: getVal('editTeacherPhone'),
            avatar: getVal('editTeacherAvatar')
        });

        // Update Auth (Login) jika diisi
        if(newEmail && newEmail !== currentUser.email) {
            await updateEmail(currentUser, newEmail);
            // Sync email di firestore juga
            await updateDoc(doc(db,'artifacts',appId,'public','data','users',currentUser.uid), { email: newEmail });
        }
        if(newPass) {
            await updatePassword(currentUser, newPass);
        }

        alert("Data berhasil diperbarui!");
        
        // Jika ganti email/pass, wajib logout
        if(newEmail || newPass) {
            alert("Karena ada perubahan Email/Password, silakan login ulang.");
            logout();
        } else {
            // Refresh UI lokal
            userData.name = getVal('editTeacherName');
            userData.avatar = getVal('editTeacherAvatar');
            updateUI(userData);
        }

    } catch(err) {
        if(err.code === 'auth/requires-recent-login') {
            alert("Demi keamanan, untuk mengganti Email/Password Anda harus Logout dan Login ulang terlebih dahulu.");
            logout();
        } else {
            alert("Gagal update: " + err.message);
        }
    }
};

// Update Fungsi Upload agar bisa dipakai Guru & Siswa
// GANTI fungsi handleFileUpload yang lama dengan ini:
window.handleFileUpload = (input, role) => {
    if(input.files && input.files[0]) {
        const file = input.files[0];
        if(file.size > 500000) return alert("Max 500KB");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_W = 150, MAX_H = 150;
                let w = img.width, h = img.height;
                if(w>h){ if(w>MAX_W){ h*=MAX_W/w; w=MAX_W;}} else { if(h>MAX_H){ w*=MAX_H/h; h=MAX_H;}}
                canvas.width=w; canvas.height=h;
                ctx.drawImage(img,0,0,w,h);
                const dataURL = canvas.toDataURL("image/jpeg",0.7);
                
                // Logic beda target berdasarkan role
                if(role === 'teacher') {
                    setVal('editTeacherAvatar', dataURL);
                    document.getElementById('teacherPreviewAvatar').src = dataURL;
                } else {
                    setVal('editAvatarValue', dataURL);
                    document.getElementById('previewAvatar').src = dataURL;
                    // Reset selection visual siswa
                    if(document.querySelectorAll('.avatar-option').length > 0) {
                        document.querySelectorAll('.avatar-option').forEach(el=>el.classList.remove('selected'));
                        document.querySelector('.avatar-upload-label').style.borderColor = 'var(--primary-color)';
                    }
                }
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
};

        window.handleForgotPassword = async(e) => {
            e.preventDefault();
            try { await sendPasswordResetEmail(auth, getVal('forgotEmail')); alert('Cek Email'); toggleAuth('login'); }
            catch(e){ alert(e.message); }
        }
		
		
		function analyzeWeeklyMood(moods) {
    const last7Days = Object.values(moods || {}).slice(-7);

    const count = { angry: 0, sad: 0, happy: 0, neutral: 0 };
    last7Days.forEach(m => count[m]++);

    let dominant = Object.keys(count).reduce((a, b) =>
        count[a] > count[b] ? a : b
    );

    return {
        dominant,
        count
    };
}


function updateInboxBadge(count) {
    const badge = document.getElementById('inboxBadge');
    if (!badge) return;

    if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('d-none');
    } else {
        badge.classList.add('d-none');
    }
}


async function loadGuruFromDatabase(elementId = 'signupTeacher') {
    const select = document.getElementById(elementId);
    if (!select) return;

    // Keep default option
    const defaultText = elementId === 'signupTeacher' ? 'Pilih Guru Wali' : '-- Pilih Guru Wali --';
    select.innerHTML = `<option value="">Memuat data...</option>`;

    try {
        const q = query(
            collection(db,'artifacts',appId,'public','data','users'),
            where('role','==','teacher')
        );

        const snap = await getDocs(q);
        
        select.innerHTML = `<option value="">${defaultText}</option>`;
        
        if (snap.empty) {
             const opt = document.createElement('option');
             opt.text = "Tidak ada data guru";
             opt.disabled = true;
             select.appendChild(opt);
             return;
        }

        snap.forEach(d => {
            const g = d.data();
            const opt = document.createElement('option');
            opt.value = d.id; // Use Doc ID as UID
            opt.text = g.name;
            select.appendChild(opt);
        });

    } catch (e) {
        console.error(e);
        select.innerHTML = '<option value="">Gagal memuat guru</option>';
    }
}

function openInbox() {
    hideAllMainSections();
    show('inboxSection');
}

function closeInbox() {
    hide('inboxSection');
    show('dashboardSection');
}

let teacherInboxInitialized = false;

function initTeacherInbox() {
  if (teacherInboxInitialized) return;
    teacherInboxInitialized = true;

    loadTeacherInbox(); // Langsung panggil fungsi utama
}


function listenInboxTeacher() {
    const q = query(
        collection(db,'artifacts',appId,'public','data','messages'),
        where('teacherId','==',currentUser.uid),
        where('read','==',false)
    );

    onSnapshot(q, snap => {
        updateInboxBadge(snap.size); //  INI WAJIB
    });
}



// --- NEW: RENDER TAMPILAN PROFIL (GURU VIEW) ---
        window.renderTeacherProfileView = async () => {
            const container = document.getElementById('teacherReportContent');
            try {
                // Ambil data profil siswa terbaru
                const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentStudentReportId));
                if(docSnap.exists()) {
                    const u = docSnap.data();
                    const ava = getAvatarUrl(u.avatar, 'student');
                    // Format nomor WA
                    const phoneLink = u.phone ? `https://wa.me/${u.phone.replace(/^0/,'62').replace(/\D/g,'')}` : '#';
                    
                    container.innerHTML = `
                        <div class="text-center mb-4 mt-3">
                            <img src="${ava}" class="rounded-circle border p-1 shadow-sm bg-white" width="100" height="100" style="object-fit:cover;">
                            <h5 class="fw-bold mt-2 mb-0">${u.name}</h5>
                            <span class="badge bg-primary">${u.class || 'Tanpa Kelas'}</span>
                        </div>
                        <div class="card bg-light border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <h6 class="fw-bold text-secondary mb-3 small border-bottom pb-2"><i class="fas fa-id-card me-2"></i>Biodata Lengkap</h6>
                                <div class="row g-3 small">
                                    <div class="col-6 text-muted">Tahun Masuk</div>
                                    <div class="col-6 fw-bold text-end text-dark">${u.batch || '-'}</div>
                                    
                                    <div class="col-6 text-muted">No. HP / WA</div>
                                    <div class="col-6 fw-bold text-end"><a href="${phoneLink}" target="_blank" class="text-decoration-none text-success"><i class="fab fa-whatsapp me-1"></i>${u.phone || '-'}</a></div>
                                    
                                    <div class="col-12 text-muted mb-1">Alamat Lengkap</div>
                                    <div class="col-12 fw-bold bg-white p-2 rounded border text-dark">${u.address || '-'}</div>
                                    
                                    <div class="col-12 text-muted mb-1">Hobi & Minat</div>
                                    <div class="col-12 fw-bold bg-white p-2 rounded border text-dark">${u.hobby || '-'}</div>
                                    
                                    <div class="col-12 text-muted mb-1">Cita-Cita</div>
                                    <div class="col-12 fw-bold bg-white p-2 rounded border text-primary">${u.dream || '-'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                             <a href="${phoneLink}" target="_blank" class="btn btn-success rounded-pill fw-bold"><i class="fab fa-whatsapp me-2"></i>Hubungi Siswa</a>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center text-muted py-5">Data siswa tidak ditemukan.</div>';
                }
            } catch(e) { container.innerHTML = '<div class="text-danger p-3">Error: '+e.message+'</div>'; }
        };
		
		
		// --- FUNGSI BARU: MENAMPILKAN LOG AKTIVITAS PER SISWA ---
// --- FUNGSI UPDATE: KALENDER AKTIVITAS & LOG ---
// Ganti fungsi renderTeacherActivityLog() yang lama dengan ini:

// --- FUNGSI UPDATE: KALENDER AKTIVITAS & LOG (DENGAN NAVIGASI BULAN) ---
// Ganti fungsi renderTeacherActivityLog() yang lama dengan ini:

// Variabel global untuk menyimpan posisi bulan yang sedang dilihat
window.viewActivityDate = new Date(); 

async function renderTeacherActivityLog(monthChange = 0) {
    const container = document.getElementById('teacherReportContent');
    
    // Update tanggal view berdasarkan input (Maju/Mundur Bulan)
    if (monthChange !== 0) {
        window.viewActivityDate.setMonth(window.viewActivityDate.getMonth() + monthChange);
    } else {
        // Jika dipanggil tanpa parameter (misal dari tab menu), reset ke bulan saat ini
        // Kecuali jika kita ingin mempertahankan view terakhir, baris ini bisa dihapus.
        // Untuk UX yang baik, biasanya reset saat tab dibuka pertama kali:
        if(monthChange === 'reset') window.viewActivityDate = new Date();
    }

    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 small text-muted">Menganalisis aktivitas...</p></div>';
    
    try {
        // 1. Ambil Data Log dari Database
        const q = query(
            collection(db, 'artifacts', appId, 'public', 'data', 'activity_logs'),
            where('studentUid', '==', currentStudentReportId)
        );

        const snap = await getDocs(q);
        let logs = [];
        let activeDates = new Set(); 

        snap.forEach(d => {
            const data = d.data();
            logs.push(data);
            
            // Simpan tanggal aktivitas ke Set agar unik
            const dateObj = new Date(data.timestamp);
            activeDates.add(dateObj.toDateString()); 
        });

        // Urutkan log (Terbaru diatas) untuk list detail
        logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        // 2. SETUP KALENDER BERDASARKAN VIEW DATE
        const viewYear = window.viewActivityDate.getFullYear();
        const viewMonth = window.viewActivityDate.getMonth(); // 0-11
        
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const monthName = monthNames[viewMonth];
        
        // Hitung jumlah hari di bulan yang sedang dilihat
        const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
        
        // Cek apakah ini bulan "Saat Ini" (untuk highlight hari ini)
        const today = new Date();
        const isCurrentMonth = today.getFullYear() === viewYear && today.getMonth() === viewMonth;

        // Mulai buat HTML
        let html = `
            <!-- KALENDER KEAKTIFAN -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold text-primary d-flex justify-content-between align-items-center">
                    
                    <!-- Tombol Mundur Bulan -->
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="renderTeacherActivityLog(-1)" title="Bulan Sebelumnya">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <span class="mx-2 text-dark">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>${monthName} ${viewYear}
                    </span>

                    <!-- Tombol Maju Bulan -->
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="renderTeacherActivityLog(1)" title="Bulan Berikutnya">
                        <i class="fas fa-chevron-right"></i>
                    </button>

                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 justify-content-center">`;

        // Loop Hari dalam Bulan Terpilih
        for(let day = 1; day <= daysInMonth; day++) {
            // Tanggal yang sedang di-loop
            const checkDate = new Date(viewYear, viewMonth, day);
            
            // Cek apakah ada data di tanggal ini
            const isActive = activeDates.has(checkDate.toDateString());
            
            // Styling
            let bgClass = isActive ? 'bg-success text-white shadow-sm' : 'bg-light text-muted';
            let borderClass = isActive ? 'border-success' : 'border-light';
            let content = isActive ? '<i class="fas fa-check"></i>' : '<span style="opacity:0.4; font-family:monospace;">0</span>';
            
            // Highlight khusus "Hari Ini" (Hanya jika sedang melihat bulan saat ini)
            if(isCurrentMonth && day === today.getDate() && !isActive) {
                borderClass = 'border-primary border-2'; 
            }

            html += `
                <div class="rounded p-1 d-flex flex-column align-items-center justify-content-center border ${borderClass} ${bgClass}" 
                     style="width: 42px; height: 48px; transition:all 0.2s;" 
                     title="Tanggal ${day} ${monthName} ${viewYear}">
                    <span class="fw-bold" style="font-size: 0.7rem;">${day}</span>
                    <div style="font-size: 0.85rem; margin-top:-2px;">${content}</div>
                </div>`;
        }

        html += `
                    </div>
                    <div class="mt-3 text-center small text-muted d-flex justify-content-center gap-3">
                        <div class="d-flex align-items-center"><div class="bg-success rounded-circle me-1" style="width:10px;height:10px;"></div> Hadir/Aktif</div>
                        <div class="d-flex align-items-center"><div class="bg-light border rounded-circle me-1" style="width:10px;height:10px;"></div> Tidak Aktif (0)</div>
                    </div>
                </div>
            </div>
        `;

        // 3. TABEL DETAIL (Tetap Menampilkan SEMUA Histori)
        if(logs.length === 0) {
            html += `<div class="text-center text-muted py-5 small fst-italic">Belum ada riwayat aktivitas tercatat sama sekali.</div>`;
        } else {
            html += '<h6 class="fw-bold text-dark mb-3 ps-1"><i class="fas fa-list-ul me-2"></i>Semua Riwayat Aktivitas</h6>';
            html += '<div class="table-responsive bg-white rounded shadow-sm border" style="max-height:400px; overflow-y:auto;"><table class="table table-hover mb-0 align-middle small">';
            html += '<thead class="table-light sticky-top"><tr><th>Waktu</th><th>Aktivitas</th></tr></thead><tbody>';

            logs.forEach(log => {
                const time = new Date(log.timestamp);
                const dateStr = time.toLocaleDateString('id-ID', {day:'numeric', month:'short', year: 'numeric'}); // Tambah tahun agar jelas
                const timeStr = time.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                
                let badgeClass = "bg-light text-dark";
                if(log.action.includes("Mood")) badgeClass = "bg-warning bg-opacity-10 text-warning";
                if(log.action.includes("Login")) badgeClass = "bg-success bg-opacity-10 text-success";
                if(log.action.includes("Peta") || log.action.includes("Goals")) badgeClass = "bg-primary bg-opacity-10 text-primary";

                html += `
                <tr>
                    <td style="width: 130px;" class="text-muted">
                        <div class="fw-bold text-dark">${timeStr}</div>
                        <div style="font-size:0.7rem">${dateStr}</div>
                    </td>
                    <td>
                        <span class="badge ${badgeClass} fw-normal text-wrap text-start lh-sm border-0">
                            ${log.action}
                        </span>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
        }

        // Tombol Refresh & Reset View
        html += `
        <div class="d-flex justify-content-between mt-2 align-items-center">
            <small class="text-muted fst-italic">*Menampilkan data kalender: ${monthName} ${viewYear}</small>
            <button class="btn btn-sm btn-link text-muted text-decoration-none" onclick="renderTeacherActivityLog('reset')">
                <i class="fas fa-sync-alt me-1"></i> Refresh Hari Ini
            </button>
        </div>`;

        container.innerHTML = html;

    } catch(e) {
        console.error(e);
        container.innerHTML = `<div class="text-danger p-3 small">Gagal memuat data: ${e.message}</div>`;
    }
}

        // --- NEW: RENDER TAMPILAN PRESTASI (GURU VIEW) ---
        window.renderTeacherAchievementsView = () => {
            const container = document.getElementById('teacherReportContent');
            if(achievementsList.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5 small fst-italic"><i class="fas fa-trophy fa-2x mb-2 text-secondary opacity-25"></i><br>Belum ada data prestasi.</div>';
                return;
            }
            let h = '<h6 class="fw-bold text-primary mb-3 ps-1">Daftar Prestasi Siswa</h6>';
            achievementsList.forEach(ach => {
                h += `
                <div class="card mb-3 border-0 shadow-sm border-start border-4 border-warning">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="badge bg-warning text-dark" style="font-size:0.65rem">${ach.level}</span>
                            <small class="text-muted fw-bold" style="font-size:0.7rem">${ach.year}</small>
                        </div>
                        <h6 class="fw-bold mb-1 text-dark">${ach.name}</h6>
                        <div class="small text-muted mb-2">${ach.organizer}</div>
                        <div>
                            <span class="badge bg-light text-dark border me-1">${ach.rank}</span>
                            <span class="badge bg-light text-dark border">${ach.type}</span>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = h;
        };

        // --- NEW: RENDER TAMPILAN ORGANISASI (GURU VIEW) ---
        window.renderTeacherOrgView = () => {
            const container = document.getElementById('teacherReportContent');
            if(organizationList.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5 small fst-italic"><i class="fas fa-sitemap fa-2x mb-2 text-secondary opacity-25"></i><br>Belum ada riwayat organisasi.</div>';
                return;
            }
            let h = '<h6 class="fw-bold text-primary mb-3 ps-1">Riwayat Organisasi & Keaktifan</h6>';
            organizationList.forEach(org => {
                let badgeClass = 'bg-secondary';
                if(org.type === 'Intra Sekolah') badgeClass = 'bg-info text-dark';
                else if(org.type === 'Ekstra Sekolah') badgeClass = 'bg-primary';
                else badgeClass = 'bg-success';

                h += `
                <div class="card mb-3 border-0 shadow-sm border-start border-4 border-info">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="badge ${badgeClass}" style="font-size:0.65rem">${org.type}</span>
                            <small class="text-muted fw-bold" style="font-size:0.7rem">${org.year}</small>
                        </div>
                        <h6 class="fw-bold mb-1 text-dark">${org.name}</h6>
                        <div class="small fw-bold text-dark">
                            ${org.position} 
                            ${org.field ? `<span class="text-muted fw-normal ms-1">(${org.field})</span>` : ''}
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = h;
        };
		
		
		// --- FUNGSI BARU: GURU MELIHAT LOG ---
async function loadStudentActivityLogs() {
    const container = document.getElementById('activityLogTableBody');
    if(!container) return;
    
    container.innerHTML = '<tr><td colspan="3" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Memuat...</td></tr>';

    try {
        // Ambil 20 aktivitas terakhir dari seluruh siswa
        const q = query(
            collection(db, 'artifacts', appId, 'public', 'data', 'activity_logs'), 
            orderBy('timestamp', 'desc'), 
            limit(20)
        );
        
        // Catatan: Jika error "index required", hapus sementara orderBy('timestamp', 'desc') 
        // dan urutkan manual dengan .sort() di Javascript seperti pesan inbox.

        const snap = await getDocs(q);
        let logs = [];
        snap.forEach(d => logs.push(d.data()));

        // Jika tidak pakai index firestore, sort manual disini:
        logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        if(logs.length === 0) {
            container.innerHTML = '<tr><td colspan="3" class="text-center py-3 text-muted">Belum ada aktivitas tercatat.</td></tr>';
            return;
        }

        let html = '';
        logs.forEach(log => {
            const time = new Date(log.timestamp);
            const dateStr = time.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
            const timeStr = time.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            
            // Warna badge berdasarkan jenis aktivitas
            let badgeColor = 'bg-light text-dark';
            if(log.action.includes('Login')) badgeColor = 'bg-success bg-opacity-10 text-success';
            if(log.action.includes('Mood')) badgeColor = 'bg-warning bg-opacity-10 text-warning';
            if(log.action.includes('Peta')) badgeColor = 'bg-primary bg-opacity-10 text-primary';

            html += `
            <tr>
                <td style="width: 120px;">
                    <div class="fw-bold" style="font-size:0.75rem">${timeStr}</div>
                    <div class="text-muted" style="font-size:0.65rem">${dateStr}</div>
                </td>
                <td>
                    <div class="fw-bold text-dark">${log.studentName}</div>
                    <div class="text-muted" style="font-size:0.7rem">${log.studentClass}</div>
                </td>
                <td>
                    <span class="badge ${badgeColor} border fw-normal text-wrap text-start">${log.action}</span>
                </td>
            </tr>`;
        });
        
        container.innerHTML = html;

    } catch(e) {
        console.error(e);
        // Fallback jika error index (karena orderBy)
        if(e.message.includes("index")) {
             container.innerHTML = '<tr><td colspan="3" class="text-center py-3 text-danger small">Error: Firestore Index diperlukan. Hapus orderBy di kode atau buat index di Firebase Console.</td></tr>';
        } else {
             container.innerHTML = '<tr><td colspan="3" class="text-center py-3 text-danger small">Gagal memuat data log.</td></tr>';
        }
    }
}



// --- LOGIKA GAME WALIPETS (Place at bottom of script) ---

let myPetData = {
    level: 1,
    xp: 0,
    coins: 50, // Modal awal
    health: 100,
    hunger: 100,
    happy: 100,
    lastUpdate: new Date().toISOString()
};

// URL GAMBAR (Siapkan untuk diganti nanti)
// Level 1: Telur/Bayi, Level 2: Remaja, Level 3: Dewasa
const petSprites = {
    1: "pet/gemoy.png", // Level 1
    2: "pet/gemoy2.png", // Level 2 (Bisa diganti gambar lain nanti)
    3: "pet/gemoy3.png"
};

// Panggil fungsi ini saat loadStudentDashboard()
async function initPetSystem() {
    if(!currentUser) return;
    try {
        const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'pet', 'main');
        const snap = await getDoc(docRef);
        
        if(snap.exists()) {
            myPetData = snap.data();
            calculateDecay(); // Kurangi status berdasarkan waktu offline
        } else {
            // Pet Baru
            await setDoc(docRef, myPetData);
        }
        updatePetUI();
    } catch(e) { console.error("Pet init error", e); }
}

// Menghitung penurunan status saat ditinggal offline
function calculateDecay() {
    const now = new Date();
    const last = new Date(myPetData.lastUpdate);
    const diffHours = Math.abs(now - last) / 36e5; // Selisih jam

    if(diffHours > 1) {
        // Kurangi 5 poin per jam
        const decay = Math.floor(diffHours * 5);
        myPetData.hunger = Math.max(0, myPetData.hunger - decay);
        myPetData.happy = Math.max(0, myPetData.happy - decay);
        
        // Jika lapar 0, kesehatan turun
        if(myPetData.hunger === 0) {
            myPetData.health = Math.max(0, myPetData.health - Math.floor(decay/2));
        }
        savePetData();
    }
}

function updatePetUI() {
    // Update Text
    document.getElementById('petLevel').innerText = myPetData.level;
    document.getElementById('petCoins').innerText = myPetData.coins;
    
    // Update Bars
    updateBar('Health', myPetData.health, 'bg-danger');
    updateBar('Hunger', myPetData.hunger, 'bg-warning');
    updateBar('Happy', myPetData.happy, 'bg-primary');

    // Update Image berdasarkan Level
    const imgEl = document.getElementById('petImage');
    const sprite = petSprites[myPetData.level] || petSprites[1];
    if(imgEl.src !== sprite) imgEl.src = sprite;

    // Bubble Chat Logika
    const bubble = document.getElementById('petBubble');
    if(myPetData.hunger < 30) {
        bubble.innerText = "Lapar banget... ";
        bubble.classList.remove('hidden');
    } else if(myPetData.happy < 30) {
        bubble.innerText = "Main dong! ";
        bubble.classList.remove('hidden');
    } else {
        bubble.classList.add('hidden');
    }
}

function updateBar(type, val, colorClass) {
    document.getElementById(`val${type}`).innerText = val + '%';
    const bar = document.getElementById(`bar${type}`);
    bar.style.width = val + '%';
    // Reset classes and add specific
    bar.className = `progress-bar ${colorClass}`;
}


// --- PERBAIKAN FUNGSI PET ACTION ---

window.petAction = async (action) => {
    console.log("Tombol diklik:", action); // Cek apakah tombol merespon

    // Pastikan data pet sudah ada
    if (!myPetData) {
        alert("Data peliharaan sedang dimuat, coba sesaat lagi...");
        return;
    }

    const imgEl = document.getElementById('petImage');
    let msg = "";

    if(action === 'feed') {
        if(myPetData.coins < 10) return alert("Koin tidak cukup! (Butuh 10 Koin). Isi Mood harian dulu untuk dapat koin.");
        if(myPetData.hunger >= 100) return alert("Perutku sudah penuh!");
        
        myPetData.coins -= 10;
        myPetData.hunger = Math.min(100, myPetData.hunger + 30);
        myPetData.health = Math.min(100, myPetData.health + 5);
        myPetData.xp += 10;
        msg = "Nyam nyam! Enak! ";
        
        // Animasi Makan
        if(imgEl) {
            imgEl.classList.add('pet-eating');
            setTimeout(() => imgEl.classList.remove('pet-eating'), 500);
        }

    } else if (action === 'play') {
        if(myPetData.coins < 5) return alert("Koin tidak cukup! (Butuh 5 Koin).");
        if(myPetData.happy >= 100) return alert("Aku sudah sangat senang!");

        myPetData.coins -= 5;
        myPetData.happy = Math.min(100, myPetData.happy + 25);
        myPetData.hunger = Math.max(0, myPetData.hunger - 10); // Main bikin lapar
        myPetData.xp += 15;
        msg = "Asyik! Seru banget! ";

    } else if (action === 'sleep') {
        if(myPetData.health >= 100) return alert("Aku segar bugar!");
        myPetData.health = Math.min(100, myPetData.health + 20);
        myPetData.happy = Math.max(0, myPetData.happy - 10); 
        msg = "Zzz... ";
    }

    // Cek Level Up
    if(myPetData.xp > 100 * myPetData.level) {
        myPetData.level++;
        myPetData.xp = 0;
        alert(`Selamat! Peliharaanmu naik ke Level ${myPetData.level}! `);
        // Pastikan fungsi logUserActivity ada sebelum dipanggil
        if(typeof logUserActivity === 'function') {
            logUserActivity(`Pet naik level ke ${myPetData.level}`);
        }
    }

    // Tampilkan Bubble Pesan
    const bubble = document.getElementById('petBubble');
    if(bubble) {
        bubble.innerText = msg;
        bubble.classList.remove('hidden');
        setTimeout(() => bubble.classList.add('hidden'), 2000);
    }

    // Simpan & Update UI
    await savePetData();
    updatePetUI();
};

async function savePetData() {
    myPetData.lastUpdate = new Date().toISOString();
    try {
        await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'pet', 'main'), myPetData);
    } catch(e) { console.error("Save pet err", e); }
}

// FUNGSI UTAMA: Tambah Koin (Panggil ini saat user melakukan hal positif di aplikasi)
async function rewardPetCoins(amount) {
    // Pastikan data pet sudah terload
    if(!myPetData) return; 
    
    myPetData.coins += amount;
    await savePetData();
    updatePetUI();
    alert(`Kamu mendapatkan +${amount} Koin untuk peliharaanmu! `);
}

// --- FUNGSI GANTI BACKGROUND PET ---
// Letakkan di paling bawah script

window.changePetBg = (bgUrl) => {
    const container = document.getElementById('petContainer');
    if(container) {
        // Ubah gambar CSS
        container.style.backgroundImage = `url('${bgUrl}')`;
        // Simpan pilihan user ke memori browser
        localStorage.setItem('myPetBg', bgUrl);
    }
};

// Cek memori saat loading: Apakah user pernah ganti background?
// Jika ya, pasang background terakhir yang dipilih.
document.addEventListener("DOMContentLoaded", () => {
    const savedBg = localStorage.getItem('myPetBg');
    if(savedBg) {
        // Tunggu sebentar agar elemen HTML siap
        setTimeout(() => window.changePetBg(savedBg), 500);
    }
});


// --- SISTEM POLLING / SURVEI (Include at bottom) ---

// 1. GURU: LOAD DATA POLLING
window.loadTeacherPolls = async () => {
    const container = document.getElementById('teacherPollList');
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'polls'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        
        if(snap.empty) {
            container.innerHTML = '<div class="text-center text-muted py-5 small fst-italic">Belum ada polling yang dibuat.</div>';
            return;
        }

        let html = '';
        snap.forEach(d => {
            const p = d.data();
            const created = new Date(p.createdAt).toLocaleDateString();
            const expired = new Date(p.expiresAt);
            const isActive = new Date() < expired;
            const statusBadge = isActive 
                ? '<span class="badge bg-success">Aktif</span>' 
                : '<span class="badge bg-secondary">Selesai</span>';

            html += `
            <div class="list-group-item p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="fw-bold mb-1">${p.title}</h6>
                        <small class="text-muted"><i class="far fa-clock me-1"></i>Dibuat: ${created}  Berakhir: ${expired.toLocaleDateString()}</small>
                        <div class="mt-1">${statusBadge} <span class="badge bg-light text-dark border ms-1">${p.participantCount || 0} Responden</span></div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="viewPollResults('${d.id}')">
                        <i class="fas fa-chart-pie me-1"></i> Hasil
                    </button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    } catch(e) { console.error(e); }
};

// 2. GURU: BUAT POLLING
window.createPoll = async (e) => {
    e.preventDefault();
    if(!confirm("Terbitkan polling ini sekarang?")) return;

    const title = document.getElementById('pollTitle').value;
    const duration = parseInt(document.getElementById('pollDuration').value) || 2;
    
    // Siapkan 5 Pertanyaan Default
    const questions = [
        { id: 'q1', text: document.getElementById('q1_text').value, options: ['Sangat Setuju', 'Setuju', 'Tidak Setuju'] },
        { id: 'q2', text: document.getElementById('q2_text').value, options: ['Sangat Senang', 'Senang', 'Kurang Senang'] },
        { id: 'q3', text: document.getElementById('q3_text').value, options: ['Ya Sangat', 'Lumayan', 'Biasa Saja'] },
        { id: 'q4', text: document.getElementById('q4_text').value, options: ['Sangat Membantu', 'Membantu', 'Kurang'] },
        { id: 'q5', text: document.getElementById('q5_text').value, options: ['Bagus Sekali', 'Cukup', 'Perlu Perbaikan'] }
    ];

    // Hitung tanggal kedaluwarsa
    const now = new Date();
    const expiresAt = new Date(now);
    expiresAt.setDate(now.getDate() + duration);

    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'polls'), {
            title: title,
            questions: questions,
            createdAt: now.toISOString(),
            expiresAt: expiresAt.toISOString(),
            createdBy: currentUser.uid,
            participantCount: 0
        });
        alert("Polling berhasil diterbitkan!");
        loadTeacherPolls();
    } catch(e) { alert("Error: " + e.message); }
};

// 3. GURU: LIHAT HASIL (Statistik)
window.viewPollResults = async (pollId) => {
    const modal = new bootstrap.Modal(document.getElementById('pollResultModal'));
    const content = document.getElementById('pollResultContent');
    content.innerHTML = '<div class="text-center py-5">Menghitung suara...</div>';
    modal.show();

    try {
        // Ambil data Polling
        const pollSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'polls', pollId));
        const pollData = pollSnap.data();

        // Ambil semua Jawaban
        const ansSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'polls', pollId, 'responses'));
        
        let stats = {};
        // Init stats
        pollData.questions.forEach(q => {
            stats[q.id] = {};
            q.options.forEach(opt => stats[q.id][opt] = 0);
        });

        // Hitung
        let totalRespondents = 0;
        ansSnap.forEach(d => {
            const ans = d.data().answers;
            totalRespondents++;
            for (const [qid, val] of Object.entries(ans)) {
                if(stats[qid] && stats[qid][val] !== undefined) {
                    stats[qid][val]++;
                }
            }
        });

        // Render Grafik Sederhana (Progress Bar)
        let html = `<h5 class="mb-3 text-center border-bottom pb-3">${pollData.title} <span class="badge bg-primary ms-2">${totalRespondents} Responden</span></h5>`;
        
        pollData.questions.forEach((q, idx) => {
            html += `<div class="card bg-light border-0 mb-3 p-3"><h6 class="fw-bold mb-3">${idx+1}. ${q.text}</h6>`;
            
            q.options.forEach(opt => {
                const count = stats[q.id][opt] || 0;
                const percent = totalRespondents === 0 ? 0 : Math.round((count / totalRespondents) * 100);
                
                // Warna bar beda-beda
                let barColor = 'bg-secondary';
                if(opt.includes('Sangat') || opt.includes('Bagus') || opt.includes('Ya')) barColor = 'bg-success';
                if(opt.includes('Kurang') || opt.includes('Tidak') || opt.includes('Perlu')) barColor = 'bg-danger';
                if(opt === 'Setuju' || opt === 'Senang' || opt === 'Lumayan' || opt === 'Cukup') barColor = 'bg-primary';

                html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>${opt}</span>
                        <span class="fw-bold">${count} (${percent}%)</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar ${barColor}" style="width: ${percent}%"></div>
                    </div>
                </div>`;
            });
            html += `</div>`;
        });
        
        content.innerHTML = html;

    } catch(e) { console.error(e); content.innerHTML = "Gagal memuat hasil."; }
};

// 4. SISWA: LOAD POLLING AKTIF
window.loadStudentPolls = async () => {
    // Fungsi ini dipanggil saat switchTab('tabStudentPolling')
    const container = document.getElementById('studentPollContainer');
    
    try {
        const now = new Date().toISOString();
        // Ambil polling yang belum expired
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'polls'), where('expiresAt', '>', now));
        const snap = await getDocs(q);

        if(snap.empty) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="100" class="mb-3 opacity-50">
                    <h6 class="text-muted">Tidak ada polling aktif saat ini.</h6>
                </div>`;
            return;
        }

        let html = '';
        // Loop polling, Cek apakah siswa sudah menjawab
        for (const d of snap.docs) {
            const p = d.data();
            
            // Cek subcollection responses (apakah uid saya ada?)
            // Note: Firestore tidak bisa query subcollection exists dengan mudah tanpa read. 
            // Kita coba fetch doc ID saya di subcollection responses
            const myAnsRef = doc(db, 'artifacts', appId, 'public', 'data', 'polls', d.id, 'responses', currentUser.uid);
            const myAnsSnap = await getDoc(myAnsRef);

            if (myAnsSnap.exists()) {
                html += `
                <div class="card mb-3 border-success border bg-success bg-opacity-10">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-check-circle text-success fa-2x me-3"></i>
                        <div>
                            <h6 class="fw-bold mb-1">${p.title}</h6>
                            <small class="text-success fw-bold">Sudah diisi. Terima kasih!</small>
                        </div>
                    </div>
                </div>`;
            } else {
                // Render Form Polling
                let qHtml = '';
                p.questions.forEach((q, idx) => {
                    let opts = '';
                    q.options.forEach(opt => {
                        opts += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="poll_${d.id}_${q.id}" value="${opt}" id="${d.id}_${q.id}_${opt}">
                            <label class="form-check-label" for="${d.id}_${q.id}_${opt}">${opt}</label>
                        </div>`;
                    });
                    
                    qHtml += `
                    <div class="mb-4">
                        <h6 class="fw-bold small text-primary mb-2">${idx+1}. ${q.text}</h6>
                        <div class="ms-2">${opts}</div>
                    </div>`;
                });

                html += `
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold">${p.title}</div>
                    <div class="card-body">
                        <form onsubmit="submitPoll(event, '${d.id}')">
                            ${qHtml}
                            <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold">Kirim Jawaban</button>
                        </form>
                    </div>
                    <div class="card-footer bg-light small text-muted">
                        Batas Waktu: ${new Date(p.expiresAt).toLocaleDateString()}
                    </div>
                </div>`;
            }
        }
        
        container.innerHTML = html;

    } catch(e) { 
        console.error(e); 
        container.innerHTML = '<div class="text-danger text-center">Gagal memuat polling.</div>';
    }
};

// 5. SISWA: KIRIM JAWABAN
window.submitPoll = async (e, pollId) => {
    e.preventDefault();
    
    try {
        const pollRef = doc(db, 'artifacts', appId, 'public', 'data', 'polls', pollId);
        const pollSnap = await getDoc(pollRef);
        const questions = pollSnap.data().questions;
        
        let answers = {};
        let allFilled = true;

        // Collect Answers
        questions.forEach(q => {
            const selected = document.querySelector(`input[name="poll_${pollId}_${q.id}"]:checked`);
            if(!selected) allFilled = false;
            else answers[q.id] = selected.value;
        });

        if(!allFilled) return alert("Mohon jawab semua pertanyaan!");

        // Simpan ke Subcollection
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'polls', pollId, 'responses', currentUser.uid), {
            studentUid: currentUser.uid,
            studentName: userData.name,
            class: userData.class,
            answers: answers,
            timestamp: new Date().toISOString()
        });

        // Update Counter di Doc Utama (Atomic Increment is better, but simple update for now)
        const currentCount = pollSnap.data().participantCount || 0;
        await updateDoc(pollRef, { participantCount: currentCount + 1 });
        
        logUserActivity(`Mengisi Polling: ${pollSnap.data().title}`);
        
        // Reward Coin untuk Pet (Jika fitur Pet aktif)
        if(typeof rewardPetCoins === 'function') rewardPetCoins(20);

        alert("Terima kasih! Jawabanmu telah tersimpan. (+20 Koin Pet)");
        loadStudentPolls(); // Refresh UI

    } catch(e) { alert("Gagal kirim: " + e.message); }
};

// Hook ke switchTab agar load data saat tab dibuka
const originalSwitchTab = window.switchTab;
window.switchTab = (tabId, navEl) => {
    originalSwitchTab(tabId, navEl); // Jalan fungsi lama
    if(tabId === 'tabStudentPolling') loadStudentPolls(); // Fungsi baru
};

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
